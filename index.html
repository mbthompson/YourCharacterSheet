<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Character Sheet</title>
<style>
  :root {
    --warm-brown: #8B6F47;
    --warm-brown-light: #A68B5B;
    --warm-brown-pale: #F5F0EA;
    --deep-slate: #4A5568;
    --charcoal: #2D2D2D;
    --medium-gray: #666666;
    --light-gray: #999999;
    --very-light-gray: #F7F7F5;
    --border-gray: #E2E0DC;
    --white: #FFFFFF;
    --font-serif: Georgia, 'Times New Roman', serif;
    --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
    --color-critical: #DC2626;
    --color-struggling: #EA580C;
    --color-below: #D97706;
    --color-average: #9CA3AF;
    --color-above: #65A30D;
    --color-strong: #16A34A;
    --color-excellent: #059669;
    --color-exceptional: #047857;
    /* Per-attribute accent colours — muted, distinct hues. */
    --attr-body:            #7B6B8D;
    --attr-mind:            #4A7C8C;
    --attr-spirit:          #8C6B4A;
    --attr-heart:           #8C4A5A;
    --attr-standing:        #6B7A4A;
    --attr-resilience:      #4A6B7A;
    --attr-discipline:      #5A5A6B;
    --attr-joy:             #8C7A4A;
    /* Pale tints of each attribute colour — used for reflect box backgrounds */
    --attr-body-pale:       #EDEAF3;
    --attr-mind-pale:       #E4EFF2;
    --attr-spirit-pale:     #F2EDE4;
    --attr-heart-pale:      #F2E4E9;
    --attr-standing-pale:   #EBEFE0;
    --attr-resilience-pale: #E0EBF0;
    --attr-discipline-pale: #E9E9EE;
    --attr-joy-pale:        #F2EDE0;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: var(--font-serif);
    color: var(--charcoal);
    background: var(--very-light-gray);
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
  }

  /* Containers */
  .container {
    max-width: 700px;
    margin: 0 auto;
    padding: 0 20px;
  }

  .container-wide {
    max-width: 900px;
    margin: 0 auto;
    padding: 0 20px;
  }

  /* Sheet view gets extra width for the sidebar layout */
  #sheet-view .container { max-width: 1120px; }

  /* Views */
  #tutorial-view, #edit-view, #sheet-view, #calculating-view { display: none; }
  #tutorial-view.active, #edit-view.active, #sheet-view.active { display: block; }

  /* ==================== TUTORIAL VIEW ==================== */
  #tutorial-view {
    width: 100%;
    min-height: 100vh;
    background: var(--very-light-gray);
  }

  .tutorial-page {
    width: 100%;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 60px 40px;
    text-align: center;
    background: var(--very-light-gray);
  }

  .tutorial-page-content {
    max-width: 640px;
    width: 100%;
  }

  .tutorial-page h1 {
    font-size: 48px;
    color: var(--charcoal);
    margin-bottom: 12px;
    font-weight: 700;
    letter-spacing: -0.5px;
  }

  .tutorial-page h2 {
    font-size: 36px;
    color: var(--charcoal);
    margin-bottom: 28px;
    font-weight: 700;
  }

  .tutorial-page p {
    font-size: 17px;
    color: var(--medium-gray);
    line-height: 1.8;
    margin-bottom: 18px;
  }

  .tutorial-page p.lead {
    font-size: 19px;
    color: var(--deep-slate);
    line-height: 1.7;
  }

  .tutorial-page ul {
    list-style: none;
    margin: 20px 0;
    text-align: left;
  }

  .tutorial-page li {
    font-size: 15px;
    color: var(--medium-gray);
    line-height: 1.7;
    margin-bottom: 14px;
  }

  .tutorial-subtitle {
    font-size: 19px;
    color: var(--warm-brown);
    font-style: italic;
    margin-bottom: 32px;
  }

  .tutorial-actions {
    display: flex;
    gap: 12px;
    justify-content: center;
    margin-top: 40px;
    flex-wrap: wrap;
  }

  .tutorial-skip-link {
    position: fixed;
    top: 20px;
    right: 20px;
    font-size: 13px;
    color: var(--light-gray);
    text-decoration: none;
    cursor: pointer;
    z-index: 999;
    font-family: var(--font-sans);
    transition: color 0.2s;
  }

  .tutorial-skip-link:hover {
    color: var(--warm-brown);
    text-decoration: underline;
  }

  /* Attribute preview cards in tutorial */
  .attr-preview-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin: 32px 0;
    text-align: left;
  }

  .attr-preview-card {
    background: var(--white);
    border: 1px solid var(--border-gray);
    border-radius: 8px;
    padding: 18px;
  }

  .attr-preview-name {
    font-family: var(--font-sans);
    font-weight: 700;
    font-size: 15px;
    color: var(--charcoal);
    margin-bottom: 4px;
  }

  .attr-preview-tagline {
    font-size: 13px;
    color: var(--warm-brown);
    font-style: italic;
    line-height: 1.5;
  }

  /* Score table in tutorial */
  .score-table {
    width: 100%;
    border-collapse: collapse;
    margin: 28px 0;
    text-align: left;
    font-size: 14px;
  }

  .score-table th {
    background: var(--warm-brown-pale);
    padding: 10px 14px;
    border: 1px solid var(--border-gray);
    font-weight: 600;
    color: var(--charcoal);
    text-align: left;
  }

  .score-table td {
    padding: 10px 14px;
    border: 1px solid var(--border-gray);
    color: var(--medium-gray);
  }

  .score-table tr:nth-child(even) {
    background: var(--white);
  }

  .score-table .score-color {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-right: 6px;
    vertical-align: middle;
  }

  /* Tutorial form inputs */
  .tutorial-form {
    margin: 40px 0;
    text-align: left;
  }

  .tutorial-form label {
    display: block;
    font-family: var(--font-sans);
    font-size: 12px;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: var(--light-gray);
    margin-bottom: 6px;
  }

  .tutorial-form input,
  .tutorial-form select {
    font-family: var(--font-serif);
    font-size: 16px;
    border: 1px solid var(--border-gray);
    padding: 12px;
    border-radius: 4px;
    width: 100%;
    color: var(--charcoal);
    margin-bottom: 16px;
  }

  .tutorial-form input:focus,
  .tutorial-form select:focus {
    outline: none;
    border-color: var(--warm-brown);
  }

  /* ==================== CALCULATING VIEW ==================== */
  #calculating-view.active {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--very-light-gray);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
  }

  .calc-content {
    max-width: 500px;
  }

  .calc-step {
    font-family: var(--font-sans);
    font-size: 16px;
    color: var(--light-gray);
    margin-bottom: 8px;
    opacity: 0;
    transform: translateY(10px);
    transition: opacity 0.5s, transform 0.5s;
  }

  .calc-step.visible {
    opacity: 1;
    transform: translateY(0);
  }

  .calc-step.done {
    color: var(--warm-brown);
  }

  .calc-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--border-gray);
    border-top: 3px solid var(--warm-brown);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 32px auto;
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  /* Pre-reveal transition panel */
  .calc-prereveal {
    display: none;
    max-width: 520px;
    padding: 0 24px;
    text-align: center;
    animation: fadeIn 0.8s ease-out;
  }

  .calc-prereveal-heading {
    font-family: var(--font-serif);
    font-size: 28px;
    color: var(--charcoal);
    margin-bottom: 28px;
    letter-spacing: -0.3px;
  }

  .calc-prereveal-body {
    font-family: var(--font-serif);
    font-size: 16px;
    color: var(--medium-gray);
    line-height: 1.9;
    margin-bottom: 16px;
  }

  .calc-prereveal-body + .calc-prereveal-body {
    margin-top: 0;
  }

  .calc-prereveal-cta {
    margin-top: 40px;
  }

  /* ==================== BUTTONS ==================== */
  .btn {
    font-family: var(--font-sans);
    font-size: 14px;
    font-weight: 500;
    padding: 12px 32px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-primary {
    background: var(--warm-brown);
    color: var(--white);
  }

  .btn-primary:hover {
    background: var(--warm-brown-light);
  }

  .btn-secondary {
    background: transparent;
    color: var(--warm-brown);
    border: 1.5px solid var(--warm-brown);
  }

  .btn-secondary:hover {
    background: var(--warm-brown-pale);
  }

  .btn-small {
    padding: 8px 20px;
    font-size: 12px;
  }

  .btn-ghost {
    background: transparent;
    color: var(--light-gray);
    border: 1px solid var(--border-gray);
  }

  .btn-ghost:hover {
    color: var(--warm-brown);
    border-color: var(--warm-brown);
  }

  /* ==================== EDIT VIEW ==================== */
  #edit-view {
    padding: 40px 0;
    min-height: 100vh;
  }

  .edit-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 40px;
    padding-bottom: 24px;
    border-bottom: 1px solid var(--border-gray);
    position: sticky;
    top: 0;
    background: var(--very-light-gray);
    z-index: 100;
    padding-top: 10px;
  }

  .edit-header h1 {
    font-size: 24px;
    color: var(--charcoal);
  }

  .edit-header .button-group {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  /* Profile Section */
  /* Profile section (now inside the guided flow) */
  .profile-section-body {
    display: flex;
    flex-direction: column;
    gap: 28px;
  }

  .profile-photo-wrap {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }

  .profile-photo-hint {
    font-family: var(--font-sans);
    font-size: 12px;
    color: var(--light-gray);
  }

  .profile-fields-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }

  .profile-field {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .profile-field.profile-field-wide {
    grid-column: 1 / -1;
  }

  .profile-field label {
    font-family: var(--font-sans);
    font-size: 12px;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: var(--light-gray);
  }

  .field-optional {
    text-transform: none;
    letter-spacing: 0;
    font-size: 11px;
    color: var(--light-gray);
    opacity: 0.7;
  }

  .profile-field input,
  .profile-field select {
    font-family: var(--font-serif);
    font-size: 16px;
    border: 1px solid var(--border-gray);
    padding: 10px 12px;
    border-radius: 4px;
    color: var(--charcoal);
    outline: none;
    transition: border-color 0.2s;
    background: var(--white);
  }

  .profile-field input:focus,
  .profile-field select:focus {
    border-color: var(--warm-brown);
  }

  .profile-photo {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    background: var(--very-light-gray);
    border: 2px solid var(--border-gray);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    position: relative;
    overflow: hidden;
  }

  .profile-photo img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
  }

  .profile-photo-placeholder {
    font-size: 40px;
    color: var(--light-gray);
  }

  .profile-photo:hover {
    border-color: var(--warm-brown);
    background: var(--warm-brown-pale);
  }

  #photo-input, #import-input { display: none; }

  /* (profile-inputs CSS removed — profile is now a guided-flow section) */

  /* Navigation */
  .section-nav {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 40px;
    padding: 12px 0;
    border-bottom: 1px solid var(--border-gray);
    position: sticky;
    top: 80px;
    background: var(--very-light-gray);
    z-index: 99;
  }

  .section-nav button {
    font-family: var(--font-sans);
    font-size: 13px;
    padding: 8px 16px;
    border: 1px solid var(--border-gray);
    background: var(--white);
    color: var(--medium-gray);
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .section-nav button:hover {
    border-color: var(--warm-brown);
    color: var(--warm-brown);
  }

  .section-nav button.active {
    background: var(--btn-accent, var(--warm-brown));
    color: var(--white);
    border-color: var(--btn-accent, var(--warm-brown));
  }

  .section-nav button.active .nav-attr-dot {
    background: rgba(255,255,255,0.7) !important;
  }

  .nav-attr-dot {
    display: inline-block;
    width: 7px;
    height: 7px;
    border-radius: 50%;
    margin-right: 5px;
    vertical-align: middle;
    margin-top: -1px;
    flex-shrink: 0;
  }

  /* Attribute Sections */
  .attribute-section {
    background: var(--white);
    border: 1px solid var(--border-gray);
    border-radius: 8px;
    padding: 40px;
    margin-bottom: 40px;
    display: none;
  }

  .attribute-section.active {
    display: block;
    border-left: 4px solid var(--section-accent, var(--warm-brown));
  }

  .attribute-section .section-label {
    font-family: var(--font-sans);
    font-size: 11px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--light-gray);
    margin-bottom: 8px;
  }

  /* .attribute-section h2 and .tagline are now styled inside .attribute-section-header */

  .attribute-description {
    color: var(--medium-gray);
    font-size: 15px;
    line-height: 1.7;
    margin-bottom: 28px;
  }

  .reflection-prompt {
    background: var(--warm-brown-pale);
    border-left: 4px solid var(--warm-brown);
    padding: 16px 20px;
    margin-bottom: 28px;
    border-radius: 0 4px 4px 0;
  }

  .reflection-prompt .prompt-label {
    font-family: var(--font-sans);
    font-size: 11px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--warm-brown);
    margin-bottom: 6px;
  }

  .reflection-prompt p {
    font-style: italic;
    color: var(--medium-gray);
    font-size: 15px;
  }

  /* Main Score */
  .main-score-area {
    background: var(--very-light-gray);
    border-radius: 6px;
    padding: 28px;
    margin-bottom: 32px;
    text-align: center;
  }

  .score-label {
    font-family: var(--font-sans);
    font-size: 11px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--light-gray);
    margin-bottom: 12px;
  }

  .score-display {
    font-size: 56px;
    font-weight: 700;
    color: var(--warm-brown);
    margin-bottom: 4px;
    font-family: var(--font-sans);
  }

  .score-meaning {
    font-family: var(--font-sans);
    font-size: 13px;
    font-weight: 500;
    margin-bottom: 16px;
  }

  .override-area {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    margin-top: 12px;
  }

  .override-toggle {
    font-family: var(--font-sans);
    font-size: 12px;
    padding: 4px 10px;
    background: transparent;
    border: 1px solid var(--border-gray);
    border-radius: 4px;
    cursor: pointer;
    color: var(--medium-gray);
    transition: all 0.2s;
  }

  .override-toggle.active {
    background: var(--warm-brown);
    color: var(--white);
    border-color: var(--warm-brown);
  }

  .main-score-input {
    width: 60px;
    text-align: center;
    font-family: var(--font-sans);
    font-size: 18px;
    font-weight: 700;
    color: var(--warm-brown);
    border: 1px solid var(--border-gray);
    padding: 6px;
    border-radius: 4px;
    outline: none;
  }

  .main-score-input:focus {
    border-color: var(--warm-brown);
  }

  .indicator {
    font-family: var(--font-sans);
    font-size: 11px;
    color: var(--light-gray);
    font-style: italic;
  }

  /* Range sliders */
  input[type="range"] {
    -webkit-appearance: none;
    width: 100%;
    max-width: 400px;
    height: 4px;
    background: var(--border-gray);
    border-radius: 2px;
    outline: none;
    cursor: pointer;
  }

  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 20px;
    height: 20px;
    background: var(--warm-brown);
    border-radius: 50%;
    cursor: pointer;
    transition: transform 0.15s;
  }

  input[type="range"]::-webkit-slider-thumb:hover {
    transform: scale(1.15);
  }

  input[type="range"]::-moz-range-thumb {
    width: 20px;
    height: 20px;
    background: var(--warm-brown);
    border-radius: 50%;
    cursor: pointer;
    border: none;
  }

  /* Sub-scores */
  .sub-scores {
    margin-top: 28px;
    padding-top: 28px;
    border-top: 1px solid var(--border-gray);
  }

  .sub-score-item {
    padding: 18px 0;
    border-bottom: 1px solid var(--border-gray);
  }

  .sub-score-item:last-child { border-bottom: none; }

  .sub-score-name {
    font-family: var(--font-sans);
    font-size: 14px;
    font-weight: 600;
    color: var(--deep-slate);
    margin-bottom: 4px;
  }

  .sub-score-desc {
    font-size: 13px;
    color: var(--light-gray);
    margin-bottom: 10px;
    line-height: 1.5;
  }

  .sub-score-row {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .sub-score-row input[type="range"] {
    max-width: 250px;
    flex: 1;
  }

  .sub-score-value {
    font-family: var(--font-sans);
    font-size: 16px;
    font-weight: 700;
    color: var(--warm-brown);
    min-width: 32px;
    text-align: center;
  }

  .sub-score-label {
    font-family: var(--font-sans);
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    margin-top: 4px;
    min-height: 16px;
  }

  /* Abilities Section — Edit View */
  .abilities-intro {
    color: var(--medium-gray);
    font-size: 15px;
    line-height: 1.7;
    margin-bottom: 8px;
  }

  .abilities-examples {
    font-size: 13px;
    color: var(--light-gray);
    font-style: italic;
    margin-bottom: 20px;
    line-height: 1.6;
  }

  .ability-card {
    background: var(--white);
    border: 1px solid var(--border-gray);
    border-radius: 6px;
    padding: 16px 18px;
    margin-bottom: 12px;
  }

  .ability-card-top {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-bottom: 14px;
  }

  .ability-card-top input[type="text"] {
    flex: 1;
    font-family: var(--font-serif);
    font-size: 15px;
    font-style: italic;
    border: none;
    border-bottom: 1px solid var(--border-gray);
    padding: 4px 2px;
    color: var(--charcoal);
    outline: none;
    background: transparent;
  }

  .ability-card-top input[type="text"]:focus {
    border-bottom-color: var(--warm-brown);
  }

  .ability-controls {
    display: flex;
    gap: 6px;
    align-items: center;
    flex-shrink: 0;
  }

  .status-toggle {
    font-family: var(--font-sans);
    font-size: 11px;
    padding: 4px 10px;
    border-radius: 3px;
    border: 1px solid transparent;
    cursor: pointer;
    white-space: nowrap;
  }

  .status-toggle.active { background: #E6F4EA; color: #1B7A3D; border-color: #C3E6CB; }
  .status-toggle.dormant { background: #F0F0F0; color: var(--light-gray); }

  .ability-score-area { margin-bottom: 12px; }

  .ability-score-area input[type="range"] {
    width: 100%;
    height: 5px;
    margin-bottom: 8px;
  }

  .ability-score-row {
    display: flex;
    align-items: baseline;
    gap: 8px;
  }

  .ability-score-value {
    font-size: 26px;
    font-weight: 700;
    font-family: var(--font-sans);
    line-height: 1;
    min-width: 36px;
  }

  .ability-score-label {
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
  }

  .ability-card-bottom { margin-top: 4px; }

  .ability-card-bottom select {
    font-family: var(--font-sans);
    font-size: 13px;
    border: 1px solid var(--border-gray);
    padding: 6px 8px;
    border-radius: 4px;
    color: var(--medium-gray);
    background: var(--white);
    outline: none;
    cursor: pointer;
  }

  .ability-card-bottom select:focus { border-color: var(--warm-brown); }

  .ability-remove {
    font-size: 20px;
    color: var(--light-gray);
    cursor: pointer;
    border: none;
    background: none;
    padding: 2px 6px;
    border-radius: 3px;
    line-height: 1;
  }

  .ability-remove:hover { color: #c53030; }

  .section-nav-buttons {
    display: flex;
    gap: 12px;
    justify-content: space-between;
    margin-top: 32px;
    padding-top: 28px;
    border-top: 1px solid var(--border-gray);
  }

  /* ==================== GUIDED SUB-STEP LAYOUT ==================== */

  .attribute-section-header {
    display: flex;
    align-items: baseline;
    gap: 12px;
    margin-bottom: 28px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border-gray);
  }

  .attribute-section-header h2 {
    font-size: 17px;
    font-weight: 700;
    color: var(--section-accent, var(--warm-brown));
    margin: 0;
    flex-shrink: 0;
  }

  .attribute-section-header .tagline {
    font-style: italic;
    color: var(--medium-gray);
    font-size: 13px;
    margin: 0;
    flex: 1;
  }

  .step-counter {
    font-family: var(--font-sans);
    font-size: 12px;
    color: var(--light-gray);
    margin-left: auto;
    flex-shrink: 0;
  }

  .attribute-step-content.stepping,
  .bfi-step-content.stepping {
    animation: stepFadeIn 0.25s ease-out;
  }

  @keyframes stepFadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .step-progress {
    font-family: var(--font-sans);
    font-size: 11px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--light-gray);
    margin-bottom: 20px;
  }

  .sub-step-question-name {
    font-family: var(--font-sans);
    font-size: 26px;
    font-weight: 700;
    color: var(--deep-slate);
    margin-bottom: 12px;
  }

  .sub-step-body .sub-score-desc {
    font-size: 15px;
    color: var(--medium-gray);
    line-height: 1.7;
    margin-bottom: 32px;
  }

  .sub-step-slider-area {
    margin-bottom: 36px;
  }

  .sub-step-slider-area input[type="range"] {
    width: 100%;
    max-width: 100%;
    height: 6px;
    margin-bottom: 16px;
  }

  .sub-step-value-row {
    display: flex;
    align-items: baseline;
    gap: 12px;
  }

  .sub-step-value-row .sub-score-value {
    font-size: 40px;
    font-weight: 700;
    font-family: var(--font-sans);
    min-width: 52px;
  }

  .sub-step-value-row .sub-score-label {
    font-size: 16px;
    font-weight: 600;
    letter-spacing: 0.03em;
    text-transform: uppercase;
  }

  .sub-step-nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
    padding-top: 28px;
    border-top: 1px solid var(--border-gray);
    margin-top: 8px;
  }

  /* BFI one-by-one buttons */
  .bfi-buttons {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin: 24px 0 32px;
  }

  .bfi-btn {
    font-family: var(--font-sans);
    font-size: 14px;
    padding: 14px 20px;
    border: 1.5px solid var(--border-gray);
    background: var(--white);
    color: var(--medium-gray);
    border-radius: 6px;
    cursor: pointer;
    text-align: left;
    transition: all 0.15s;
  }

  .bfi-btn:hover {
    border-color: var(--warm-brown);
    color: var(--warm-brown);
  }

  .bfi-btn.selected {
    background: var(--warm-brown);
    color: var(--white);
    border-color: var(--warm-brown);
  }

  .bfi-question {
    font-style: italic;
    font-weight: 600;
    color: var(--deep-slate);
  }

  /* Scale anchors for sub-scale descriptions */
  .scale-anchors {
    font-size: 12px;
    color: var(--light-gray);
    line-height: 1.7;
    display: block;
    margin-top: 12px;
    font-family: var(--font-sans);
  }

  .scale-anchors em {
    font-style: normal;
    font-weight: 600;
    color: var(--medium-gray);
  }

  /* ==================== SHEET VIEW ==================== */
  #sheet-view {
    padding: 60px 0;
    animation: fadeIn 0.6s ease-out;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .sheet-container {
    background: var(--white);
    border-radius: 8px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
  }

  .sheet-parchment {
    display: flex;
    align-items: stretch;
    background: linear-gradient(to bottom, #FAFAF8, #F5F0EA);
    border-radius: 8px;
    overflow: hidden;
  }

  /* ── Sidebar ───────────────────────────────── */
  .sheet-sidebar {
    width: 264px;
    flex-shrink: 0;
    padding: 40px 28px 48px 36px;
    border-right: 1px solid var(--border-gray);
    background: var(--white);
  }


  /* ── Main content ──────────────────────────── */
  .sheet-main {
    flex: 1;
    padding: 40px 48px 48px 40px;
    min-width: 0;
  }

  .sheet-header {
    text-align: center;
    margin-bottom: 28px;
  }

  .sheet-profile {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 20px;
  }

  .sheet-photo {
    width: 88px;
    height: 88px;
    border-radius: 50%;
    background: var(--warm-brown-pale);
    border: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.12);
    margin-bottom: 14px;
    overflow: hidden;
  }

  .sheet-photo img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .sheet-photo-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px;
    font-weight: 700;
    font-family: var(--font-serif);
    color: var(--white);
    background: var(--warm-brown);
    border-radius: 50%;
    letter-spacing: 0.02em;
  }

  .sheet-header h1 {
    font-size: 26px;
    color: var(--charcoal);
    margin-bottom: 4px;
    letter-spacing: -0.3px;
  }

  .sheet-occupation {
    font-family: var(--font-sans);
    font-size: 14px;
    color: var(--warm-brown);
    letter-spacing: 0.04em;
    margin-bottom: 10px;
    font-weight: 500;
  }

  .sheet-meta {
    font-family: var(--font-sans);
    font-size: 12px;
    color: var(--light-gray);
    letter-spacing: 0.02em;
  }

  .sheet-meta span { margin: 0 6px; }

  .sheet-meta-date {
    display: block;
    font-family: var(--font-sans);
    font-size: 11px;
    color: var(--border-gray);
    margin-top: 8px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }

  /* ==================== SCORE ITEMS (Sheet) ==================== */
  .scores-grid {
    display: grid;
    gap: 14px;
    margin-bottom: 36px;
  }

  .score-item-pair {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
  }

  .score-item {
    background: var(--white);
    border-radius: 6px;
    border-left: 4px solid var(--border-gray); /* overridden inline per attribute */
    cursor: pointer;
    transition: box-shadow 0.2s;
    overflow: hidden;
    box-shadow: 0 2px 6px rgba(0,0,0,0.07), 0 0 0 1px rgba(0,0,0,0.05);
  }

  .score-item:hover {
    box-shadow: 0 4px 14px rgba(0,0,0,0.11), 0 0 0 1px rgba(0,0,0,0.06);
  }

  .score-item-summary {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 16px 8px 16px;
    gap: 12px;
  }

  .score-item-left { flex: 1; min-width: 0; }

  .score-item-name {
    font-family: var(--font-serif);
    font-size: 15px;
    font-weight: 700;
    color: var(--charcoal);
    line-height: 1.2;
  }

  .score-item-tagline {
    font-family: var(--font-sans);
    font-size: 11px;
    color: var(--medium-gray);
    margin-top: 3px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .score-item-right {
    text-align: right;
    flex-shrink: 0;
  }

  .score-item-value {
    font-family: var(--font-serif);
    font-size: 30px;
    font-weight: 700;
    line-height: 1;
  }

  .score-item-label {
    font-family: var(--font-sans);
    font-size: 9px;
    font-weight: 700;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    margin-top: 3px;
  }

  /* Spectrum bar — full width, more prominent */
  /* Percentages derived from (score-1)/19*100 at each tier boundary */
  .spectrum-bar {
    position: relative;
    height: 7px;
    border-radius: 4px;
    margin: 8px 16px 0 16px;
    overflow: visible;
    background: linear-gradient(to right,
      var(--color-critical)    0%,     var(--color-critical)    15.8%,
      var(--color-struggling)  15.8%,  var(--color-struggling)  31.6%,
      var(--color-below)       31.6%,  var(--color-below)       42.1%,
      var(--color-average)     42.1%,  var(--color-average)     52.6%,
      var(--color-above)       52.6%,  var(--color-above)       63.2%,
      var(--color-strong)      63.2%,  var(--color-strong)      73.7%,
      var(--color-excellent)   73.7%,  var(--color-excellent)   84.2%,
      var(--color-exceptional) 84.2%,  var(--color-exceptional) 100%
    );
    opacity: 0.45;
  }

  .spectrum-marker {
    position: absolute;
    top: 50%;
    transform: translate(-50%, -50%);
    width: 14px;
    height: 14px;
    border-radius: 50%;
    border: 2.5px solid var(--white);
    box-shadow: 0 1px 5px rgba(0,0,0,0.4);
    transition: left 0.6s ease-out;
  }

  /* Expand hint + chevron — styled as a clear tap target */
  .score-item-chevron {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 7px 16px 8px;
    font-family: var(--font-sans);
    font-size: 9px;
    font-weight: 600;
    color: var(--medium-gray);
    letter-spacing: 0.08em;
    text-transform: uppercase;
    border-top: 1px solid var(--border-gray);
    background: rgba(0,0,0,0.015);
    transition: color 0.2s, background 0.2s;
    cursor: pointer;
  }

  .score-item-chevron .chevron-arrow {
    font-size: 10px;
    transition: transform 0.3s;
    display: inline-block;
  }

  .score-item:hover .score-item-chevron { color: var(--charcoal); background: rgba(0,0,0,0.03); }

  .score-item.expanded .score-item-chevron {
    color: var(--warm-brown);
    background: rgba(139,111,71,0.06);
  }

  .score-item.expanded .score-item-chevron .chevron-arrow {
    transform: rotate(180deg);
  }

  /* Expanded detail */
  .score-item-detail {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s ease-out;
    background: var(--very-light-gray);
    border-top: 1px solid transparent;
  }

  .score-item.expanded .score-item-detail {
    max-height: 1200px;
    border-top-color: var(--border-gray);
  }

  .score-item-detail-inner {
    padding: 20px 22px 22px;
  }

  .score-item-detail-desc {
    font-size: 14px;
    color: var(--medium-gray);
    line-height: 1.7;
    margin-bottom: 16px;
  }

  .score-item-detail-prompt {
    background: var(--warm-brown-pale);
    border-left: 3px solid var(--warm-brown);
    padding: 12px 16px;
    margin-bottom: 20px;
    border-radius: 0 4px 4px 0;
    font-style: italic;
    font-size: 14px;
    color: var(--medium-gray);
  }

  .sub-score-bar-item {
    display: grid;
    grid-template-columns: 110px 40px 1fr;
    gap: 10px;
    align-items: center;
    margin-bottom: 10px;
  }

  .sub-score-bar-name {
    font-family: var(--font-sans);
    font-size: 12px;
    color: var(--deep-slate);
    font-weight: 500;
    text-align: right;
  }

  .sub-score-bar-value {
    font-family: var(--font-sans);
    font-size: 13px;
    font-weight: 700;
    text-align: center;
  }

  .sub-bar-track {
    height: 5px;
    border-radius: 3px;
    background: var(--border-gray);
    overflow: hidden;
  }

  .sub-bar-fill {
    height: 100%;
    border-radius: 3px;
    transition: width 0.6s ease-out;
  }

  /* ==================== RADAR CHART (Sheet) ==================== */
  #radar-section {
    margin-bottom: 28px;
  }

  #radar-canvas {
    width: 100%;
    max-width: 560px;
    height: auto;
    display: block;
    margin: 0 auto;
  }

  /* ==================== SECTION RULE ==================== */
  .sheet-section-rule {
    display: flex;
    align-items: center;
    gap: 14px;
    margin-bottom: 24px;
  }

  .sheet-section-rule::before,
  .sheet-section-rule::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border-gray);
  }

  .sheet-section-rule-text {
    font-family: var(--font-sans);
    font-size: 10px;
    letter-spacing: 0.18em;
    text-transform: uppercase;
    color: var(--light-gray);
    white-space: nowrap;
  }

  /* ==================== BIG FIVE (Sheet) ==================== */
  .personality-section {
    margin-bottom: 48px;
  }

  .personality-section-subtitle {
    font-size: 13px;
    color: var(--medium-gray);
    text-align: center;
    margin-bottom: 20px;
    font-style: italic;
  }

  .big-five-item {
    background: var(--white);
    border-radius: 6px;
    border-left: 4px solid var(--border-gray);
    padding: 16px 20px 16px 17px;
    margin-bottom: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.07), 0 0 0 1px rgba(0,0,0,0.05);
  }

  .big-five-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 4px;
  }

  .big-five-name {
    font-family: var(--font-sans);
    font-size: 13px;
    font-weight: 700;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    color: var(--deep-slate);
  }

  .big-five-level {
    font-family: var(--font-sans);
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: var(--warm-brown);
  }

  .big-five-desc {
    font-size: 13px;
    color: var(--light-gray);
    margin-bottom: 12px;
    line-height: 1.5;
  }

  .big-five-bar-area {
    margin-bottom: 10px;
  }

  .big-five-bar-track {
    height: 5px;
    border-radius: 3px;
    background: var(--border-gray);
    position: relative;
    overflow: visible;
    margin-bottom: 8px;
  }

  .big-five-bar-marker {
    position: absolute;
    top: 50%;
    transform: translate(-50%, -50%);
    width: 13px;
    height: 13px;
    border-radius: 50%;
    background: var(--warm-brown);
    border: 2.5px solid var(--white);
    box-shadow: 0 1px 5px rgba(0,0,0,0.35);
  }

  .big-five-bar-labels {
    display: flex;
    justify-content: space-between;
    gap: 12px;
  }

  .big-five-bar-label-low,
  .big-five-bar-label-high {
    font-family: var(--font-sans);
    font-size: 11px;
    color: var(--medium-gray);
    font-style: italic;
    line-height: 1.4;
    max-width: 45%;
  }

  .big-five-bar-label-high {
    text-align: right;
  }

  .big-five-interpretation {
    font-family: var(--font-sans);
    font-size: 12px;
    color: var(--medium-gray);
    font-style: italic;
    line-height: 1.5;
    border-top: 1px solid var(--border-gray);
    padding-top: 10px;
    margin-top: 2px;
  }

  /* Abilities on Sheet */
  .sheet-abilities {
    margin-bottom: 48px;
  }

  .section-title {
    font-family: var(--font-sans);
    font-size: 12px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--light-gray);
    margin-bottom: 16px;
    text-align: center;
  }

  /* Abilities on Sheet */
  .abilities-list { display: grid; gap: 8px; }

  .ability-group-label {
    font-family: var(--font-sans);
    font-size: 10px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--light-gray);
    margin: 10px 0 4px;
  }

  .ability-group-label:first-child { margin-top: 0; }

  .ability-card-sheet {
    background: var(--white);
    border-radius: 5px;
    border-left: 3px solid var(--warm-brown);
    box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    padding: 12px 16px;
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .ability-card-sheet-main {
    flex: 1;
    min-width: 0;
  }

  .ability-card-sheet-name {
    font-family: var(--font-serif);
    font-size: 15px;
    font-weight: 700;
    color: var(--charcoal);
    margin-bottom: 2px;
  }

  .ability-card-sheet-linked {
    font-family: var(--font-sans);
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--light-gray);
  }

  .ability-card-sheet-score-area {
    text-align: right;
    flex-shrink: 0;
  }

  .ability-card-sheet-spectrum {
    position: relative;
    height: 5px;
    width: 120px;
    background: linear-gradient(to right,
      var(--color-critical)    0%,     var(--color-critical)    15.8%,
      var(--color-struggling)  15.8%,  var(--color-struggling)  31.6%,
      var(--color-below)       31.6%,  var(--color-below)       42.1%,
      var(--color-average)     42.1%,  var(--color-average)     52.6%,
      var(--color-above)       52.6%,  var(--color-above)       63.2%,
      var(--color-strong)      63.2%,  var(--color-strong)      73.7%,
      var(--color-excellent)   73.7%,  var(--color-excellent)   84.2%,
      var(--color-exceptional) 84.2%,  var(--color-exceptional) 100%
    );
    opacity: 0.45;
    margin-bottom: 6px;
    margin-left: auto;
  }

  .ability-card-sheet-dot {
    position: absolute;
    top: 50%;
    transform: translate(-50%, -50%);
    width: 10px;
    height: 10px;
    border-radius: 50%;
    border: 2px solid var(--white);
    box-shadow: 0 1px 3px rgba(0,0,0,0.25);
  }

  .ability-card-sheet-score {
    font-family: var(--font-sans);
    font-size: 18px;
    font-weight: 700;
    line-height: 1;
  }

  .ability-card-sheet-score-label {
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    margin-left: 3px;
  }

  /* Sheet Footer */
  .sheet-footer {
    padding: 40px 0 0;
    border-top: 1px solid var(--border-gray);
  }

  .sheet-footer-reflection {
    text-align: center;
    margin-bottom: 36px;
  }

  .sheet-footer-reflection-lead {
    font-family: var(--font-serif);
    font-size: 18px;
    color: var(--deep-slate);
    margin-bottom: 12px;
    line-height: 1.6;
  }

  .sheet-footer-reflection-body {
    font-family: var(--font-serif);
    font-size: 14px;
    color: var(--light-gray);
    line-height: 1.8;
    font-style: italic;
    max-width: 460px;
    margin: 0 auto;
  }

  .sheet-footer-actions {
    border-top: 1px solid var(--border-gray);
    padding-top: 28px;
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 20px;
    margin-bottom: 8px;
  }

  .sheet-footer-action {
    text-align: center;
  }

  .sheet-footer-action-label {
    font-family: var(--font-sans);
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--warm-brown);
    margin-bottom: 6px;
  }

  .sheet-footer-action-desc {
    font-family: var(--font-sans);
    font-size: 12px;
    color: var(--light-gray);
    line-height: 1.6;
  }

  .sheet-footer-close {
    text-align: center;
    padding: 28px 0 8px;
    font-family: var(--font-serif);
    font-size: 13px;
    color: var(--border-gray);
    font-style: italic;
    letter-spacing: 0.02em;
  }

  @media (max-width: 640px) {
    .sheet-footer-actions { grid-template-columns: 1fr; gap: 20px; }
  }

  .sheet-actions {
    margin-top: 24px;
    padding-top: 20px;
    border-top: 1px solid var(--border-gray);
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
  }

  .sheet-actions .btn {
    width: 100%;
    text-align: center;
    justify-content: center;
    font-size: 11px;
    padding: 6px 8px;
  }

  /* Edit button: warm-brown border already makes it stand out — no need to span */

  /* ==================== RESPONSIVE ==================== */
  @media (max-width: 640px) {
    .container { padding: 0 16px; }
    .container-wide { padding: 0 16px; }
    .profile-section { grid-template-columns: 1fr; gap: 24px; }
    .profile-photo { width: 100px; height: 100px; }

    /* Edit header: wrap button group onto multiple lines */
    .edit-header { flex-wrap: wrap; gap: 8px; margin-bottom: 24px; padding-bottom: 16px; }
    .edit-header h1 { font-size: 18px; }
    .edit-header .button-group { flex-wrap: wrap; gap: 6px; }
    .edit-mode-toggle { order: -1; } /* mode toggle first in flow */

    /* Section nav: smaller and wrappable */
    .section-nav { gap: 5px; top: 60px; }
    .section-nav button { font-size: 11px; padding: 6px 10px; min-height: 36px; }

    /* Edit attribute sections */
    .attribute-section { padding: 20px 16px; }

    /* Sub-step: smaller heading, full-width slider */
    .sub-step-question-name { font-size: 20px; }
    .sub-step-value-row .sub-score-value { font-size: 32px; }
    .sub-step-slider-area input[type="range"] { height: 8px; } /* easier to tap */

    /* BFI buttons: stack vertically on very small screens */
    .bfi-buttons { gap: 8px; }
    .bfi-btn { min-height: 44px; } /* touch target */

    /* Quick mode BFI — compact buttons */
    .quick-bfi-buttons .bfi-btn { min-height: 40px; font-size: 11px; }

    /* Quick mode sliders */
    .quick-subscore-slider-row input[type="range"] { height: 8px; }
    .quick-subscore-slider-row .sub-score-label { display: none; } /* save space */

    /* Score cards */
    .score-item-summary { padding: 12px 14px 4px 14px; }
    .score-item-pair { grid-template-columns: 1fr; }
    .sub-score-bar-item { grid-template-columns: 90px 30px 1fr; }

    /* Abilities on sheet */
    .ability-card-sheet { gap: 10px; }
    .ability-card-sheet-spectrum { width: 80px; }

    /* Sidebar stacks above main on small screens */
    .sheet-parchment { flex-direction: column; }
    .sheet-sidebar { width: 100%; border-right: none; border-bottom: 1px solid var(--border-gray); padding: 24px 16px 20px; }
    .sheet-main { padding: 24px 16px 40px; }
    .sheet-header h1 { font-size: 22px; }
    .sheet-actions { grid-template-columns: 1fr 1fr 1fr; }
    /* Hide print button on mobile — less useful */
    .sheet-actions .btn-print-hide { display: none; }

    /* Tutorial */
    .tutorial-page { padding: 40px 20px; }
    .tutorial-page h1 { font-size: 32px; }
    .tutorial-page h2 { font-size: 24px; }
    .tutorial-page p, .tutorial-page p.lead { font-size: 16px; }
    .tutorial-actions { flex-direction: column; align-items: center; }
    .tutorial-actions .btn { width: 100%; max-width: 280px; min-height: 48px; }
    .attr-preview-grid { grid-template-columns: 1fr; }

    /* Profile fields */
    .profile-fields-grid { grid-template-columns: 1fr; }
    .profile-field.profile-field-wide { grid-column: 1; }
    .profile-photo-wrap { align-items: center; }
    .profile-photo { width: 88px; height: 88px; } /* easier tap target */

    /* Personality */
    .big-five-item { padding: 14px 16px; }

    /* Score reveal */
    .score-reveal-number { font-size: 48px; }
  }

  /* Narrowest phones */
  @media (max-width: 380px) {
    .section-nav button { font-size: 10px; padding: 5px 8px; }
    .quick-bfi-buttons .bfi-btn { font-size: 10px; padding: 6px 6px; min-width: 52px; }
    .edit-header .button-group .btn { font-size: 11px; padding: 6px 10px; }
  }

  /* ==================== PRINT ==================== */
  @media print {
    @page { margin: 14mm 16mm; }

    /* Ensure colors print accurately */
    * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; color-adjust: exact !important; }

    body { background: white !important; font-size: 10pt; }

    /* Hide all non-content UI */
    #edit-view, #tutorial-view, #calculating-view, #prompt-modal,
    #radar-section,
    .edit-header, .sheet-actions, .btn, .tutorial-skip-link,
    .score-item-chevron, .sheet-footer-actions, .sheet-footer-close { display: none !important; }

    /* Remove chrome */
    #sheet-view { padding: 0; animation: none; }
    .container, #sheet-view .container { max-width: 100%; padding: 0; }
    .sheet-container { box-shadow: none; border: none; border-radius: 0; }

    /* Undo sidebar flex layout for print — linear top-to-bottom */
    .sheet-parchment { display: block; background: white !important; overflow: visible; border-radius: 0; }
    .sheet-sidebar { width: 100%; border-right: none; border-bottom: 1px solid #ddd; padding: 0 0 14pt; background: none; }
    .sheet-main { padding: 0; }

    /* Profile header — compact for print */
    .sheet-header { padding-bottom: 14pt; margin-bottom: 14pt; }
    .sheet-photo { width: 72pt; height: 72pt; box-shadow: none; border: 1pt solid #ddd; }
    .sheet-header h1 { font-size: 22pt; }
    .sheet-occupation { font-size: 11pt; margin-bottom: 4pt; }
    .sheet-meta { font-size: 9pt; }
    .sheet-meta-date { font-size: 8pt; margin-top: 4pt; }

    /* Attributes section starts on page 2 */
    #scores-rule { break-before: page; margin-bottom: 8pt; }

    /* Score cards — 2-column pairs, all expanded, page-filling */
    .scores-grid { display: grid; gap: 5pt; margin-bottom: 0; }
    .score-item-pair { display: grid; grid-template-columns: 1fr 1fr; gap: 5pt; }
    .score-item { break-inside: avoid; box-shadow: none; border-left-width: 3pt; }
    .score-item-summary { padding: 6pt 10pt 3pt 10pt; }
    .score-item-name { font-size: 8pt; }
    .score-item-tagline { font-size: 7.5pt; }
    .score-item-value { font-size: 16pt; }
    .score-item-label { font-size: 6.5pt; }
    .spectrum-bar { margin: 3pt 10pt 0; opacity: 0.55 !important; }
    .spectrum-marker { width: 7pt; height: 7pt; border-width: 1.5pt; }

    /* Force all score card details open; hide prose, show sub-scores only */
    .score-item-detail {
      max-height: none !important;
      overflow: visible !important;
      border-top-color: #e0e0e0 !important;
    }
    .score-item-detail-inner { padding: 5pt 10pt 7pt; }
    .score-item-detail-desc { display: none; }
    .score-item-detail-prompt { display: none; }
    .sub-score-bar-item { grid-template-columns: 74pt 24pt 1fr; gap: 5pt; margin-bottom: 4pt; }
    .sub-score-bar-name { font-size: 7.5pt; }
    .sub-score-bar-value { font-size: 8.5pt; }
    .sub-bar-track { height: 3.5pt; }

    /* Section rules */
    .sheet-section-rule { margin-bottom: 8pt; }
    .sheet-section-rule-text { font-size: 7pt; }

    /* Personality */
    .personality-section { margin-bottom: 20pt; }
    .personality-section-subtitle { font-size: 9pt; margin-bottom: 10pt; }
    .big-five-item { padding: 8pt 12pt; margin-bottom: 4pt; box-shadow: none; break-inside: avoid; }
    .big-five-name { font-size: 8pt; }
    .big-five-desc { font-size: 8pt; margin-bottom: 5pt; }
    .big-five-anchors { font-size: 7pt; }
    .big-five-bar-track { height: 3pt; }
    .big-five-interpretation { font-size: 8pt; margin-top: 4pt; }

    /* Abilities */
    .sheet-abilities { margin-bottom: 20pt; }
    .ability-card-sheet { padding: 5pt 8pt; box-shadow: none; break-inside: avoid; }
    .ability-card-sheet-name { font-size: 9pt; }
    .ability-card-sheet-score { font-size: 11pt; }
    .ability-card-sheet-spectrum { width: 80pt; }

    /* Footer — reflection text only */
    .sheet-footer { padding-top: 16pt; }
    .sheet-footer-reflection { margin-bottom: 0; }
    .sheet-footer-reflection-lead { font-size: 11pt; margin-bottom: 6pt; }
    .sheet-footer-reflection-body { font-size: 9pt; max-width: 100%; }
  }

  /* ==================== EDIT MODE TOGGLE ==================== */
  .edit-mode-toggle {
    display: flex;
    border: 1px solid var(--border-gray);
    border-radius: 4px;
    overflow: hidden;
    flex-shrink: 0;
  }

  .edit-mode-btn {
    font-family: var(--font-sans);
    font-size: 12px;
    padding: 6px 14px;
    border: none;
    background: var(--white);
    color: var(--medium-gray);
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
  }

  .edit-mode-btn:hover {
    background: var(--warm-brown-pale);
    color: var(--warm-brown);
  }

  .edit-mode-btn.active {
    background: var(--warm-brown);
    color: var(--white);
  }

  /* ==================== QUICK MODE SECTIONS ==================== */
  .quick-main-score {
    text-align: center;
    padding: 20px 24px;
    background: var(--very-light-gray);
    border-radius: 6px;
    margin-bottom: 24px;
  }

  .quick-subscore-list {
    border-top: 1px solid var(--border-gray);
    padding-top: 4px;
  }

  .quick-subscore-item {
    padding: 14px 0;
    border-bottom: 1px solid var(--border-gray);
  }

  .quick-subscore-item:last-child { border-bottom: none; }

  .quick-subscore-name {
    font-family: var(--font-sans);
    font-size: 14px;
    font-weight: 600;
    color: var(--deep-slate);
    margin-bottom: 2px;
  }

  .quick-subscore-desc {
    font-size: 13px;
    color: var(--light-gray);
    margin-bottom: 8px;
    line-height: 1.5;
  }

  .quick-subscore-slider-row {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .quick-subscore-slider-row input[type="range"] {
    flex: 1;
    max-width: none;
    height: 5px;
  }

  .quick-subscore-slider-row .sub-score-value {
    font-size: 18px;
    min-width: 28px;
    text-align: center;
  }

  .quick-subscore-slider-row .sub-score-label {
    font-size: 11px;
    min-width: 72px;
  }

  /* Quick BFI — all 10 items on one screen */
  .quick-bfi-list {
    display: flex;
    flex-direction: column;
    gap: 20px;
    margin-top: 8px;
  }

  .quick-bfi-item {
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border-gray);
  }

  .quick-bfi-item:last-child { border-bottom: none; }

  .quick-bfi-question {
    font-style: italic;
    font-weight: 600;
    font-size: 15px;
    color: var(--deep-slate);
    margin-bottom: 10px;
    line-height: 1.5;
  }

  .quick-bfi-buttons {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
  }

  .quick-bfi-buttons .bfi-btn {
    flex: 1;
    min-width: 80px;
    padding: 8px 10px;
    font-size: 12px;
    text-align: center;
  }

  /* ==================== SCORE REVEAL STEP ==================== */
  .score-reveal-step {
    animation: stepFadeIn 0.3s ease-out;
  }

  .score-reveal-main {
    text-align: center;
    padding: 28px 20px 24px;
    background: var(--very-light-gray);
    border-radius: 8px;
    margin-bottom: 24px;
  }

  .score-reveal-label {
    font-family: var(--font-sans);
    font-size: 11px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--light-gray);
    margin-bottom: 8px;
  }

  .score-reveal-number {
    font-family: var(--font-sans);
    font-size: 64px;
    font-weight: 700;
    line-height: 1;
    margin-bottom: 4px;
  }

  .score-reveal-tier {
    font-family: var(--font-sans);
    font-size: 15px;
    font-weight: 700;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    margin-bottom: 20px;
  }

  .score-reveal-subscores {
    display: grid;
    gap: 8px;
    margin-bottom: 28px;
  }

  .score-reveal-sub-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 14px;
    background: var(--white);
    border-radius: 5px;
    border: 1px solid var(--border-gray);
  }

  .score-reveal-sub-name {
    font-family: var(--font-sans);
    font-size: 13px;
    color: var(--deep-slate);
    font-weight: 500;
  }

  .score-reveal-sub-right {
    display: flex;
    align-items: baseline;
    gap: 6px;
  }

  .score-reveal-sub-value {
    font-family: var(--font-sans);
    font-size: 16px;
    font-weight: 700;
  }

  .score-reveal-sub-label {
    font-family: var(--font-sans);
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.05em;
    text-transform: uppercase;
  }

  /* ==================== PROMPT MODAL ==================== */
  #prompt-modal { display: none; }

  #prompt-modal.active {
    position: fixed; top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(45, 45, 45, 0.7);
    z-index: 2000;
    display: flex; align-items: flex-start; justify-content: center;
    padding: 40px 20px; overflow-y: auto;
  }

  .prompt-modal-box {
    background: var(--white); border-radius: 6px;
    max-width: 700px; width: 100%;
    box-shadow: 0 20px 60px rgba(0,0,0,0.25);
    overflow: hidden; margin: auto;
  }

  .prompt-modal-header {
    display: flex; justify-content: space-between; align-items: flex-start;
    padding: 24px 28px 20px;
    border-bottom: 1px solid var(--border-gray);
  }

  .prompt-modal-header h2 {
    font-family: var(--font-serif); font-size: 20px;
    font-weight: 700; color: var(--charcoal); margin-bottom: 4px;
  }

  .prompt-modal-subtitle {
    font-family: var(--font-sans); font-size: 12px; color: var(--light-gray);
  }

  .prompt-modal-close {
    background: none; border: none; font-size: 24px;
    color: var(--light-gray); cursor: pointer; padding: 4px 8px;
    line-height: 1; border-radius: 3px; transition: color 0.2s; flex-shrink: 0;
  }
  .prompt-modal-close:hover { color: var(--charcoal); }

  .prompt-modal-body { padding: 24px 28px; }

  .prompt-modal-instructions {
    font-family: var(--font-sans); font-size: 13px; color: var(--medium-gray);
    line-height: 1.6; margin-bottom: 16px; padding: 12px 16px;
    background: var(--warm-brown-pale); border-radius: 4px;
    border-left: 3px solid var(--warm-brown);
  }

  .prompt-text-display {
    font-family: var(--font-sans); font-size: 12px; line-height: 1.7;
    color: var(--deep-slate); background: var(--very-light-gray);
    border: 1px solid var(--border-gray); border-radius: 4px;
    padding: 20px; white-space: pre-wrap; word-break: break-word;
    max-height: 420px; overflow-y: auto;
    -webkit-user-select: text; user-select: text;
  }

  .prompt-modal-footer {
    padding: 16px 28px 24px;
    display: flex; gap: 12px; align-items: center;
    justify-content: flex-end; flex-wrap: wrap;
  }

  .prompt-copy-confirm {
    font-family: var(--font-sans); font-size: 12px;
    color: var(--color-strong); opacity: 0; transition: opacity 0.3s; flex: 1;
  }
  .prompt-copy-confirm.visible { opacity: 1; }

  @media (max-width: 640px) {
    #prompt-modal.active { padding: 0; align-items: flex-start; }
    .prompt-modal-box { border-radius: 0; min-height: 100vh; }
    .prompt-text-display { max-height: 320px; }
  }
</style>
</head>
<body>

<!-- TUTORIAL VIEW -->
<div id="tutorial-view">
  <a class="tutorial-skip-link" onclick="app.skipTutorial()">Skip to my sheet</a>
  <div id="tutorial-pages-container"></div>
</div>

<!-- CALCULATING VIEW -->
<div id="calculating-view">
  <div class="calc-content" id="calc-animation-content">
    <div class="calc-spinner"></div>
    <div class="calc-step" id="calc-step-1">Compiling your responses...</div>
    <div class="calc-step" id="calc-step-2">Calculating attribute scores...</div>
    <div class="calc-step" id="calc-step-3">Analysing personality profile...</div>
    <div class="calc-step" id="calc-step-4">Generating your character sheet...</div>
  </div>
  <div class="calc-prereveal" id="calc-prereveal">
    <div class="calc-prereveal-heading">Take a breath.</div>
    <p class="calc-prereveal-body">You've just done something genuinely uncommon. You sat with honest questions about eight dimensions of your life and gave real answers — not aspirational ones.</p>
    <p class="calc-prereveal-body">What follows is a portrait, not a verdict. Some scores will feel accurate. Some will surprise you. A few might sit uncomfortably. All of it is worth noticing.</p>
    <p class="calc-prereveal-body">There's no right way to read this. Just look.</p>
    <div class="calc-prereveal-cta">
      <button class="btn btn-primary" onclick="app.showSheet()">See your sheet</button>
    </div>
  </div>
</div>

<!-- PROMPT MODAL -->
<div id="prompt-modal" onclick="app.handlePromptBackdropClick(event)">
  <div class="prompt-modal-box">
    <div class="prompt-modal-header">
      <div>
        <h2>AI Character Study Prompt</h2>
        <div class="prompt-modal-subtitle">Copy and paste into any AI assistant</div>
      </div>
      <button class="prompt-modal-close" onclick="app.hidePromptModal()" aria-label="Close">&times;</button>
    </div>
    <div class="prompt-modal-body">
      <div class="prompt-modal-instructions">
        Paste this into Claude, ChatGPT, or any AI assistant. It instructs the AI to write a personalised character study based on your self-reflection data.
      </div>
      <div class="prompt-text-display" id="prompt-text-display"></div>
    </div>
    <div class="prompt-modal-footer">
      <span class="prompt-copy-confirm" id="prompt-copy-confirm">Copied to clipboard</span>
      <button class="btn btn-ghost btn-small" onclick="app.hidePromptModal()">Close</button>
      <button class="btn btn-primary btn-small" onclick="app.copyPrompt()">Copy Prompt</button>
    </div>
  </div>
</div>

<!-- EDIT VIEW -->
<div id="edit-view">
  <div class="container-wide">
    <div class="edit-header">
      <h1>Character Sheet</h1>
      <div class="button-group">
        <div class="edit-mode-toggle" id="edit-mode-toggle">
          <button class="edit-mode-btn" id="mode-btn-guided" onclick="app.setEditMode('guided')">Guided</button>
          <button class="edit-mode-btn" id="mode-btn-quick" onclick="app.setEditMode('quick')">Quick</button>
        </div>
        <button class="btn btn-primary btn-small" onclick="app.viewSheet()">View Sheet</button>
        <button class="btn btn-ghost btn-small" onclick="app.exportData()">Export</button>
        <button class="btn btn-ghost btn-small" onclick="app.importData()">Import</button>
        <button class="btn btn-ghost btn-small" onclick="app.showTutorial()">Guide</button>
        <button class="btn btn-ghost btn-small" onclick="app.showPromptModal()">AI Prompt</button>
      </div>
    </div>

    <input type="file" id="photo-input" accept="image/*" onchange="app.uploadPhoto(event)">
    <input type="file" id="import-input" accept=".json" style="display:none" onchange="app.handleImport(event)">

    <!-- Navigation -->
    <div class="section-nav" id="section-nav"></div>

    <!-- Sections Container -->
    <div id="sections-container"></div>
  </div>
</div>

<!-- SHEET VIEW -->
<div id="sheet-view">
  <div class="container">
    <div class="sheet-container">
      <div class="sheet-parchment">

        <!-- ── Sidebar: profile + actions ──────────────── -->
        <div class="sheet-sidebar">
          <div class="sheet-header">
            <div class="sheet-profile">
              <div class="sheet-photo">
                <img id="sheet-img" style="display: none;">
                <div class="sheet-photo-placeholder" id="sheet-photo-placeholder">&#9651;</div>
              </div>
              <h1 id="sheet-name">Character</h1>
              <div class="sheet-occupation" id="sheet-occupation" style="display:none"></div>
              <div class="sheet-meta" id="sheet-meta"></div>
            </div>
          </div>

          <div class="sheet-actions">
            <button class="btn btn-secondary btn-small" onclick="app.editSheet()">Edit</button>
            <button class="btn btn-ghost btn-small" onclick="app.exportData()">Export</button>
            <button class="btn btn-ghost btn-small" onclick="app.importData()">Import</button>
            <button class="btn btn-ghost btn-small" onclick="app.showTutorial()">Guide</button>
            <button class="btn btn-ghost btn-small btn-print-hide" onclick="window.print()">Print</button>
            <button class="btn btn-ghost btn-small" onclick="app.showPromptModal()">AI Prompt</button>
          </div>
        </div>

        <!-- ── Main content: attributes → personality → abilities ── -->
        <div class="sheet-main">
          <div id="radar-section">
            <canvas id="radar-canvas" width="560" height="440"></canvas>
          </div>
          <div class="sheet-section-rule" id="scores-rule"><span class="sheet-section-rule-text">Eight Attributes</span></div>
          <div class="scores-grid" id="scores-grid"></div>

          <div class="personality-section" id="personality-section-container"></div>

          <div class="sheet-abilities" id="sheet-abilities-container">
            <div class="sheet-section-rule"><span class="sheet-section-rule-text">Abilities</span></div>
            <div class="abilities-list" id="sheet-abilities"></div>
          </div>

          <div class="sheet-footer">
            <div class="sheet-footer-reflection">
              <div class="sheet-footer-reflection-lead">Your scores are a moment, not a fixed truth.</div>
              <div class="sheet-footer-reflection-body">Life shifts — sometimes slowly, sometimes all at once. Consider coming back to this sheet in a few months, or after something significant has changed. The value of honest self-reflection isn't in any single reading. It's in watching what moves — and understanding why.</div>
            </div>
            <div class="sheet-footer-actions">
              <div class="sheet-footer-action">
                <div class="sheet-footer-action-label">Export</div>
                <div class="sheet-footer-action-desc">Save your sheet as a file. Come back on any device — or keep a record of where you were right now.</div>
              </div>
              <div class="sheet-footer-action">
                <div class="sheet-footer-action-label">Import</div>
                <div class="sheet-footer-action-desc">Returning after time away? Load a previously saved sheet and pick up exactly where you left off.</div>
              </div>
              <div class="sheet-footer-action">
                <div class="sheet-footer-action-label">AI Prompt</div>
                <div class="sheet-footer-action-desc">Generate a prompt you can paste into any AI assistant to receive a personalised narrative portrait of who you are right now.</div>
              </div>
            </div>
            <div class="sheet-footer-close">Come back when enough has changed to be worth noticing.</div>
          </div>
        </div>

      </div>
    </div>


  </div>
</div>

<script>
// ==================== DATA ====================

const ATTRIBUTES = [
  {
    key: 'body', name: 'Body', tagline: 'Your physical self — health, capability, and energy.',
    description: 'Your Body score reflects the overall state of your physical existence. It\'s not about how you look. It\'s about how your body serves you: whether it\'s healthy, capable, energetic, and well-rested.',
    prompt: 'If a doctor who knew everything about my physical state gave me an honest rating, what would they say?',
    subScores: [
      { key: 'health', name: 'Health', desc: 'Considers chronic conditions, illness, injury history, and current health status. Not about perfection — about how your body is actually functioning day to day.<br><br><span class="scale-anchors"><em>1–4:</em> Managing serious illness, chronic pain, or frequent health crises &nbsp;·&nbsp; <em>9–12:</em> Generally healthy; minor issues managed, no major limitations &nbsp;·&nbsp; <em>18–20:</em> Excellent health across the board; rarely sick, conditions well-controlled or absent</span>' },
      { key: 'strength', name: 'Strength', desc: 'Physical capacity — lifting, carrying, pushing. Not about being an athlete; about whether your body can handle the physical demands of your actual life.<br><br><span class="scale-anchors"><em>1–4:</em> Significant physical weakness; struggle with ordinary tasks &nbsp;·&nbsp; <em>9–12:</em> Average capability; can handle everyday physical demands &nbsp;·&nbsp; <em>18–20:</em> Noticeably strong; physical capability is a genuine asset</span>' },
      { key: 'agility', name: 'Agility', desc: 'Flexibility, coordination, balance, and ease of movement. Declines quietly with age and inactivity — most people only notice when they lose it.<br><br><span class="scale-anchors"><em>1–4:</em> Stiff, uncoordinated, or at meaningful injury risk &nbsp;·&nbsp; <em>9–12:</em> Adequate mobility; can move through daily life without issue &nbsp;·&nbsp; <em>18–20:</em> Excellent flexibility and coordination; fluid, controlled movement</span>' },
      { key: 'stamina', name: 'Stamina', desc: 'Cardiovascular fitness. How long your body can sustain effort — walking, climbing stairs, running for a bus.<br><br><span class="scale-anchors"><em>1–4:</em> Breathless after light activity; cardiovascular fitness is poor &nbsp;·&nbsp; <em>9–12:</em> Reasonable fitness; can handle moderate sustained effort &nbsp;·&nbsp; <em>18–20:</em> Strong endurance; sustained physical effort feels comfortable</span>' },
      { key: 'vitality', name: 'Vitality', desc: 'Your energy across the day — not just morning freshness, but sustained capacity. A leading indicator of overall health and lifestyle.<br><br><span class="scale-anchors"><em>1–4:</em> Chronically exhausted; energy is a daily struggle &nbsp;·&nbsp; <em>9–12:</em> Adequate energy for normal demands; some afternoon tiredness &nbsp;·&nbsp; <em>18–20:</em> Consistently high energy throughout the day; feels alive and ready</span>' },
      { key: 'rest', name: 'Rest', desc: 'Quality and quantity of sleep, plus recovery from exertion. The foundation everything else rests on.<br><br><span class="scale-anchors"><em>1–4:</em> Chronically sleep-deprived or very poor sleep quality &nbsp;·&nbsp; <em>9–12:</em> Generally adequate sleep; occasional poor nights &nbsp;·&nbsp; <em>18–20:</em> Excellent sleep consistently; wake refreshed; recover well from effort</span>' },
    ]
  },
  {
    key: 'mind', name: 'Mind', tagline: 'Your mental life — clarity, emotional health, and intellectual engagement.',
    description: 'Your Mind score captures how well your inner world is functioning. A high Mind score doesn\'t mean you\'re a genius — it means your mental life is healthy, active, and well-managed.',
    prompt: 'How is my inner world? Is it a place of clarity and growth, or confusion and distress?',
    subScores: [
      { key: 'mental_health', name: 'Mental Health', desc: 'Freedom from significant depression, anxiety, or other psychological conditions — and if present, how well they are managed.<br><br><span class="scale-anchors"><em>1–4:</em> Significant symptoms affecting daily function &nbsp;·&nbsp; <em>9–12:</em> Mostly okay; manageable stress and occasional low periods &nbsp;·&nbsp; <em>18–20:</em> Genuinely good psychological health; stable, rarely overwhelmed</span>' },
      { key: 'clarity', name: 'Clarity', desc: 'The quality of your thinking — focused, decisive, unfogged. Affected by sleep, stress, diet, and exercise more than people realise.<br><br><span class="scale-anchors"><em>1–4:</em> Persistent mental fog; difficulty focusing or making decisions &nbsp;·&nbsp; <em>9–12:</em> Generally clear-headed; normal concentration with effort &nbsp;·&nbsp; <em>18–20:</em> Sharp, focused, decisive; thinking feels clean and efficient</span>' },
      { key: 'emotional_regulation', name: 'Emotional Regulation', desc: 'How well you manage your emotional responses — not suppression, but the ability to feel without being hijacked.<br><br><span class="scale-anchors"><em>1–4:</em> Frequently overwhelmed, reactive, or emotionally chaotic &nbsp;·&nbsp; <em>9–12:</em> Mostly regulated; can manage everyday emotional demands &nbsp;·&nbsp; <em>18–20:</em> Excellent emotional control; responds rather than reacts; calm under pressure</span>' },
      { key: 'learning', name: 'Learning', desc: 'Active intellectual growth. Are you currently expanding what you know and can do?<br><br><span class="scale-anchors"><em>1–4:</em> Little or no intellectual engagement; growth has stalled &nbsp;·&nbsp; <em>9–12:</em> Some learning happening; occasional reading or skill development &nbsp;·&nbsp; <em>18–20:</em> Consistently and actively learning; growth is a regular part of life</span>' },
      { key: 'creativity', name: 'Creativity', desc: 'The expression of ideas, making of things, or novel problem-solving. Not just art — any domain where you generate rather than consume.<br><br><span class="scale-anchors"><em>1–4:</em> Little to no creative activity or expression &nbsp;·&nbsp; <em>9–12:</em> Occasional creativity; some projects or ideas pursued &nbsp;·&nbsp; <em>18–20:</em> Highly creative output; making and generating is a significant part of life</span>' },
    ]
  },
  {
    key: 'spirit', name: 'Spirit', tagline: 'Your relationship with meaning, purpose, and your own character.',
    description: 'Spirit reflects whether you feel your life has direction and meaning, whether you live with integrity, and whether you\'ve made peace with being the person you are. This isn\'t necessarily about religion — it\'s about the foundational questions.',
    prompt: 'Do I feel like my life means something? Am I at peace with who I am?',
    subScores: [
      { key: 'purpose', name: 'Purpose', desc: 'A felt sense that your life has direction — that you\'re working toward something that matters. Not necessarily a grand mission; even a clear personal north star counts.<br><br><span class="scale-anchors"><em>1–4:</em> Drifting; no clear sense of direction or what matters &nbsp;·&nbsp; <em>9–12:</em> Some sense of purpose; direction exists but may be vague &nbsp;·&nbsp; <em>18–20:</em> Clear, felt purpose; daily life connects to something meaningful</span>' },
      { key: 'integrity', name: 'Integrity', desc: 'Living in alignment with your values. The gap between what you say you believe and how you actually behave.<br><br><span class="scale-anchors"><em>1–4:</em> Significant gap between stated values and actual behaviour &nbsp;·&nbsp; <em>9–12:</em> Mostly aligned; occasional compromises &nbsp;·&nbsp; <em>18–20:</em> High integrity; actions consistently reflect values; little internal conflict</span>' },
      { key: 'self_acceptance', name: 'Self-Acceptance', desc: 'How you relate to your own flaws, failures, and limitations — with harshness or with honest compassion.<br><br><span class="scale-anchors"><em>1–4:</em> Harsh self-critic; significant shame or self-rejection &nbsp;·&nbsp; <em>9–12:</em> Generally okay with yourself; some areas of self-criticism &nbsp;·&nbsp; <em>18–20:</em> Genuine self-acceptance; owns flaws without being defined by them</span>' },
      { key: 'gratitude', name: 'Gratitude', desc: 'The ability to notice and appreciate what\'s good, without pretending the bad doesn\'t exist.<br><br><span class="scale-anchors"><em>1–4:</em> Predominantly focused on lack, complaint, or what\'s missing &nbsp;·&nbsp; <em>9–12:</em> Moderate appreciation; gratitude present but inconsistent &nbsp;·&nbsp; <em>18–20:</em> Regularly notices and savours what\'s good; genuine thankfulness</span>' },
      { key: 'practice', name: 'Practice', desc: 'A regular discipline that nourishes the spirit — meditation, prayer, journalling, time in nature, whatever grounds you.<br><br><span class="scale-anchors"><em>1–4:</em> No regular practice; inner life left to chance &nbsp;·&nbsp; <em>9–12:</em> Some practice; irregular or just beginning &nbsp;·&nbsp; <em>18–20:</em> Consistent and meaningful practice; a genuine anchor in daily life</span>' },
    ]
  },
  {
    key: 'heart', name: 'Heart', tagline: 'Your connections — love, belonging, and generosity.',
    description: 'Heart captures the relational dimension of your life. The quality of our relationships is one of the strongest predictors of both happiness and longevity. Are you loved? Do you love? Are you connected?',
    prompt: 'If I needed help at 3am, who would I call? How long is that list? And would I answer their call?',
    subScores: [
      { key: 'partner', name: 'Partner', desc: 'Quality and satisfaction in your romantic relationship — or, if single, your peace and acceptance of that. Rate this in terms of love, trust, and connection, not just whether a relationship exists.<br><br><span class="scale-anchors"><em>1–4:</em> In a deeply unhappy relationship, or painfully struggling with being single &nbsp;·&nbsp; <em>9–12:</em> Relationship is okay or singleness is manageable &nbsp;·&nbsp; <em>18–20:</em> Deeply loving, trusting relationship — or fully at peace and content as single</span>' },
      { key: 'family', name: 'Family', desc: 'The quality of your family relationships — parents, siblings, children. Warmth, closeness, and support — not obligation or surface contact.<br><br><span class="scale-anchors"><em>1–4:</em> Family relationships are painful, estranged, or a significant source of distress &nbsp;·&nbsp; <em>9–12:</em> Adequate family connection; some warmth with some distance or tension &nbsp;·&nbsp; <em>18–20:</em> Close, warm, and genuinely supportive family relationships</span>' },
      { key: 'friendships', name: 'Friendships', desc: 'Real friendships — people who know you, who you\'d call in a crisis, who are genuinely in your life. Not followers or acquaintances.<br><br><span class="scale-anchors"><em>1–4:</em> Few or no close friends; significant loneliness &nbsp;·&nbsp; <em>9–12:</em> A small circle; some real connection &nbsp;·&nbsp; <em>18–20:</em> Rich friendships; genuinely known and loved by people you care about</span>' },
      { key: 'community', name: 'Community', desc: 'Belonging to something beyond your immediate circle — a neighbourhood, a group, a cause, a shared identity.<br><br><span class="scale-anchors"><em>1–4:</em> No real sense of belonging beyond immediate family &nbsp;·&nbsp; <em>9–12:</em> Some community connection; occasional participation &nbsp;·&nbsp; <em>18–20:</em> Strong sense of belonging; active, valued member of a community</span>' },
      { key: 'giving', name: 'Giving', desc: 'The role generosity, charity, and service to others play in your life.<br><br><span class="scale-anchors"><em>1–4:</em> Little or no giving; self-focused by default &nbsp;·&nbsp; <em>9–12:</em> Some giving; charitable when prompted &nbsp;·&nbsp; <em>18–20:</em> Generosity is a core part of your life; giving of time, money, or effort is regular and meaningful</span>' },
    ]
  },
  {
    key: 'standing', name: 'Standing', tagline: 'Your place in the world — career, wealth, reputation, and home.',
    description: 'Standing reflects how the external world sees you and what you\'ve built in material terms. It\'s not about vanity — it\'s about recognising that these things affect your quality of life.',
    prompt: 'Would I be comfortable if a journalist profiled my life? Not because it\'s impressive — but because it\'s solid?',
    subScores: [
      { key: 'career', name: 'Career', desc: 'Satisfaction, engagement, and progression in your professional life. Not just income — fulfilment, direction, and whether your work feels worthwhile.<br><br><span class="scale-anchors"><em>1–4:</em> Deeply dissatisfied, stalled, or in the wrong role &nbsp;·&nbsp; <em>9–12:</em> Job is okay; adequate but not inspiring &nbsp;·&nbsp; <em>18–20:</em> Genuinely engaged and progressing; work feels meaningful and directional</span>' },
      { key: 'wealth', name: 'Wealth', desc: 'Your net financial position, financial security, and trajectory — not just income. Are you building or eroding?<br><br><span class="scale-anchors"><em>1–4:</em> In financial distress; debt, insecurity, or significant instability &nbsp;·&nbsp; <em>9–12:</em> Financially stable; covering needs with some margin &nbsp;·&nbsp; <em>18–20:</em> Genuinely financially secure; building wealth; money is not a source of anxiety</span>' },
      { key: 'reputation', name: 'Reputation', desc: 'How others — professionally and personally — perceive and talk about you. Are you trusted and respected?<br><br><span class="scale-anchors"><em>1–4:</em> Reputation is damaged, unclear, or a source of concern &nbsp;·&nbsp; <em>9–12:</em> Reasonably regarded; not notable in either direction &nbsp;·&nbsp; <em>18–20:</em> Genuinely respected; trusted, well-regarded in your field or community</span>' },
      { key: 'home', name: 'Home', desc: 'The quality, comfort, and security of your living situation. Does where you live support or undermine your life?<br><br><span class="scale-anchors"><em>1–4:</em> Home situation is poor, precarious, or a source of significant stress &nbsp;·&nbsp; <em>9–12:</em> Adequate home; comfortable enough &nbsp;·&nbsp; <em>18–20:</em> Home feels like a genuine haven; safe, comfortable, and yours</span>' },
    ]
  },
  {
    key: 'resilience', name: 'Resilience', tagline: 'Your capacity to withstand adversity and recover from setbacks.',
    description: 'Resilience only reveals itself under pressure. You might think yours is high when life is calm — but you don\'t really know until something goes wrong. Look at the evidence.',
    prompt: 'Think about the last truly difficult thing that happened. How did you handle it? What does that tell you?',
    subScores: [
      { key: 'adversity_tolerance', name: 'Adversity Tolerance', desc: 'How well you hold up when things go wrong — your capacity to function under difficulty without collapsing.<br><br><span class="scale-anchors"><em>1–4:</em> Falls apart under moderate pressure; adversity is destabilising &nbsp;·&nbsp; <em>9–12:</em> Manages most difficulties adequately; struggles with major ones &nbsp;·&nbsp; <em>18–20:</em> Remains functional and even-keeled under significant adversity</span>' },
      { key: 'recovery', name: 'Recovery', desc: 'How quickly and fully you bounce back after setbacks, disappointments, or failures.<br><br><span class="scale-anchors"><em>1–4:</em> Takes a very long time to recover; setbacks leave lasting marks &nbsp;·&nbsp; <em>9–12:</em> Recovers at a normal rate; some things linger longer than they should &nbsp;·&nbsp; <em>18–20:</em> Bounces back quickly and fully; rarely carries forward the weight of past setbacks</span>' },
      { key: 'adaptability', name: 'Adaptability', desc: 'Your ability to change course when circumstances change — to pivot, adjust, and thrive in new conditions.<br><br><span class="scale-anchors"><em>1–4:</em> Struggles significantly with change; rigidity under uncertainty &nbsp;·&nbsp; <em>9–12:</em> Adapts adequately to most changes with some effort &nbsp;·&nbsp; <em>18–20:</em> Highly adaptable; change is handled with flexibility and composure</span>' },
      { key: 'grit', name: 'Grit', desc: 'Sustained effort toward long-term goals despite obstacles, boredom, and setbacks. Not intensity — consistency over time.<br><br><span class="scale-anchors"><em>1–4:</em> Gives up easily when things get hard or boring &nbsp;·&nbsp; <em>9–12:</em> Persists through most challenges but wavers under sustained difficulty &nbsp;·&nbsp; <em>18–20:</em> Remarkable persistence; continues working toward goals even through extended hardship</span>' },
    ]
  },
  {
    key: 'discipline', name: 'Discipline', tagline: 'Your ability to do what you intend to do.',
    description: 'Discipline is the engine that turns intention into action. It\'s about the gap between what you plan to do and what you actually do. The most honest stat on the sheet.',
    prompt: 'If I made a list of everything I said I\'d do this month, what percentage did I actually do?',
    subScores: [
      { key: 'habits', name: 'Habits', desc: 'The quality and consistency of your daily routines — the things you do automatically that shape your life.<br><br><span class="scale-anchors"><em>1–4:</em> Few or no consistent habits; daily structure is largely absent &nbsp;·&nbsp; <em>9–12:</em> Some habits; inconsistent maintenance &nbsp;·&nbsp; <em>18–20:</em> Strong, consistent habits; daily routines are a genuine asset</span>' },
      { key: 'follow_through', name: 'Follow-Through', desc: 'Whether you actually finish what you start and keep the commitments you make — to yourself and others.<br><br><span class="scale-anchors"><em>1–4:</em> Regularly fails to follow through; commitments are unreliable &nbsp;·&nbsp; <em>9–12:</em> Generally follows through on commitments; some things slip &nbsp;·&nbsp; <em>18–20:</em> Highly reliable; finishes what is started; word is trusted</span>' },
      { key: 'impulse_control', name: 'Impulse Control', desc: 'Your capacity to resist short-term temptation in service of long-term goals.<br><br><span class="scale-anchors"><em>1–4:</em> Frequently acts on impulse; short-term wins over long-term routinely &nbsp;·&nbsp; <em>9–12:</em> Reasonable self-control in most situations; some weaknesses &nbsp;·&nbsp; <em>18–20:</em> Strong impulse control; consistently chooses long-term over short-term</span>' },
      { key: 'time_management', name: 'Time Management', desc: 'How well you use your hours — planning, prioritising, and following through on how you intended to spend your time.<br><br><span class="scale-anchors"><em>1–4:</em> Time feels chaotic and uncontrolled; days slip by without intention &nbsp;·&nbsp; <em>9–12:</em> Adequate time management; broadly purposeful but some waste &nbsp;·&nbsp; <em>18–20:</em> Excellent use of time; hours are used deliberately and productively</span>' },
    ]
  },
  {
    key: 'joy', name: 'Joy', tagline: 'Whether you\'re actually enjoying your life.',
    description: 'Joy is the attribute most people forget to check. You can be healthy, successful, disciplined, and loved — and still not be having a good time. Are you enjoying this?',
    prompt: 'When did I last feel genuinely delighted? How long ago was that? And what does that tell me?',
    subScores: [
      { key: 'pleasure', name: 'Pleasure', desc: 'Enjoyment of simple sensory pleasures — food, music, beauty, comfort. Are your senses alive to the world?<br><br><span class="scale-anchors"><em>1–4:</em> Little pleasure in daily experience; senses feel dull or muted &nbsp;·&nbsp; <em>9–12:</em> Enjoys some pleasures regularly; nothing remarkable &nbsp;·&nbsp; <em>18–20:</em> Richly alive to simple pleasures; everyday experience is a source of genuine enjoyment</span>' },
      { key: 'play', name: 'Play', desc: 'Whether fun and play have a genuine place in your life — things done purely for enjoyment, with no goal but the thing itself.<br><br><span class="scale-anchors"><em>1–4:</em> Little to no play; life is all responsibility and no fun &nbsp;·&nbsp; <em>9–12:</em> Some fun; occasional play, though often edged out by obligations &nbsp;·&nbsp; <em>18–20:</em> Play is a genuine and regular part of life; you have real fun, regularly</span>' },
      { key: 'humour', name: 'Humour', desc: 'Whether laughter, lightness, and absurdity have a place in your daily life.<br><br><span class="scale-anchors"><em>1–4:</em> Life feels heavy; little laughter or levity &nbsp;·&nbsp; <em>9–12:</em> Reasonably good humour; laughs regularly &nbsp;·&nbsp; <em>18–20:</em> Genuine wit and lightness; laughter is frequent and real</span>' },
      { key: 'flow', name: 'Flow', desc: 'Whether you regularly experience deep absorption in activities — losing track of time, fully present in what you\'re doing.<br><br><span class="scale-anchors"><em>1–4:</em> Rarely or never experiences flow; most activities feel effortful or hollow &nbsp;·&nbsp; <em>9–12:</em> Occasional flow states; some activities that fully absorb &nbsp;·&nbsp; <em>18–20:</em> Regular flow experiences; deep engagement is a common feature of life</span>' },
      { key: 'savouring', name: 'Savouring', desc: 'The practice of slowing down to notice and appreciate good moments while they\'re happening — rather than rushing past them.<br><br><span class="scale-anchors"><em>1–4:</em> Rarely stops to appreciate; always looking ahead or elsewhere &nbsp;·&nbsp; <em>9–12:</em> Sometimes savours; notices good moments but often lets them pass &nbsp;·&nbsp; <em>18–20:</em> Consistently and deliberately savours; present, appreciative, unhurried with what\'s good</span>' },
    ]
  }
];

const BFI_ITEMS = [
  { trait: 'extraversion', reverse: true, text: 'I see myself as someone who is reserved' },
  { trait: 'agreeableness', reverse: false, text: 'I see myself as someone who is generally trusting' },
  { trait: 'conscientiousness', reverse: true, text: 'I see myself as someone who tends to be lazy' },
  { trait: 'neuroticism', reverse: true, text: 'I see myself as someone who is relaxed, handles stress well' },
  { trait: 'openness', reverse: true, text: 'I see myself as someone who has few artistic interests' },
  { trait: 'extraversion', reverse: false, text: 'I see myself as someone who is outgoing, sociable' },
  { trait: 'agreeableness', reverse: true, text: 'I see myself as someone who tends to find fault with others' },
  { trait: 'conscientiousness', reverse: false, text: 'I see myself as someone who does a thorough job' },
  { trait: 'neuroticism', reverse: false, text: 'I see myself as someone who gets nervous easily' },
  { trait: 'openness', reverse: false, text: 'I see myself as someone who has an active imagination' },
];

const TRAIT_INFO = {
  openness: {
    name: 'Openness',
    desc: 'Your appetite for novelty, ideas, art, and new experiences.',
    low: 'You prefer the familiar and practical',
    high: 'You\'re drawn to novelty and ideas'
  },
  conscientiousness: {
    name: 'Conscientiousness',
    desc: 'Your tendency toward organisation, discipline, and thoroughness.',
    low: 'You\'re spontaneous and flexible',
    high: 'You\'re systematic and goal-directed'
  },
  extraversion: {
    name: 'Extraversion',
    desc: 'Your orientation toward the outer world of people and activity.',
    low: 'You prefer quieter, calmer settings',
    high: 'You\'re energised by people and activity'
  },
  agreeableness: {
    name: 'Agreeableness',
    desc: 'Your orientation toward cooperation and trust with others.',
    low: 'You\'re direct and skeptical',
    high: 'You\'re trusting and cooperative'
  },
  neuroticism: {
    name: 'Neuroticism',
    desc: 'Your tendency to experience negative emotions and stress.',
    low: 'You\'re emotionally steady and even-keeled',
    high: 'You feel things intensely and deeply'
  }
};

const SCORE_LABELS = [
  { min: 1, max: 4, label: 'Critical', color: 'var(--color-critical)' },
  { min: 5, max: 7, label: 'Struggling', color: 'var(--color-struggling)' },
  { min: 8, max: 9, label: 'Below Average', color: 'var(--color-below)' },
  { min: 10, max: 11, label: 'Average', color: 'var(--color-average)' },
  { min: 12, max: 13, label: 'Above Average', color: 'var(--color-above)' },
  { min: 14, max: 15, label: 'Strong', color: 'var(--color-strong)' },
  { min: 16, max: 17, label: 'Excellent', color: 'var(--color-excellent)' },
  { min: 18, max: 20, label: 'Exceptional', color: 'var(--color-exceptional)' },
];

function getScoreInfo(score) {
  const s = Math.max(1, Math.min(20, Math.round(score)));
  for (const sl of SCORE_LABELS) {
    if (s >= sl.min && s <= sl.max) return { label: sl.label, color: sl.color };
  }
  return { label: 'Average', color: 'var(--color-average)' };
}

function escapeHtml(str) {
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

// State
const state = {
  profile: { name: 'Character', age: '', gender: '', occupation: '', location: '', relationship: '', photo: null },
  scores: {},
  subScores: {},
  overrides: {},
  bfiResponses: {},
  abilities: []
};

let currentSection = -1; // -1 = Profile, 0 = Personality, 1-8 = attributes, 9 = Abilities
let currentSubStep = 0;  // 0 = intro, 1..N = sub-scale index, N+1 = score reveal
let currentBFIStep = -1; // -1 = BFI intro, 0–9 = individual BFI items
let editMode = 'guided'; // 'guided' | 'quick'
let saveTimeout = null;

// Global step map — built once, used by stepForward/stepBack
function buildGlobalStepMap() {
  const map = [];
  ATTRIBUTES.forEach((attr, i) => {
    map.push({ section: i + 1, subStep: 0 });
    attr.subScores.forEach((_, j) => map.push({ section: i + 1, subStep: j + 1 }));
  });
  return map; // 46 entries total across 8 attributes
}
let GLOBAL_STEP_MAP = null;

// ==================== APP ====================

const app = {
  init() {
    const saved = localStorage.getItem('charactersheet-data');

    if (saved) {
      this.loadFromStorage();
      this.showSheet();
    } else {
      this.showTutorial();
    }
  },

  initializeNewSheet() {
    ATTRIBUTES.forEach(attr => {
      state.scores[attr.key] = 10;
      state.overrides[attr.key] = false;
      attr.subScores.forEach(sub => {
        state.subScores[sub.key] = 10;
      });
    });

    BFI_ITEMS.forEach((item, i) => {
      state.bfiResponses[i] = 3;
    });

    state.abilities = [];
  },

  // ==================== TUTORIAL ====================

  showTutorial() {
    document.getElementById('tutorial-view').classList.add('active');
    document.getElementById('edit-view').classList.remove('active');
    document.getElementById('sheet-view').classList.remove('active');
    document.getElementById('calculating-view').classList.remove('active');
    this.renderTutorial();
    window.scrollTo(0, 0);
  },

  renderTutorial() {
    const container = document.getElementById('tutorial-pages-container');

    const attrCards = ATTRIBUTES.map(a => `
      <div class="attr-preview-card" style="border-left: 3px solid var(--attr-${a.key})">
        <div class="attr-preview-name" style="color: var(--attr-${a.key})">${a.name}</div>
        <div class="attr-preview-tagline">${a.tagline}</div>
      </div>
    `).join('');

    const pages = [
      // PAGE 1 — Welcome
      `<div class="tutorial-page">
        <div class="tutorial-page-content">
          <h1>THE CHARACTER SHEET</h1>
          <p class="tutorial-subtitle">A Guide to Knowing Yourself</p>
          <p class="lead" style="margin-top: 32px;">You've been playing the most complex game ever designed for your entire life. It has no tutorial, no pause button, and the rules keep changing.</p>
          <p>This is your invitation to stop and look at your character sheet.</p>
          <p>It's a structured self-reflection tool — a way to take an honest, clear-eyed look at who you are right now across the dimensions that matter most. Not where you think you stand. Not where you wish you stood. Where you actually are, today.</p>
          <p>Some of what you see will make you proud. Some of it might be uncomfortable. All of it is useful.</p>
          <div class="tutorial-actions">
            <button class="btn btn-primary" onclick="app.scrollToPage(1)">Begin</button>
          </div>
        </div>
      </div>`,

      // PAGE 2 — How It Works
      `<div class="tutorial-page">
        <div class="tutorial-page-content">
          <h2>How It Works</h2>
          <p style="margin-top: 24px;">Your character is defined by <strong>eight core attributes</strong>. Each one represents a fundamental dimension of a human life. Together, they form a complete portrait — not of who you want to be, but of who you are.</p>
          <p>You'll rate each attribute on a <strong>1–20 scale</strong>, where 10 is average. Each attribute has sub-scores that help you think carefully about what's really going on beneath the surface.</p>
          <p>There is no total score. Your attributes are never summed into a single number. Life is not an optimisation problem, and the person with the highest total is not winning — they might simply be the least honest.</p>
          <p>You'll also capture your <strong>abilities</strong> — the specific skills and pursuits that make you you — and take a brief <strong>personality snapshot</strong> based on the Big Five model from psychology.</p>
          <div class="tutorial-actions">
            <button class="btn btn-secondary" onclick="app.scrollToPage(0)">Back</button>
            <button class="btn btn-primary" onclick="app.scrollToPage(2)">Continue</button>
          </div>
        </div>
      </div>`,

      // PAGE 3 — The Eight Attributes
      `<div class="tutorial-page">
        <div class="tutorial-page-content">
          <h2>The Eight Attributes</h2>
          <p style="margin-top: 16px;">Each represents a different dimension of your life. Some are things within your control — your effort, your character, your choices. Others are influenced by your actions but subject to forces beyond you. The measure of a life well-lived is not your scores, but how you relate to them.</p>
          <div class="attr-preview-grid">${attrCards}</div>
          <p style="font-size: 14px; color: var(--light-gray);">You'll rate each one with sub-scores that automatically combine into your main attribute score. You can override the auto-calculation if you feel the whole is different from the sum of its parts.</p>
          <div class="tutorial-actions">
            <button class="btn btn-secondary" onclick="app.scrollToPage(1)">Back</button>
            <button class="btn btn-primary" onclick="app.scrollToPage(3)">Continue</button>
          </div>
        </div>
      </div>`,

      // PAGE 4 — The Scale
      `<div class="tutorial-page">
        <div class="tutorial-page-content">
          <h2>The 1–20 Scale</h2>
          <p style="margin-top: 16px;">Every score uses the same scale, giving you a common language across very different areas of your life.</p>
          <table class="score-table">
            <tr><th>Score</th><th>Meaning</th></tr>
            <tr><td><span class="score-color" style="background:var(--color-critical)"></span><strong>1–4</strong></td><td>Critical — in serious difficulty</td></tr>
            <tr><td><span class="score-color" style="background:var(--color-struggling)"></span><strong>5–7</strong></td><td>Struggling — noticeably below where you'd want to be</td></tr>
            <tr><td><span class="score-color" style="background:var(--color-below)"></span><strong>8–9</strong></td><td>Below Average — room for improvement</td></tr>
            <tr><td><span class="score-color" style="background:var(--color-average)"></span><strong>10–11</strong></td><td>Average — where most people land</td></tr>
            <tr><td><span class="score-color" style="background:var(--color-above)"></span><strong>12–13</strong></td><td>Above Average — a genuine strength</td></tr>
            <tr><td><span class="score-color" style="background:var(--color-strong)"></span><strong>14–15</strong></td><td>Strong — going well, and you know it</td></tr>
            <tr><td><span class="score-color" style="background:var(--color-excellent)"></span><strong>16–17</strong></td><td>Excellent — people probably notice</td></tr>
            <tr><td><span class="score-color" style="background:var(--color-exceptional)"></span><strong>18–20</strong></td><td>Exceptional — a defining feature of your life</td></tr>
          </table>
          <p style="text-align: left; font-size: 14px; color: var(--medium-gray);">10 is not a failing grade — it's where most people are. Nobody has 20s across the board. And these scores move: they change with your circumstances, your effort, and plain luck. The sheet is designed to be revisited.</p>
          <div class="tutorial-actions">
            <button class="btn btn-secondary" onclick="app.scrollToPage(2)">Back</button>
            <button class="btn btn-primary" onclick="app.scrollToPage(4)">Continue</button>
          </div>
        </div>
      </div>`,

      // PAGE 5 — Let's Begin
      `<div class="tutorial-page">
        <div class="tutorial-page-content">
          <h2>Ready</h2>
          <p style="margin-top: 32px; font-size: 18px;">Take your time. Be honest. There are no right answers and no one is grading you.</p>
          <p style="font-size: 17px;">This sheet is for you alone — unless you choose to share it.</p>
          <p style="margin-top: 24px; color: var(--medium-gray);">You'll start by entering a few details about yourself, then move through each section at your own pace. You can return and edit anything at any time.</p>
          <div class="tutorial-actions">
            <button class="btn btn-secondary" onclick="app.scrollToPage(3)">Back</button>
            <button class="btn btn-primary" onclick="app.completeTutorial()">Create My Sheet</button>
          </div>
        </div>
      </div>`
    ];

    container.innerHTML = pages.join('');
  },

  scrollToPage(index) {
    const pages = document.querySelectorAll('.tutorial-page');
    if (pages[index]) {
      pages[index].scrollIntoView({ behavior: 'smooth' });
    }
  },

  skipTutorial() {
    document.getElementById('tutorial-view').classList.remove('active');
    const hasSavedData = !!localStorage.getItem('charactersheet-data');
    if (hasSavedData) {
      this.showSheet();
    } else {
      this.initializeNewSheet();
      this.showEdit();
      this.buildEditView(true);
      this.save();
    }
  },

  completeTutorial() {
    document.getElementById('tutorial-view').classList.remove('active');
    this.showEdit();

    const isNew = !localStorage.getItem('charactersheet-data');
    if (isNew) {
      this.initializeNewSheet();
    }
    // Start on Profile section for new sheets; preserve current section for returning users
    this.buildEditView(isNew);
    this.save();
  },

  // ==================== VIEW MANAGEMENT ====================

  showEdit() {
    document.getElementById('edit-view').classList.add('active');
    document.getElementById('sheet-view').classList.remove('active');
    document.getElementById('tutorial-view').classList.remove('active');
    document.getElementById('calculating-view').classList.remove('active');
  },

  showSheet() {
    // Reset pre-reveal state for next time
    const animContent = document.getElementById('calc-animation-content');
    const preReveal = document.getElementById('calc-prereveal');
    if (animContent) animContent.style.display = '';
    if (preReveal) preReveal.style.display = 'none';

    document.getElementById('edit-view').classList.remove('active');
    document.getElementById('tutorial-view').classList.remove('active');
    document.getElementById('calculating-view').classList.remove('active');
    document.getElementById('sheet-view').classList.add('active');
    this.renderSheet();
    window.scrollTo(0, 0);
  },

  editSheet() {
    this.showEdit();
    this.buildEditView();
  },

  viewSheet() {
    // Show calculating animation
    this.save();
    document.getElementById('edit-view').classList.remove('active');
    document.getElementById('calculating-view').classList.add('active');

    const steps = ['calc-step-1', 'calc-step-2', 'calc-step-3', 'calc-step-4'];
    let i = 0;

    const showNext = () => {
      if (i < steps.length) {
        const el = document.getElementById(steps[i]);
        el.classList.add('visible');
        if (i > 0) {
          document.getElementById(steps[i-1]).classList.add('done');
        }
        i++;
        setTimeout(showNext, 700);
      } else {
        // All steps done — transition to pre-reveal
        setTimeout(() => {
          steps.forEach(id => {
            const el = document.getElementById(id);
            el.classList.remove('visible', 'done');
          });
          this.showPreReveal();
        }, 600);
      }
    };

    setTimeout(showNext, 300);
  },

  showPreReveal() {
    document.getElementById('calc-animation-content').style.display = 'none';
    document.getElementById('calc-prereveal').style.display = 'block';
  },

  buildEditView(startOnProfile) {
    if (!GLOBAL_STEP_MAP) GLOBAL_STEP_MAP = buildGlobalStepMap();
    if (startOnProfile) {
      currentSection = -1;
      editMode = 'guided'; // New users start in guided mode
    }
    this.renderNav();
    this.renderSections();
    this._updateModeToggle();
  },

  setEditMode(mode) {
    editMode = mode;
    this._updateModeToggle();
    this.renderSections();
    this.scheduleSave();
  },

  _updateModeToggle() {
    const guidedBtn = document.getElementById('mode-btn-guided');
    const quickBtn = document.getElementById('mode-btn-quick');
    if (guidedBtn) guidedBtn.classList.toggle('active', editMode === 'guided');
    if (quickBtn) quickBtn.classList.toggle('active', editMode === 'quick');
  },

  // ==================== PROFILE ====================

  renderProfileSection() {
    const p = state.profile;
    const photoHtml = p.photo
      ? `<img id="profile-img" src="${p.photo}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`
      : `<img id="profile-img" style="display:none;"><div class="profile-photo-placeholder" id="photo-placeholder">+</div>`;
    return `
      <div class="attribute-section" id="section-profile">
        <div class="attribute-section-header">
          <h2>About You</h2>
          <span class="tagline">A few details for your character sheet.</span>
        </div>
        <div class="profile-section-body">
          <div class="profile-photo-wrap">
            <div class="profile-photo" onclick="document.getElementById('photo-input').click()" title="Click to add a photo">
              ${photoHtml}
            </div>
            <div class="profile-photo-hint">Click to add a photo</div>
          </div>
          <div class="profile-fields-grid">
            <div class="profile-field profile-field-wide">
              <label>Name</label>
              <input type="text" id="input-name" placeholder="Your name" value="${escapeHtml(p.name || '')}" oninput="app.updateProfile()">
            </div>
            <div class="profile-field">
              <label>Age <span class="field-optional">(optional)</span></label>
              <input type="number" id="input-age" placeholder="e.g. 34" min="1" max="120" value="${escapeHtml(p.age || '')}" oninput="app.updateProfile()">
            </div>
            <div class="profile-field">
              <label>Gender <span class="field-optional">(optional)</span></label>
              <select id="input-gender" onchange="app.updateProfile()">
                <option value="">Select...</option>
                <option value="male"${p.gender === 'male' ? ' selected' : ''}>Male</option>
                <option value="female"${p.gender === 'female' ? ' selected' : ''}>Female</option>
                <option value="non-binary"${p.gender === 'non-binary' ? ' selected' : ''}>Non-binary</option>
                <option value="other"${p.gender === 'other' ? ' selected' : ''}>Other</option>
                <option value="prefer-not"${p.gender === 'prefer-not' ? ' selected' : ''}>Prefer not to say</option>
              </select>
            </div>
            <div class="profile-field profile-field-wide">
              <label>Occupation <span class="field-optional">(optional)</span></label>
              <input type="text" id="input-occupation" placeholder="e.g. Teacher, Software engineer, Student" value="${escapeHtml(p.occupation || '')}" oninput="app.updateProfile()">
            </div>
            <div class="profile-field">
              <label>Location <span class="field-optional">(optional)</span></label>
              <input type="text" id="input-location" placeholder="e.g. Melbourne" value="${escapeHtml(p.location || '')}" oninput="app.updateProfile()">
            </div>
            <div class="profile-field">
              <label>Relationship <span class="field-optional">(optional)</span></label>
              <select id="input-relationship" onchange="app.updateProfile()">
                <option value="">Select...</option>
                <option value="single"${p.relationship === 'single' ? ' selected' : ''}>Single</option>
                <option value="partnered"${p.relationship === 'partnered' ? ' selected' : ''}>Partnered</option>
                <option value="married"${p.relationship === 'married' ? ' selected' : ''}>Married</option>
                <option value="separated"${p.relationship === 'separated' ? ' selected' : ''}>Separated</option>
                <option value="divorced"${p.relationship === 'divorced' ? ' selected' : ''}>Divorced</option>
                <option value="widowed"${p.relationship === 'widowed' ? ' selected' : ''}>Widowed</option>
                <option value="complicated"${p.relationship === 'complicated' ? ' selected' : ''}>It's complicated</option>
              </select>
            </div>
          </div>
          <div class="sub-step-nav" style="margin-top: 32px;">
            <div></div>
            <button class="btn btn-primary" onclick="app.stepForward()">Next</button>
          </div>
        </div>
      </div>
    `;
  },

  updateProfile() {
    state.profile.name = document.getElementById('input-name')?.value || 'Character';
    state.profile.age = document.getElementById('input-age')?.value || '';
    state.profile.gender = document.getElementById('input-gender')?.value || '';
    state.profile.occupation = document.getElementById('input-occupation')?.value || '';
    state.profile.location = document.getElementById('input-location')?.value || '';
    state.profile.relationship = document.getElementById('input-relationship')?.value || '';
    this.scheduleSave();
  },

  uploadPhoto(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        const MAX = 800;
        let w = img.width, h = img.height;
        if (w > MAX || h > MAX) {
          if (w > h) { h = Math.round(h * MAX / w); w = MAX; }
          else { w = Math.round(w * MAX / h); h = MAX; }
        }
        const canvas = document.createElement('canvas');
        canvas.width = w;
        canvas.height = h;
        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
        state.profile.photo = canvas.toDataURL('image/jpeg', 0.8);
        // Update profile photo in the section without full rebuild
        const profileImgEl = document.getElementById('profile-img');
        const photoPlaceholderEl = document.getElementById('photo-placeholder');
        if (profileImgEl) { profileImgEl.src = state.profile.photo; profileImgEl.style.display = 'block'; }
        if (photoPlaceholderEl) photoPlaceholderEl.style.display = 'none';
        this.autoSave();
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  },

  // ==================== EDIT NAV & SECTIONS ====================

  renderNav() {
    const nav = document.getElementById('section-nav');
    nav.innerHTML =
      `<button data-section="-1" onclick="app.showSection(-1)">Profile</button>` +
      `<button data-section="0" onclick="app.showSection(0)">Personality</button>` +
      ATTRIBUTES.map((attr, i) =>
        `<button data-section="${i + 1}" onclick="app.showSection(${i + 1})" style="--btn-accent: var(--attr-${attr.key})"><span class="nav-attr-dot" style="background: var(--attr-${attr.key})"></span>${attr.name}</button>`
      ).join('') +
      `<button data-section="${ATTRIBUTES.length + 1}" onclick="app.showSection(${ATTRIBUTES.length + 1})">Abilities</button>`;
  },

  renderSections() {
    const container = document.getElementById('sections-container');
    if (editMode === 'quick') {
      container.innerHTML = this.renderProfileSection() +
        this.renderQuickPersonalitySection() +
        ATTRIBUTES.map((attr, i) =>
          this.renderQuickAttributeSection(attr, i + 1)
        ).join('') +
        this.renderAbilitiesSection();
      this.showSection(currentSection);
    } else {
      container.innerHTML = this.renderProfileSection() +
        this.renderPersonalitySection() +
        ATTRIBUTES.map((attr, i) =>
          this.renderAttributeSection(attr, i + 1)
        ).join('') +
        this.renderAbilitiesSection();
      this.showSection(currentSection);
      // Restore non-zero sub-step if returning mid-section
      if (currentSection === 0 && currentBFIStep >= 0) {
        this.showBFIStep(currentBFIStep);
      } else if (currentSection >= 1 && currentSection <= ATTRIBUTES.length && currentSubStep > 0) {
        this.showSubStep(currentSubStep);
      }
    }
  },

  renderAttributeSection(attr, index) {
    // Renders the section shell only. The .attribute-step-content slot is
    // populated by showSubStep() at navigation time. No sub-scores, no
    // main-score-area — scores are revealed only on the character sheet.
    return `
      <div class="attribute-section" id="section-${index}" style="--section-accent: var(--attr-${attr.key})">
        <div class="attribute-section-header">
          <h2>${attr.name}</h2>
          <span class="tagline" id="attr-tagline-${attr.key}">${attr.tagline}</span>
          <span class="step-counter" id="step-counter-${attr.key}"></span>
        </div>
        <div class="attribute-step-content">
          ${this.renderIntroStep(attr, index)}
        </div>
      </div>
    `;
  },

  renderAbilitiesSection() {
    const attrOptions = ATTRIBUTES.map(a => `<option value="${a.key}">${a.name}</option>`).join('');

    const abilities = state.abilities.map((ab, i) => {
      const info = getScoreInfo(ab.score);
      return `
        <div class="ability-card">
          <div class="ability-card-top">
            <input type="text" placeholder="e.g. Piano, Rock climbing, Public speaking" value="${escapeHtml(ab.name)}"
              onchange="app.updateAbility(${i}, 'name', this.value)">
            <div class="ability-controls">
              <button class="status-toggle ${ab.status === 'active' ? 'active' : 'dormant'}"
                onclick="app.toggleAbilityStatus(${i})">
                ${ab.status === 'active' ? 'Active' : 'Dormant'}
              </button>
              <button class="ability-remove" onclick="app.removeAbility(${i})" title="Remove">&times;</button>
            </div>
          </div>
          <div class="ability-score-area">
            <input type="range" min="1" max="20" value="${ab.score}"
              oninput="app.updateAbilityScore(${i}, parseInt(this.value))">
            <div class="ability-score-row">
              <span class="ability-score-value" data-ability-value="${i}" style="color: ${info.color}">${ab.score}</span>
              <span class="ability-score-label" data-ability-label="${i}" style="color: ${info.color}">${info.label}</span>
            </div>
          </div>
          <div class="ability-card-bottom">
            <select onchange="app.updateAbility(${i}, 'linked', this.value)">
              <option value="">Link to an attribute...</option>
              ${attrOptions.replace(`value="${ab.linked}"`, `value="${ab.linked}" selected`)}
            </select>
          </div>
        </div>
      `;
    }).join('');

    return `
      <div class="attribute-section" id="section-${ATTRIBUTES.length + 1}">
        <div class="section-label">Skills & Pursuits</div>
        <h2>Abilities</h2>
        <div class="tagline">The things you can do that make you, you.</div>
        <div class="abilities-intro">
          Abilities are specific things you can do — skills, pursuits, crafts, sports, creative practices. Unlike the eight core attributes, which are broad life dimensions, abilities are concrete and personal. One person's might be piano. Another's might be welding, watercolour, improv comedy, or trail running.
        </div>
        <div class="abilities-examples">
          Examples: Piano &middot; Rock climbing &middot; Public speaking &middot; Photography &middot; Cooking &middot; Coding &middot; Tennis &middot; Meditation &middot; Writing &middot; Languages
        </div>
        <p style="font-size: 14px; color: var(--medium-gray); line-height: 1.6; margin-bottom: 24px;">
          Start with just one or two — you can always add more later. Mark each one <strong>Active</strong> if you're currently practising it, or <strong>Dormant</strong> if it's a skill you have but aren't using right now.
        </p>
        <div class="abilities-list">${abilities}</div>
        <button class="btn btn-secondary btn-small" style="margin-top: 16px" onclick="app.addAbility()">+ Add Ability</button>

        <div class="section-nav-buttons">
          <button class="btn btn-secondary" onclick="app.stepBack()">Previous</button>
          <button class="btn btn-primary" onclick="app.viewSheet()">View My Sheet</button>
        </div>
      </div>
    `;
  },

  renderQuickAttributeSection(attr, index) {
    const mainScore = this.getMainScore(attr.key);
    const info = getScoreInfo(mainScore);
    const ac = `var(--attr-${attr.key})`;

    const subItems = attr.subScores.map(sub => {
      const val = state.subScores[sub.key] || 10;
      const subInfo = getScoreInfo(val);
      // Strip scale anchors — show only the first sentence before <br>
      const shortDesc = sub.desc.split('<br>')[0].trim();
      return `
        <div class="quick-subscore-item">
          <div class="quick-subscore-name">${sub.name}</div>
          <div class="quick-subscore-desc">${shortDesc}</div>
          <div class="quick-subscore-slider-row">
            <input type="range" min="1" max="20" value="${val}"
              data-subkey="${sub.key}"
              oninput="app.updateSubScore('${sub.key}', this.value)">
            <span class="sub-score-value" data-subkey-value="${sub.key}" style="color: ${subInfo.color}">${val}</span>
            <span class="sub-score-label" data-subkey-label="${sub.key}" style="color: ${subInfo.color}">${subInfo.label}</span>
          </div>
        </div>
      `;
    }).join('');

    return `
      <div class="attribute-section" id="section-${index}" style="--section-accent: var(--attr-${attr.key})">
        <div class="attribute-section-header">
          <h2>${attr.name}</h2>
          <span class="tagline">${attr.tagline}</span>
        </div>
        <div id="main-score-${attr.key}" class="main-score-area quick-main-score">
          <div class="score-label">Your ${attr.name} Score</div>
          <div class="score-display" id="score-display-${attr.key}" style="color: ${info.color}">${mainScore}</div>
          <div class="score-meaning" style="color: ${info.color}">${info.label}</div>
          <div class="override-area">
            <button class="override-toggle ${state.overrides[attr.key] ? 'active' : ''}"
              onclick="app.toggleOverride('${attr.key}')">
              ${state.overrides[attr.key] ? 'Override: On' : 'Override: Off'}
            </button>
            ${state.overrides[attr.key] ? `
              <input type="number" min="1" max="20" value="${state.scores[attr.key] || 10}"
                class="main-score-input"
                onchange="app.updateScore('${attr.key}', this.value)">
            ` : ''}
            <span class="indicator">${state.overrides[attr.key] ? 'manual' : 'auto-calculated'}</span>
          </div>
        </div>
        <div class="quick-subscore-list">${subItems}</div>
      </div>
    `;
  },

  renderQuickPersonalitySection() {
    const labels = ['Strongly Disagree', 'Disagree', 'Neutral', 'Agree', 'Strongly Agree'];
    const items = BFI_ITEMS.map((item, i) => {
      const current = state.bfiResponses[i] !== undefined ? state.bfiResponses[i] : 3;
      const buttons = [1, 2, 3, 4, 5].map(val => `
        <button class="bfi-btn${current === val ? ' selected' : ''}"
          data-bfi-item="${i}" data-bfi-val="${val}"
          onclick="app.updateBFI(${i}, ${val})">${labels[val - 1]}</button>
      `).join('');
      return `
        <div class="quick-bfi-item">
          <div class="quick-bfi-question">${item.text}</div>
          <div class="quick-bfi-buttons">${buttons}</div>
        </div>
      `;
    }).join('');

    return `
      <div class="attribute-section" id="section-0">
        <div class="attribute-section-header">
          <h2>Personality</h2>
          <span class="tagline">How you tend to move through the world.</span>
        </div>
        <div class="attribute-description" style="margin-bottom: 20px;">
          Ten short statements rated 1–5. Answer based on how you genuinely see yourself.
        </div>
        <div class="bfi-step-content">
          <div class="quick-bfi-list">${items}</div>
        </div>
      </div>
    `;
  },

  renderPersonalitySection() {
    return `
      <div class="attribute-section" id="section-0">
        <div class="attribute-section-header">
          <h2>Personality</h2>
          <span class="tagline" id="attr-tagline-personality">How you tend to move through the world.</span>
          <span class="step-counter" id="step-counter-personality"></span>
        </div>
        <div class="bfi-step-content">
          ${this.renderBFIIntro()}
        </div>
      </div>
    `;
  },

  renderBFIIntro() {
    return `
      <div class="sub-step-intro">
        <div class="attribute-description">
          Your personality captures your tendencies — not your achievements or values.
          There are no good or bad profiles here. Answer based on how you genuinely see
          yourself, not how you'd like to be. Ten short statements, rated 1–5.
        </div>
        <div class="sub-step-nav">
          <div></div>
          <button class="btn btn-primary" onclick="app.stepForward()">Begin &mdash; 10 questions</button>
        </div>
      </div>
    `;
  },

  renderBFIItem(index) {
    const item = BFI_ITEMS[index];
    const current = state.bfiResponses[index] !== undefined ? state.bfiResponses[index] : 0;
    const labels = ['Strongly Disagree', 'Disagree', 'Neutral', 'Agree', 'Strongly Agree'];
    const buttons = [1, 2, 3, 4, 5].map(val => `
      <button class="bfi-btn${current === val ? ' selected' : ''}"
        onclick="app.updateBFI(${index}, ${val})">
        ${labels[val - 1]}
      </button>
    `).join('');
    return `
      <div class="sub-step-body">
        <div class="sub-step-question-name bfi-question">${item.text}</div>
        <div class="bfi-buttons">${buttons}</div>
        <div class="sub-step-nav">
          <button class="btn btn-secondary" onclick="app.stepBack()">Previous</button>
          <button class="btn btn-primary" onclick="app.stepForward()">Next</button>
        </div>
      </div>
    `;
  },

  showBFIStep(stepIndex) {
    currentBFIStep = stepIndex;
    const content = document.querySelector('#section-0 .bfi-step-content');
    if (!content) return;
    content.classList.remove('stepping');
    void content.offsetWidth;
    content.classList.add('stepping');
    const taglineEl = document.getElementById('attr-tagline-personality');
    const counterEl = document.getElementById('step-counter-personality');
    if (stepIndex === -1) {
      content.innerHTML = this.renderBFIIntro();
      if (taglineEl) taglineEl.style.display = '';
      if (counterEl) counterEl.textContent = '';
    } else {
      content.innerHTML = this.renderBFIItem(stepIndex);
      if (taglineEl) taglineEl.style.display = 'none';
      if (counterEl) counterEl.textContent = `${stepIndex + 1} of ${BFI_ITEMS.length}`;
    }
    this._scrollToSection();
  },

  _scrollToSection() {
    const section = document.querySelector('.attribute-section.active');
    if (!section) return;
    const navEl = document.getElementById('section-nav');
    const navH = navEl ? navEl.offsetHeight + 12 : 60;
    const top = section.getBoundingClientRect().top + window.scrollY - navH;
    window.scrollTo({ top: Math.max(0, top), behavior: 'smooth' });
  },

  _activateSection(index) {
    document.querySelectorAll('.attribute-section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.section-nav button').forEach(b => b.classList.remove('active'));
    const sectionId = index === -1 ? 'section-profile' : `section-${index}`;
    const section = document.getElementById(sectionId);
    if (section) section.classList.add('active');
    const btn = document.querySelector(`.section-nav button[data-section="${index}"]`);
    if (btn) btn.classList.add('active');
    currentSection = index;
  },

  showSection(index) {
    this._activateSection(index);
    currentSubStep = 0;
    if (index === -1) {
      // Profile section — just scroll to it
      this._scrollToSection();
    } else if (index === 0) {
      // Personality section: reset to BFI intro
      currentBFIStep = -1;
      this.showBFIStep(-1);
    } else if (index >= 1 && index <= ATTRIBUTES.length) {
      // Attribute section: render the intro step into the content slot
      this.showSubStep(0);
    } else {
      this._scrollToSection();
    }
  },

  showSubStep(subStepIndex) {
    currentSubStep = subStepIndex;
    const attr = ATTRIBUTES[currentSection - 1];
    if (!attr) return;
    const section = document.getElementById(`section-${currentSection}`);
    if (!section) return;
    const content = section.querySelector('.attribute-step-content');
    if (!content) return;
    // Trigger CSS fade animation
    content.classList.remove('stepping');
    void content.offsetWidth; // force reflow to restart animation
    content.classList.add('stepping');
    const totalSubs = attr.subScores.length;
    const taglineEl = document.getElementById(`attr-tagline-${attr.key}`);
    const counterEl = document.getElementById(`step-counter-${attr.key}`);
    if (subStepIndex === 0) {
      content.innerHTML = this.renderIntroStep(attr, currentSection);
      if (taglineEl) taglineEl.style.display = '';
      if (counterEl) counterEl.textContent = '';
    } else if (subStepIndex <= totalSubs) {
      const sub = attr.subScores[subStepIndex - 1];
      content.innerHTML = this.renderSubScoreStep(attr, sub, subStepIndex, totalSubs);
      if (taglineEl) taglineEl.style.display = 'none';
      if (counterEl) counterEl.textContent = `${subStepIndex} of ${totalSubs}`;
    } else {
      // Score reveal step
      content.innerHTML = this.renderScoreRevealStep(attr);
      if (taglineEl) taglineEl.style.display = 'none';
      if (counterEl) counterEl.textContent = 'Your scores';
    }
    this._scrollToSection();
  },

  renderIntroStep(attr, sectionIndex) {
    const totalSubs = attr.subScores.length;
    const ac = `var(--attr-${attr.key})`;
    const acp = `var(--attr-${attr.key}-pale)`;
    return `
      <div class="sub-step-intro">
        <div class="attribute-description">${attr.description}</div>
        <div class="reflection-prompt" style="background: ${acp}; border-left-color: ${ac}">
          <div class="prompt-label" style="color: ${ac}">Reflect</div>
          <p>${attr.prompt}</p>
        </div>
        <div class="sub-step-nav">
          <button class="btn btn-secondary" onclick="app.stepBack()">Previous</button>
          <button class="btn btn-primary" style="background: ${ac}; border-color: ${ac}" onclick="app.stepForward()">Begin &mdash; ${totalSubs} questions</button>
        </div>
      </div>
    `;
  },

  renderSubScoreStep(attr, sub, stepNumber, totalSubs) {
    const currentVal = state.subScores[sub.key] || 10;
    const info = getScoreInfo(currentVal);
    const ac = `var(--attr-${attr.key})`;
    return `
      <div class="sub-step-body">
        <div class="sub-step-question-name">${sub.name}</div>
        <div class="sub-score-desc">${sub.desc}</div>
        <div class="sub-step-slider-area">
          <input type="range" min="1" max="20" value="${currentVal}"
            data-subkey="${sub.key}"
            oninput="app.updateSubScore('${sub.key}', this.value)">
          <div class="sub-step-value-row">
            <span class="sub-score-value" data-subkey-value="${sub.key}"
              style="color: ${info.color}">${currentVal}</span>
            <span class="sub-score-label" data-subkey-label="${sub.key}"
              style="color: ${info.color}">${info.label}</span>
          </div>
        </div>
        <div class="sub-step-nav">
          <button class="btn btn-secondary" onclick="app.stepBack()">Previous</button>
          <button class="btn btn-primary" style="background: ${ac}; border-color: ${ac}" onclick="app.stepForward()">Next</button>
        </div>
      </div>
    `;
  },

  renderScoreRevealStep(attr) {
    const ac = `var(--attr-${attr.key})`;
    const mainScore = this.getMainScore(attr.key);
    const mainInfo = getScoreInfo(mainScore);

    const subItems = attr.subScores.map(sub => {
      const val = state.subScores[sub.key] || 10;
      const info = getScoreInfo(val);
      return `
        <div class="score-reveal-sub-item">
          <div class="score-reveal-sub-name">${sub.name}</div>
          <div class="score-reveal-sub-right">
            <span class="score-reveal-sub-value" style="color: ${info.color}">${val}</span>
            <span class="score-reveal-sub-label" style="color: ${info.color}">${info.label}</span>
          </div>
        </div>
      `;
    }).join('');

    return `
      <div class="score-reveal-step">
        <div class="score-reveal-main">
          <div class="score-reveal-label">Your ${attr.name} Score</div>
          <div class="score-reveal-number" style="color: ${mainInfo.color}">${mainScore}</div>
          <div class="score-reveal-tier" style="color: ${mainInfo.color}">${mainInfo.label}</div>
        </div>
        <div class="score-reveal-subscores">${subItems}</div>
        <div class="sub-step-nav">
          <button class="btn btn-secondary" onclick="app.stepBack()">Previous</button>
          <button class="btn btn-primary" style="background: ${ac}; border-color: ${ac}" onclick="app.stepForward()">Continue</button>
        </div>
      </div>
    `;
  },

  stepForward() {
    if (currentSection === -1) { this.showSection(0); return; } // Profile -> Personality
    if (currentSection === 0) {
      // BFI navigation
      if (currentBFIStep === -1) { this.showBFIStep(0); return; }
      if (currentBFIStep < BFI_ITEMS.length - 1) { this.showBFIStep(currentBFIStep + 1); return; }
      this.showSection(1); return; // Last BFI item -> Body intro
    }
    if (currentSection === ATTRIBUTES.length + 1) { this.viewSheet(); return; }
    const attr = ATTRIBUTES[currentSection - 1];
    const totalSubs = attr.subScores.length;
    if (currentSubStep < totalSubs) {
      // Advance to next sub-score
      this.showSubStep(currentSubStep + 1);
    } else if (currentSubStep === totalSubs) {
      // Last sub-score done -> show score reveal
      this.showSubStep(totalSubs + 1);
    } else {
      // Past reveal step -> advance to next attribute/section
      this.showSection(currentSection < ATTRIBUTES.length ? currentSection + 1 : ATTRIBUTES.length + 1);
    }
  },

  stepBack() {
    if (currentSection === -1) return; // Profile has no previous
    if (currentSection === 0) {
      // BFI navigation
      if (currentBFIStep > 0) { this.showBFIStep(currentBFIStep - 1); return; }
      if (currentBFIStep === 0) { this.showBFIStep(-1); return; } // back to BFI intro
      this.showSection(-1); return; // BFI intro -> Profile
    }

    if (currentSection === ATTRIBUTES.length + 1) {
      // Abilities -> last attribute's score reveal step
      const lastAttr = ATTRIBUTES[ATTRIBUTES.length - 1];
      this._activateSection(ATTRIBUTES.length);
      this.showSubStep(lastAttr.subScores.length + 1);
      return;
    }

    if (currentSubStep > 0) {
      this.showSubStep(currentSubStep - 1);
    } else {
      if (currentSection === 1) {
        // Body intro -> Personality, land on last BFI item
        this._activateSection(0);
        this.showBFIStep(BFI_ITEMS.length - 1);
      } else {
        // Go to previous attribute's score reveal step
        const prevAttr = ATTRIBUTES[currentSection - 2];
        this._activateSection(currentSection - 1);
        this.showSubStep(prevAttr.subScores.length + 1);
      }
    }
  },

  // ==================== SCORE LOGIC ====================

  getMainScore(attrKey) {
    if (state.overrides[attrKey]) {
      return state.scores[attrKey] || 10;
    }

    const attr = ATTRIBUTES.find(a => a.key === attrKey);
    if (!attr) return 10;

    const values = attr.subScores.map(sub => state.subScores[sub.key] || 10);
    const avg = values.reduce((a, b) => a + b, 0) / values.length;
    return Math.round(avg);
  },

  toggleOverride(attrKey) {
    state.overrides[attrKey] = !state.overrides[attrKey];
    if (!state.overrides[attrKey]) {
      state.scores[attrKey] = this.getMainScore(attrKey);
    }
    this.refreshAttributeMainScore(attrKey);
    this.autoSave();
  },

  refreshAttributeMainScore(attrKey) {
    const attr = ATTRIBUTES.find(a => a.key === attrKey);
    if (!attr) return;
    const mainScore = this.getMainScore(attrKey);
    const info = getScoreInfo(mainScore);
    const scoreArea = document.getElementById(`main-score-${attrKey}`);
    if (scoreArea) {
      scoreArea.innerHTML = `
        <div class="score-label">Your ${attr.name} Score</div>
        <div class="score-display" id="score-display-${attrKey}" style="color: ${info.color}">${mainScore}</div>
        <div class="score-meaning" style="color: ${info.color}">${info.label}</div>
        <div class="override-area">
          <button class="override-toggle ${state.overrides[attrKey] ? 'active' : ''}"
            onclick="app.toggleOverride('${attrKey}')">
            ${state.overrides[attrKey] ? 'Override: On' : 'Override: Off'}
          </button>
          ${state.overrides[attrKey] ? `
            <input type="number" min="1" max="20" value="${state.scores[attrKey] || 10}"
              class="main-score-input"
              onchange="app.updateScore('${attrKey}', this.value)">
          ` : ''}
          <span class="indicator">${state.overrides[attrKey] ? 'manual' : 'auto-calculated from sub-scores'}</span>
        </div>
      `;
    }
  },

  updateScore(attrKey, value) {
    const n = parseInt(value);
    if (isNaN(n)) return;
    state.scores[attrKey] = Math.max(1, Math.min(20, n));
    this.refreshAttributeMainScore(attrKey);
    this.autoSave();
  },

  updateSubScore(subKey, value) {
    state.subScores[subKey] = parseInt(value);
    const info = getScoreInfo(parseInt(value));

    const valueSpan = document.querySelector(`[data-subkey-value="${subKey}"]`);
    if (valueSpan) {
      valueSpan.textContent = value;
      valueSpan.style.color = info.color;
    }

    const labelEl = document.querySelector(`[data-subkey-label="${subKey}"]`);
    if (labelEl) {
      labelEl.textContent = info.label;
      labelEl.style.color = info.color;
    }

    const attr = ATTRIBUTES.find(a => a.subScores.some(s => s.key === subKey));
    if (attr && !state.overrides[attr.key]) {
      state.scores[attr.key] = this.getMainScore(attr.key);
      this.refreshAttributeMainScore(attr.key);
    }

    this.autoSave();
  },

  addAbility() {
    state.abilities.push({ name: '', score: 10, linked: '', status: 'active' });
    this.refreshAbilitiesSection();
    this.autoSave();
  },

  removeAbility(index) {
    state.abilities.splice(index, 1);
    this.refreshAbilitiesSection();
    this.autoSave();
  },

  updateAbility(index, field, value) {
    state.abilities[index][field] = value;
    this.autoSave();
  },

  updateAbilityScore(index, value) {
    state.abilities[index].score = value;
    const info = getScoreInfo(value);
    const valueEl = document.querySelector(`[data-ability-value="${index}"]`);
    const labelEl = document.querySelector(`[data-ability-label="${index}"]`);
    if (valueEl) { valueEl.textContent = value; valueEl.style.color = info.color; }
    if (labelEl) { labelEl.textContent = info.label; labelEl.style.color = info.color; }
    this.autoSave();
  },

  toggleAbilityStatus(index) {
    state.abilities[index].status = state.abilities[index].status === 'active' ? 'dormant' : 'active';
    this.refreshAbilitiesSection();
    this.autoSave();
  },

  refreshAbilitiesSection() {
    const section = document.getElementById(`section-${ATTRIBUTES.length + 1}`);
    if (!section) return;
    const attrOptions = ATTRIBUTES.map(a => `<option value="${a.key}">${a.name}</option>`).join('');
    const abilities = state.abilities.map((ab, i) => {
      const info = getScoreInfo(ab.score);
      return `
        <div class="ability-card">
          <div class="ability-card-top">
            <input type="text" placeholder="e.g. Piano, Rock climbing, Public speaking" value="${escapeHtml(ab.name)}"
              onchange="app.updateAbility(${i}, 'name', this.value)">
            <div class="ability-controls">
              <button class="status-toggle ${ab.status === 'active' ? 'active' : 'dormant'}"
                onclick="app.toggleAbilityStatus(${i})">
                ${ab.status === 'active' ? 'Active' : 'Dormant'}
              </button>
              <button class="ability-remove" onclick="app.removeAbility(${i})" title="Remove">&times;</button>
            </div>
          </div>
          <div class="ability-score-area">
            <input type="range" min="1" max="20" value="${ab.score}"
              oninput="app.updateAbilityScore(${i}, parseInt(this.value))">
            <div class="ability-score-row">
              <span class="ability-score-value" data-ability-value="${i}" style="color: ${info.color}">${ab.score}</span>
              <span class="ability-score-label" data-ability-label="${i}" style="color: ${info.color}">${info.label}</span>
            </div>
          </div>
          <div class="ability-card-bottom">
            <select onchange="app.updateAbility(${i}, 'linked', this.value)">
              <option value="">Link to an attribute...</option>
              ${attrOptions.replace(new RegExp(`value="${ab.linked}"`), `value="${ab.linked}" selected`)}
            </select>
          </div>
        </div>
      `;
    }).join('');
    const abilitiesList = section.querySelector('.abilities-list');
    if (abilitiesList) abilitiesList.innerHTML = abilities;
  },

  updateBFI(index, value) {
    state.bfiResponses[index] = value;
    const content = document.querySelector('#section-0 .bfi-step-content');
    if (content) {
      // Quick mode: buttons have data-bfi-item attributes — only update the clicked row
      const quickButtons = content.querySelectorAll(`.bfi-btn[data-bfi-item="${index}"]`);
      if (quickButtons.length > 0) {
        quickButtons.forEach(btn => {
          btn.classList.toggle('selected', parseInt(btn.dataset.bfiVal) === value);
        });
      } else {
        // Guided mode: all visible buttons belong to the current item
        const buttons = content.querySelectorAll('.bfi-btn');
        buttons.forEach((btn, i) => {
          btn.classList.toggle('selected', i + 1 === value);
        });
      }
    }
    this.autoSave();
  },

  calculateBFIScores() {
    const traits = {};
    Object.keys(TRAIT_INFO).forEach(trait => { traits[trait] = []; });

    BFI_ITEMS.forEach((item, i) => {
      let response = state.bfiResponses[i] || 3;
      if (item.reverse) response = 6 - response;
      traits[item.trait].push(response);
    });

    const scores = {};
    Object.keys(traits).forEach(trait => {
      const mean = traits[trait].reduce((a, b) => a + b, 0) / traits[trait].length;
      scores[trait] = Math.round(mean * 2) / 2;
    });

    return scores;
  },

  // ==================== SHEET RENDERING ====================

  toggleScorePair(el) {
    const pair = el.closest('.score-item-pair');
    if (!pair) { el.classList.toggle('expanded'); return; }
    const items = pair.querySelectorAll('.score-item');
    const willExpand = !el.classList.contains('expanded');
    items.forEach(item => {
      if (willExpand) item.classList.add('expanded');
      else item.classList.remove('expanded');
    });
  },

  renderSheet() {
    this.renderSheetHeader();
    this.renderRadarChart();
    this.renderSheetScores();
    this.renderSheetPersonality();
    this.renderSheetAbilities();
  },

  renderRadarChart() {
    const canvas = document.getElementById('radar-canvas');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const W = 560, H = 440;
    canvas.width = W;
    canvas.height = H;
    const cx = 280, cy = 220;
    const maxR = 148;
    const NODE_R = 6;
    const LABEL_R = 172; // maxR + NODE_R + 18px clearance
    const N = ATTRIBUTES.length;
    const FONT = "-apple-system,BlinkMacSystemFont,'Segoe UI',Arial,sans-serif";

    ctx.clearRect(0, 0, W, H);

    // Angle helpers — start from top (-90°), go clockwise
    const angle = i => (Math.PI * 2 * i / N) - Math.PI / 2;
    const polar = (r, a) => [cx + r * Math.cos(a), cy + r * Math.sin(a)];

    // Score → hex colour (mirrors CSS --color-* variables)
    const scoreHex = s => {
      if (s <= 4)  return '#DC2626';
      if (s <= 7)  return '#EA580C';
      if (s <= 9)  return '#D97706';
      if (s <= 11) return '#9CA3AF';
      if (s <= 13) return '#65A30D';
      if (s <= 15) return '#16A34A';
      if (s <= 17) return '#059669';
      return '#047857';
    };

    // Hex + alpha → rgba string
    const rgba = (hex, a) => {
      const r = parseInt(hex.slice(1,3), 16);
      const g = parseInt(hex.slice(3,5), 16);
      const b = parseInt(hex.slice(5,7), 16);
      return `rgba(${r},${g},${b},${a})`;
    };

    const scores = ATTRIBUTES.map(attr => this.getMainScore(attr.key));

    // ── Octagonal grid rings ──────────────────────────────────────
    [5, 10, 15, 20].forEach(gs => {
      const r = (gs / 20) * maxR;
      ctx.beginPath();
      for (let i = 0; i < N; i++) {
        const [x, y] = polar(r, angle(i));
        i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
      }
      ctx.closePath();
      ctx.strokeStyle = gs === 10 ? 'rgba(0,0,0,0.13)' : 'rgba(0,0,0,0.06)';
      ctx.lineWidth = gs === 10 ? 1.5 : 1;
      ctx.stroke();
    });

    // Scale tick "10" label just inside the average ring on the right spoke
    ctx.fillStyle = 'rgba(0,0,0,0.22)';
    ctx.font = `9px ${FONT}`;
    ctx.textAlign = 'left';
    ctx.textBaseline = 'middle';
    ctx.fillText('10', cx + (10/20)*maxR + 3, cy);

    // ── Neutral axis spokes ───────────────────────────────────────
    for (let i = 0; i < N; i++) {
      const [x, y] = polar(maxR, angle(i));
      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.lineTo(x, y);
      ctx.strokeStyle = 'rgba(0,0,0,0.07)';
      ctx.lineWidth = 1;
      ctx.stroke();
    }

    // ── Data polygon points ───────────────────────────────────────
    const pts = scores.map((s, i) => polar((s / 20) * maxR, angle(i)));

    // ── Per-slice triangle fill — each slice uses its vertex's score colour ──
    for (let i = 0; i < N; i++) {
      const next = (i + 1) % N;
      const col = scoreHex(scores[i]);
      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.lineTo(pts[i][0], pts[i][1]);
      ctx.lineTo(pts[next][0], pts[next][1]);
      ctx.closePath();
      // Gradient from centre (transparent) to vertex (opaque)
      const gr = ctx.createLinearGradient(cx, cy, pts[i][0], pts[i][1]);
      gr.addColorStop(0, rgba(col, 0.03));
      gr.addColorStop(1, rgba(col, 0.30));
      ctx.fillStyle = gr;
      ctx.fill();
    }

    // ── Polygon outline ───────────────────────────────────────────
    ctx.beginPath();
    ctx.moveTo(pts[0][0], pts[0][1]);
    for (const [x, y] of pts) ctx.lineTo(x, y);
    ctx.closePath();
    ctx.strokeStyle = 'rgba(80,80,80,0.22)';
    ctx.lineWidth = 1.5;
    ctx.stroke();

    // ── Vertex dots ───────────────────────────────────────────────
    pts.forEach(([x, y], i) => {
      const col = scoreHex(scores[i]);
      ctx.beginPath();
      ctx.arc(x, y, NODE_R, 0, Math.PI * 2);
      ctx.fillStyle = col;
      ctx.fill();
      ctx.strokeStyle = '#fff';
      ctx.lineWidth = 2;
      ctx.stroke();
    });

    // ── Angle-aware labels (name + score) ─────────────────────────
    ATTRIBUTES.forEach((attr, i) => {
      const a = angle(i);
      const [lx, ly] = polar(LABEL_R, a);
      const cosA = Math.cos(a);
      const sinA = Math.sin(a);
      const col = scoreHex(scores[i]);

      // Horizontal: left-align right-side, right-align left-side, center top/bottom
      if (cosA > 0.2)       ctx.textAlign = 'left';
      else if (cosA < -0.2) ctx.textAlign = 'right';
      else                  ctx.textAlign = 'center';

      // Vertical: stack name above / score below the anchor, centred on it
      const nameY = ly - 9;
      const scoreY = ly + 9;

      ctx.textBaseline = 'alphabetic';
      ctx.fillStyle = 'rgba(74,85,104,0.9)'; // deep-slate
      ctx.font = `bold 11px ${FONT}`;
      ctx.fillText(attr.name, lx, nameY);

      ctx.fillStyle = col;
      ctx.font = `bold 13px ${FONT}`;
      ctx.fillText(scores[i], lx, scoreY);
    });
  },

  renderSheetHeader() {
    document.getElementById('sheet-name').textContent = state.profile.name || 'Character';

    const age = state.profile.age ? `Age ${state.profile.age}` : '';
    const gender = state.profile.gender ? (state.profile.gender.charAt(0).toUpperCase() + state.profile.gender.slice(1)) : '';
    const location = state.profile.location || '';
    const relMap = { single: 'Single', partnered: 'Partnered', married: 'Married',
      separated: 'Separated', divorced: 'Divorced', widowed: 'Widowed', complicated: "It's complicated" };
    const relationship = state.profile.relationship ? (relMap[state.profile.relationship] || state.profile.relationship) : '';
    const date = new Date().toLocaleDateString('en-AU', { year: 'numeric', month: 'long', day: 'numeric' });

    // Occupation shown as its own subtitle element
    const occEl = document.getElementById('sheet-occupation');
    if (occEl) {
      occEl.textContent = state.profile.occupation || '';
      occEl.style.display = state.profile.occupation ? '' : 'none';
    }

    // Meta: age, gender, location, relationship on one line
    const metaParts = [age, gender, location, relationship].filter(Boolean);
    document.getElementById('sheet-meta').innerHTML =
      metaParts.map(m => `<span>${escapeHtml(m)}</span>`).join('') +
      `<span class="sheet-meta-date">${escapeHtml(date)}</span>`;

    const imgEl = document.getElementById('sheet-img');
    const placeholderEl = document.getElementById('sheet-photo-placeholder');

    if (state.profile.photo) {
      imgEl.src = state.profile.photo;
      imgEl.style.display = 'block';
      placeholderEl.style.display = 'none';
    } else {
      imgEl.style.display = 'none';
      // Generate initials from name
      const name = state.profile.name || '';
      const initials = name.trim().split(/\s+/).map(w => w[0]).filter(Boolean).slice(0, 2).join('').toUpperCase();
      placeholderEl.textContent = initials || '?';
      placeholderEl.style.display = 'flex';
    }
  },

  renderSheetScores() {
    const cards = ATTRIBUTES.map(attr => {
      const score = this.getMainScore(attr.key);
      const info = getScoreInfo(score);
      const pct = ((score - 1) / 19) * 100;

      const subBars = attr.subScores.map(sub => {
        const subVal = state.subScores[sub.key] || 10;
        const subInfo = getScoreInfo(subVal);
        const subPct = ((subVal - 1) / 19) * 100;
        return `
          <div class="sub-score-bar-item">
            <div class="sub-score-bar-name">${sub.name}</div>
            <div class="sub-score-bar-value" style="color: ${subInfo.color}">${subVal}</div>
            <div class="sub-bar-track">
              <div class="sub-bar-fill" style="width: ${subPct}%; background: ${subInfo.color}"></div>
            </div>
          </div>
        `;
      }).join('');

      return `
        <div class="score-item" style="border-left-color: var(--attr-${attr.key})" onclick="app.toggleScorePair(this)">
          <div class="score-item-summary">
            <div class="score-item-left">
              <div class="score-item-name">${attr.name}</div>
            </div>
            <div class="score-item-right">
              <div class="score-item-value" style="color: ${info.color}">${score}</div>
              <div class="score-item-label" style="color: ${info.color}">${info.label}</div>
            </div>
          </div>
          <div class="spectrum-bar">
            <div class="spectrum-marker" style="left: ${pct}%; background: ${info.color}"></div>
          </div>
          <div class="score-item-chevron">Sub-scores <span class="chevron-arrow">▾</span></div>
          <div class="score-item-detail">
            <div class="score-item-detail-inner">
              <div class="score-item-detail-desc">${attr.description}</div>
              <div class="score-item-detail-prompt" style="background: var(--attr-${attr.key}-pale); border-left-color: var(--attr-${attr.key})">${attr.prompt}</div>
              ${subBars}
            </div>
          </div>
        </div>
      `;
    });

    // Wrap in pairs so both columns expand/collapse together
    const pairs = [];
    for (let i = 0; i < cards.length; i += 2) {
      pairs.push(`<div class="score-item-pair">${cards.slice(i, i + 2).join('')}</div>`);
    }

    document.getElementById('scores-grid').innerHTML = pairs.join('');
  },

  renderSheetPersonality() {
    const scores = this.calculateBFIScores();
    const traits = ['openness', 'conscientiousness', 'extraversion', 'agreeableness', 'neuroticism'];

    let html = `
      <div class="sheet-section-rule"><span class="sheet-section-rule-text">Personality</span></div>
      <div class="personality-section-subtitle">How you tend to move through the world — tendencies, not achievements</div>
    `;

    const traitBorderColors = {
      openness:          '#93C5FD',
      conscientiousness: '#86EFAC',
      extraversion:      '#C4B5FD',
      agreeableness:     '#FCA5A1',
      neuroticism:       '#FCD34D',
    };

    const shortPhrases = {
      openness:          { low: 'Prefers the familiar',     high: 'Drawn to novelty' },
      conscientiousness: { low: 'Spontaneous & flexible',   high: 'Systematic & focused' },
      extraversion:      { low: 'Prefers quieter settings', high: 'Energised by people' },
      agreeableness:     { low: 'Direct & sceptical',       high: 'Trusting & cooperative' },
      neuroticism:       { low: 'Emotionally steady',       high: 'Feels things deeply' },
    };

    html += traits.map(trait => {
      const score = scores[trait];
      const pct = ((score - 1) / 4) * 100;
      const info = TRAIT_INFO[trait];
      const borderColor = traitBorderColors[trait];
      const phrases = shortPhrases[trait];

      let level;
      if (score <= 2) { level = 'Low'; }
      else if (score <= 3.5) { level = 'Moderate'; }
      else { level = 'High'; }

      const interpretation = score <= 2.5 ? info.low : score >= 3.5 ? info.high : 'Your tendencies fall somewhere between both ends of this dimension.';

      return `
        <div class="big-five-item" style="border-left-color: ${borderColor}">
          <div class="big-five-header">
            <div class="big-five-name">${info.name}</div>
            <div class="big-five-level">${level}</div>
          </div>
          <div class="big-five-desc">${info.desc}</div>
          <div class="big-five-bar-area">
            <div class="big-five-bar-track">
              <div class="big-five-bar-marker" style="left: ${pct}%"></div>
            </div>
            <div class="big-five-bar-labels">
              <span class="big-five-bar-label-low">${phrases.low}</span>
              <span class="big-five-bar-label-high">${phrases.high}</span>
            </div>
          </div>
          <div class="big-five-interpretation">${interpretation}</div>
        </div>
      `;
    }).join('');

    document.getElementById('personality-section-container').innerHTML = html;
  },

  renderSheetAbilities() {
    const valid = state.abilities.filter(a => a.name.trim());
    const container = document.getElementById('sheet-abilities-container');

    if (valid.length === 0) {
      container.style.display = 'none';
      return;
    }

    container.style.display = 'block';

    const active = valid.filter(a => a.status === 'active');
    const dormant = valid.filter(a => a.status === 'dormant');
    const hasBoth = active.length > 0 && dormant.length > 0;

    const renderCard = (ab) => {
      const attr = ATTRIBUTES.find(a => a.key === ab.linked);
      const borderColor = attr ? `var(--attr-${attr.key})` : 'var(--warm-brown)';
      const info = getScoreInfo(ab.score);
      const pct = ((ab.score - 1) / 19) * 100;
      return `
        <div class="ability-card-sheet" style="border-left-color: ${borderColor}">
          <div class="ability-card-sheet-main">
            <div class="ability-card-sheet-name">${escapeHtml(ab.name)}</div>
            ${attr ? `<div class="ability-card-sheet-linked">${escapeHtml(attr.name)}</div>` : ''}
          </div>
          <div class="ability-card-sheet-score-area">
            <div class="ability-card-sheet-spectrum">
              <div class="ability-card-sheet-dot" style="left: ${pct}%; background: ${info.color}"></div>
            </div>
            <div class="ability-card-sheet-score" style="color: ${info.color}">${ab.score}<span class="ability-card-sheet-score-label">${info.label}</span></div>
          </div>
        </div>
      `;
    };

    let html = '';
    if (active.length > 0) {
      if (hasBoth) html += `<div class="ability-group-label">Active</div>`;
      html += active.map(renderCard).join('');
    }
    if (dormant.length > 0) {
      if (hasBoth) html += `<div class="ability-group-label">Dormant</div>`;
      html += dormant.map(renderCard).join('');
    }

    document.getElementById('sheet-abilities').innerHTML = html;
  },

  // ==================== STORAGE ====================

  autoSave() {
    clearTimeout(saveTimeout);
    saveTimeout = setTimeout(() => this.save(), 500);
  },

  save() {
    const data = {
      version: 1,
      profile: state.profile,
      scores: state.scores,
      subScores: state.subScores,
      overrides: state.overrides,
      bfiResponses: state.bfiResponses,
      abilities: state.abilities,
      editMode: editMode
    };
    try {
      localStorage.setItem('charactersheet-data', JSON.stringify(data));
    } catch (e) {
      if (e.name === 'QuotaExceededError' || e.name === 'NS_ERROR_DOM_QUOTA_REACHED') {
        alert('Storage is full. Your changes could not be saved. Try exporting your data and clearing some browser storage.');
      }
    }
  },

  loadFromStorage() {
    const saved = localStorage.getItem('charactersheet-data');
    if (!saved) return;

    let data;
    try {
      data = JSON.parse(saved);
    } catch (e) {
      localStorage.removeItem('charactersheet-data');
      this.initializeNewSheet();
      return;
    }

    state.profile = data.profile || { name: 'Character', age: '', gender: '', occupation: '', location: '', relationship: '', photo: null };
    // Back-fill new fields for existing saves
    if (!state.profile.occupation) state.profile.occupation = '';
    if (!state.profile.location) state.profile.location = '';
    if (!state.profile.relationship) state.profile.relationship = '';
    state.scores = data.scores || {};
    state.subScores = data.subScores || {};
    state.overrides = data.overrides || {};
    state.bfiResponses = data.bfiResponses || {};
    state.abilities = data.abilities || [];
    // Returning users without saved mode preference default to Quick
    editMode = data.editMode !== undefined ? data.editMode : 'quick';

    ATTRIBUTES.forEach(attr => {
      if (!state.scores[attr.key]) state.scores[attr.key] = 10;
      if (!state.overrides[attr.key]) state.overrides[attr.key] = false;
      attr.subScores.forEach(sub => {
        if (!state.subScores[sub.key]) state.subScores[sub.key] = 10;
      });
    });

    BFI_ITEMS.forEach((item, i) => {
      if (!state.bfiResponses[i]) state.bfiResponses[i] = 3;
    });
  },

  exportData() {
    const data = {
      version: 1,
      profile: state.profile,
      scores: state.scores,
      subScores: state.subScores,
      overrides: state.overrides,
      bfiResponses: state.bfiResponses,
      abilities: state.abilities.filter(a => a.name.trim())
    };

    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    const safeName = state.profile.name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '') || 'character';
    a.download = `character-sheet-${safeName}-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
  },

  importData() {
    document.getElementById('import-input').click();
  },

  handleImport(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = JSON.parse(e.target.result);
        state.profile = data.profile || { name: 'Character', age: '', gender: '', occupation: '', location: '', relationship: '', photo: null };
        // Back-fill new fields for older exports
        if (!state.profile.occupation) state.profile.occupation = '';
        if (!state.profile.location) state.profile.location = '';
        if (!state.profile.relationship) state.profile.relationship = '';
        state.scores = data.scores || {};
        state.subScores = data.subScores || {};
        state.overrides = data.overrides || {};
        state.bfiResponses = data.bfiResponses || {};
        state.abilities = data.abilities || [];

        ATTRIBUTES.forEach(attr => {
          if (!state.scores[attr.key]) state.scores[attr.key] = 10;
          if (!state.overrides[attr.key]) state.overrides[attr.key] = false;
          attr.subScores.forEach(sub => {
            if (!state.subScores[sub.key]) state.subScores[sub.key] = 10;
          });
        });

        BFI_ITEMS.forEach((item, i) => {
          if (!state.bfiResponses[i]) state.bfiResponses[i] = 3;
        });

        this.save();
        this.showSheet();
      } catch (err) {
        alert('Could not read file. Please select a valid Character Sheet JSON file.');
      }
    };
    reader.readAsText(file);
    event.target.value = '';
  },

  resetSheet() {
    if (confirm('Reset all data? This cannot be undone.')) {
      localStorage.removeItem('charactersheet-data');
      location.reload();
    }
  },

  // ==================== AI PROMPT MODAL ====================

  generatePromptText() {
    const p = state.profile;
    const bfiScores = this.calculateBFIScores();
    const traits = ['openness', 'conscientiousness', 'extraversion', 'agreeableness', 'neuroticism'];
    const date = new Date().toLocaleDateString('en-AU', { year: 'numeric', month: 'long', day: 'numeric' });

    const bfiLevel = score => score <= 2 ? 'Low' : score <= 3.5 ? 'Moderate' : 'High';
    const bfiInterpret = (trait, score) => {
      const info = TRAIT_INFO[trait];
      if (score <= 2.5) return info.low;
      if (score >= 3.5) return info.high;
      return `Between: ${info.low.toLowerCase()} and ${info.high.toLowerCase()}`;
    };

    const relMap = { single: 'Single', partnered: 'Partnered', married: 'Married',
      separated: 'Separated', divorced: 'Divorced', widowed: 'Widowed', complicated: "It's complicated" };

    const profileParts = [];
    if (p.name && p.name !== 'Character') profileParts.push(`Name: ${p.name}`);
    if (p.age) profileParts.push(`Age: ${p.age}`);
    if (p.gender) profileParts.push(`Gender: ${p.gender.charAt(0).toUpperCase() + p.gender.slice(1)}`);
    if (p.occupation) profileParts.push(`Occupation: ${p.occupation}`);
    if (p.location) profileParts.push(`Location: ${p.location}`);
    if (p.relationship) profileParts.push(`Relationship status: ${relMap[p.relationship] || p.relationship}`);
    profileParts.push(`Sheet completed: ${date}`);

    const attrLines = ATTRIBUTES.map(attr => {
      const mainScore = this.getMainScore(attr.key);
      const mainInfo = getScoreInfo(mainScore);
      const subLines = attr.subScores.map(sub => {
        const subVal = state.subScores[sub.key] || 10;
        const subInfo = getScoreInfo(subVal);
        return `    ${sub.name}: ${subVal}/20 (${subInfo.label})`;
      }).join('\n');
      return `${attr.name}: ${mainScore}/20 (${mainInfo.label})\n${subLines}`;
    }).join('\n\n');

    const personalityLines = traits.map(trait => {
      const score = bfiScores[trait];
      const info = TRAIT_INFO[trait];
      return `${info.name}: ${bfiLevel(score)} (${score.toFixed(1)}/5.0) — ${bfiInterpret(trait, score)}`;
    }).join('\n');

    const validAbilities = state.abilities.filter(a => a.name.trim());
    let abilitiesText = '';
    if (validAbilities.length > 0) {
      const active = validAbilities.filter(a => a.status === 'active');
      const dormant = validAbilities.filter(a => a.status === 'dormant');
      const fmtAbility = ab => {
        const linked = ATTRIBUTES.find(a => a.key === ab.linked)?.name || '';
        const info = getScoreInfo(ab.score);
        return `  ${ab.name}: ${ab.score}/20 (${info.label})${linked ? ` [linked to ${linked}]` : ''}`;
      };
      if (active.length > 0) abilitiesText += `Active abilities:\n${active.map(fmtAbility).join('\n')}`;
      if (dormant.length > 0) {
        if (active.length > 0) abilitiesText += '\n';
        abilitiesText += `Dormant abilities (skills not currently being practised):\n${dormant.map(fmtAbility).join('\n')}`;
      }
    } else {
      abilitiesText = '(No abilities recorded)';
    }

    return `You are about to write a character study — a personal portrait — of a real person based on structured self-reflection data they have gathered about themselves.

The data comes from The Character Sheet, a self-reflection tool that asks people to rate themselves across eight core life attributes, each broken into sub-scores, on a 1–20 scale where 10 is average. The person completed this exercise by themselves, working through guided questions for each dimension of their life. These are not aspirational scores — they are their honest current self-assessment after careful reflection.

The scale used:
1–4 = Critical (in serious difficulty)
5–7 = Struggling (noticeably below where they'd want to be)
8–9 = Below Average (room for significant improvement)
10–11 = Average (where most people land)
12–13 = Above Average (a genuine strength)
14–15 = Strong (going well, and they know it)
16–17 = Excellent (people probably notice)
18–20 = Exceptional (a defining feature of their life)

10 is not a failing grade. Nobody has 20s across the board. These scores represent a moment in time.

---
PROFILE
---
${profileParts.join('\n')}

---
EIGHT CORE ATTRIBUTES (1–20 scale)
---
${attrLines}

---
PERSONALITY (Big Five / OCEAN — 1–5 scale, validated BFI-10 instrument)
---
${personalityLines}

---
ABILITIES
---
${abilitiesText}

---
YOUR TASK
---
Write a rich, honest character study of this person in second person ("you"). This is not a performance review, a therapy session transcript, or a list of recommendations. It is a portrait — the kind a perceptive friend or a sharp biographer might write after spending time with this data.

Guidelines for your response:

Length and structure: Write in flowing prose, not bullet points. Aim for 400–600 words. Use paragraphs to organise ideas, not headers. Begin without preamble — go straight into the portrait.

Voice and tone: Warm but honest. Not cheerleading. Not harsh. The tone of a mentor who respects this person enough to tell them the truth. Avoid flattery. Avoid clinical detachment. Do not hedge everything with "it seems like" or "you may feel" — be direct, while acknowledging the interpretive nature of the exercise.

Use the data seriously: Every attribute and sub-score is a data point. Pay particular attention to gaps and tensions — where high scores in one area coexist with low scores in a related area. These contradictions are often where the most interesting and accurate character observations live.

Connect the dots: Draw connections across domains. Notice what the personality profile implies about how the attribute scores make sense — or don't. Translate the personality data into human language — do not reference trait names or numbers.

Avoid generic observations: Do not write things that could apply to anyone. Ground every sentence in the specific data. The portrait should feel unmistakably about this person, not a template.

Do not moralize or prescribe: Do not tell them what they should do. Do not suggest next steps, goals, or action plans. This is reflection, not coaching.

End with something true: Close with an observation that feels like it captures something essential about who this person is right now — something that stays with them.`;
  },

  showPromptModal() {
    const promptText = this.generatePromptText();
    document.getElementById('prompt-text-display').textContent = promptText;
    document.getElementById('prompt-copy-confirm').classList.remove('visible');
    const modal = document.getElementById('prompt-modal');
    modal.dataset.promptText = promptText;
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
  },

  hidePromptModal() {
    document.getElementById('prompt-modal').classList.remove('active');
    document.body.style.overflow = '';
  },

  handlePromptBackdropClick(event) {
    if (event.target === event.currentTarget) this.hidePromptModal();
  },

  copyPrompt() {
    const modal = document.getElementById('prompt-modal');
    const promptText = modal.dataset.promptText;
    const confirmEl = document.getElementById('prompt-copy-confirm');
    if (!promptText) return;
    const showConfirm = () => {
      confirmEl.classList.add('visible');
      setTimeout(() => confirmEl.classList.remove('visible'), 3000);
    };
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(promptText).then(showConfirm).catch(() => this._copyFallback(promptText, showConfirm));
    } else {
      this._copyFallback(promptText, showConfirm);
    }
  },

  _copyFallback(text, onSuccess) {
    const ta = document.createElement('textarea');
    ta.value = text; ta.style.position = 'fixed'; ta.style.left = '-9999px';
    document.body.appendChild(ta); ta.focus(); ta.select();
    try { document.execCommand('copy'); onSuccess(); } catch(e) {}
    document.body.removeChild(ta);
  }
};

// Initialize
window.addEventListener('load', () => app.init());
</script>

</body>
</html>
