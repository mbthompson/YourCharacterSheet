<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Character Sheet</title>
<style>
  :root {
    --warm-brown: #8B6F47;
    --warm-brown-light: #A68B5B;
    --warm-brown-pale: #F5F0EA;
    --deep-slate: #4A5568;
    --charcoal: #2D2D2D;
    --medium-gray: #666666;
    --light-gray: #999999;
    --very-light-gray: #F7F7F5;
    --border-gray: #E2E0DC;
    --white: #FFFFFF;
    --font-serif: Georgia, 'Times New Roman', serif;
    --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
    --color-critical: #DC2626;
    --color-struggling: #EA580C;
    --color-below: #D97706;
    --color-average: #9CA3AF;
    --color-above: #65A30D;
    --color-strong: #16A34A;
    --color-excellent: #059669;
    --color-exceptional: #047857;
    /* Per-attribute accent colours — muted, distinct hues. Remove these 8 lines to revert all accents to warm-brown. */
    --attr-body:        #7B6B8D;
    --attr-mind:        #4A7C8C;
    --attr-spirit:      #8C6B4A;
    --attr-heart:       #8C4A5A;
    --attr-standing:    #6B7A4A;
    --attr-resilience:  #4A6B7A;
    --attr-discipline:  #5A5A6B;
    --attr-joy:         #8C7A4A;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: var(--font-serif);
    color: var(--charcoal);
    background: var(--very-light-gray);
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
  }

  /* Containers */
  .container {
    max-width: 700px;
    margin: 0 auto;
    padding: 0 20px;
  }

  .container-wide {
    max-width: 900px;
    margin: 0 auto;
    padding: 0 20px;
  }

  /* Views */
  #tutorial-view, #edit-view, #sheet-view, #calculating-view { display: none; }
  #tutorial-view.active, #edit-view.active, #sheet-view.active { display: block; }

  /* ==================== TUTORIAL VIEW ==================== */
  #tutorial-view {
    width: 100%;
    min-height: 100vh;
    background: var(--very-light-gray);
  }

  .tutorial-page {
    width: 100%;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 60px 40px;
    text-align: center;
    background: var(--very-light-gray);
  }

  .tutorial-page-content {
    max-width: 640px;
    width: 100%;
  }

  .tutorial-page h1 {
    font-size: 48px;
    color: var(--charcoal);
    margin-bottom: 12px;
    font-weight: 700;
    letter-spacing: -0.5px;
  }

  .tutorial-page h2 {
    font-size: 36px;
    color: var(--charcoal);
    margin-bottom: 28px;
    font-weight: 700;
  }

  .tutorial-page p {
    font-size: 17px;
    color: var(--medium-gray);
    line-height: 1.8;
    margin-bottom: 18px;
  }

  .tutorial-page p.lead {
    font-size: 19px;
    color: var(--deep-slate);
    line-height: 1.7;
  }

  .tutorial-page ul {
    list-style: none;
    margin: 20px 0;
    text-align: left;
  }

  .tutorial-page li {
    font-size: 15px;
    color: var(--medium-gray);
    line-height: 1.7;
    margin-bottom: 14px;
  }

  .tutorial-subtitle {
    font-size: 19px;
    color: var(--warm-brown);
    font-style: italic;
    margin-bottom: 32px;
  }

  .tutorial-actions {
    display: flex;
    gap: 12px;
    justify-content: center;
    margin-top: 40px;
    flex-wrap: wrap;
  }

  .tutorial-skip-link {
    position: fixed;
    top: 20px;
    right: 20px;
    font-size: 13px;
    color: var(--light-gray);
    text-decoration: none;
    cursor: pointer;
    z-index: 999;
    font-family: var(--font-sans);
    transition: color 0.2s;
  }

  .tutorial-skip-link:hover {
    color: var(--warm-brown);
    text-decoration: underline;
  }

  /* Attribute preview cards in tutorial */
  .attr-preview-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin: 32px 0;
    text-align: left;
  }

  .attr-preview-card {
    background: var(--white);
    border: 1px solid var(--border-gray);
    border-radius: 8px;
    padding: 18px;
  }

  .attr-preview-name {
    font-family: var(--font-sans);
    font-weight: 700;
    font-size: 15px;
    color: var(--charcoal);
    margin-bottom: 4px;
  }

  .attr-preview-tagline {
    font-size: 13px;
    color: var(--warm-brown);
    font-style: italic;
    line-height: 1.5;
  }

  /* Score table in tutorial */
  .score-table {
    width: 100%;
    border-collapse: collapse;
    margin: 28px 0;
    text-align: left;
    font-size: 14px;
  }

  .score-table th {
    background: var(--warm-brown-pale);
    padding: 10px 14px;
    border: 1px solid var(--border-gray);
    font-weight: 600;
    color: var(--charcoal);
    text-align: left;
  }

  .score-table td {
    padding: 10px 14px;
    border: 1px solid var(--border-gray);
    color: var(--medium-gray);
  }

  .score-table tr:nth-child(even) {
    background: var(--white);
  }

  .score-table .score-color {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-right: 6px;
    vertical-align: middle;
  }

  /* Tutorial form inputs */
  .tutorial-form {
    margin: 40px 0;
    text-align: left;
  }

  .tutorial-form label {
    display: block;
    font-family: var(--font-sans);
    font-size: 12px;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: var(--light-gray);
    margin-bottom: 6px;
  }

  .tutorial-form input,
  .tutorial-form select {
    font-family: var(--font-serif);
    font-size: 16px;
    border: 1px solid var(--border-gray);
    padding: 12px;
    border-radius: 4px;
    width: 100%;
    color: var(--charcoal);
    margin-bottom: 16px;
  }

  .tutorial-form input:focus,
  .tutorial-form select:focus {
    outline: none;
    border-color: var(--warm-brown);
  }

  /* ==================== CALCULATING VIEW ==================== */
  #calculating-view.active {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--very-light-gray);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
  }

  .calc-content {
    max-width: 500px;
  }

  .calc-step {
    font-family: var(--font-sans);
    font-size: 16px;
    color: var(--light-gray);
    margin-bottom: 8px;
    opacity: 0;
    transform: translateY(10px);
    transition: opacity 0.5s, transform 0.5s;
  }

  .calc-step.visible {
    opacity: 1;
    transform: translateY(0);
  }

  .calc-step.done {
    color: var(--warm-brown);
  }

  .calc-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--border-gray);
    border-top: 3px solid var(--warm-brown);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 32px auto;
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  /* ==================== BUTTONS ==================== */
  .btn {
    font-family: var(--font-sans);
    font-size: 14px;
    font-weight: 500;
    padding: 12px 32px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-primary {
    background: var(--warm-brown);
    color: var(--white);
  }

  .btn-primary:hover {
    background: var(--warm-brown-light);
  }

  .btn-secondary {
    background: transparent;
    color: var(--warm-brown);
    border: 1.5px solid var(--warm-brown);
  }

  .btn-secondary:hover {
    background: var(--warm-brown-pale);
  }

  .btn-small {
    padding: 8px 20px;
    font-size: 12px;
  }

  .btn-ghost {
    background: transparent;
    color: var(--light-gray);
    border: 1px solid var(--border-gray);
  }

  .btn-ghost:hover {
    color: var(--warm-brown);
    border-color: var(--warm-brown);
  }

  /* ==================== EDIT VIEW ==================== */
  #edit-view {
    padding: 40px 0;
    min-height: 100vh;
  }

  .edit-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 40px;
    padding-bottom: 24px;
    border-bottom: 1px solid var(--border-gray);
    position: sticky;
    top: 0;
    background: var(--very-light-gray);
    z-index: 100;
    padding-top: 10px;
  }

  .edit-header h1 {
    font-size: 24px;
    color: var(--charcoal);
  }

  .edit-header .button-group {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  /* Profile Section */
  .profile-section {
    background: var(--white);
    border: 1px solid var(--border-gray);
    border-radius: 8px;
    padding: 32px;
    margin-bottom: 40px;
    display: grid;
    grid-template-columns: 120px 1fr;
    gap: 32px;
    align-items: start;
  }

  .profile-photo {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    background: var(--very-light-gray);
    border: 2px solid var(--border-gray);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    position: relative;
    overflow: hidden;
  }

  .profile-photo img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
  }

  .profile-photo-placeholder {
    font-size: 40px;
    color: var(--light-gray);
  }

  .profile-photo:hover {
    border-color: var(--warm-brown);
    background: var(--warm-brown-pale);
  }

  #photo-input, #import-input { display: none; }

  .profile-inputs {
    display: grid;
    gap: 16px;
  }

  .profile-inputs label {
    font-family: var(--font-sans);
    font-size: 12px;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: var(--light-gray);
    display: block;
    margin-bottom: 4px;
  }

  .profile-inputs input, .profile-inputs select {
    font-family: var(--font-serif);
    font-size: 16px;
    border: 1px solid var(--border-gray);
    padding: 10px 12px;
    border-radius: 4px;
    color: var(--charcoal);
    outline: none;
    transition: border-color 0.2s;
  }

  .profile-inputs input:focus, .profile-inputs select:focus {
    border-color: var(--warm-brown);
  }

  /* Navigation */
  .section-nav {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 40px;
    padding: 12px 0;
    border-bottom: 1px solid var(--border-gray);
    position: sticky;
    top: 80px;
    background: var(--very-light-gray);
    z-index: 99;
  }

  .section-nav button {
    font-family: var(--font-sans);
    font-size: 13px;
    padding: 8px 16px;
    border: 1px solid var(--border-gray);
    background: var(--white);
    color: var(--medium-gray);
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .section-nav button:hover {
    border-color: var(--warm-brown);
    color: var(--warm-brown);
  }

  .section-nav button.active {
    background: var(--btn-accent, var(--warm-brown));
    color: var(--white);
    border-color: var(--btn-accent, var(--warm-brown));
  }

  /* Attribute Sections */
  .attribute-section {
    background: var(--white);
    border: 1px solid var(--border-gray);
    border-radius: 8px;
    padding: 40px;
    margin-bottom: 40px;
    display: none;
  }

  .attribute-section.active {
    display: block;
    border-left: 4px solid var(--section-accent, var(--warm-brown));
  }

  .attribute-section .section-label {
    font-family: var(--font-sans);
    font-size: 11px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--light-gray);
    margin-bottom: 8px;
  }

  /* .attribute-section h2 and .tagline are now styled inside .attribute-section-header */

  .attribute-description {
    color: var(--medium-gray);
    font-size: 15px;
    line-height: 1.7;
    margin-bottom: 28px;
  }

  .reflection-prompt {
    background: var(--warm-brown-pale);
    border-left: 4px solid var(--warm-brown);
    padding: 16px 20px;
    margin-bottom: 28px;
    border-radius: 0 4px 4px 0;
  }

  .reflection-prompt .prompt-label {
    font-family: var(--font-sans);
    font-size: 11px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--warm-brown);
    margin-bottom: 6px;
  }

  .reflection-prompt p {
    font-style: italic;
    color: var(--medium-gray);
    font-size: 15px;
  }

  /* Main Score */
  .main-score-area {
    background: var(--very-light-gray);
    border-radius: 6px;
    padding: 28px;
    margin-bottom: 32px;
    text-align: center;
  }

  .score-label {
    font-family: var(--font-sans);
    font-size: 11px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--light-gray);
    margin-bottom: 12px;
  }

  .score-display {
    font-size: 56px;
    font-weight: 700;
    color: var(--warm-brown);
    margin-bottom: 4px;
    font-family: var(--font-sans);
  }

  .score-meaning {
    font-family: var(--font-sans);
    font-size: 13px;
    font-weight: 500;
    margin-bottom: 16px;
  }

  .override-area {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    margin-top: 12px;
  }

  .override-toggle {
    font-family: var(--font-sans);
    font-size: 12px;
    padding: 4px 10px;
    background: transparent;
    border: 1px solid var(--border-gray);
    border-radius: 4px;
    cursor: pointer;
    color: var(--medium-gray);
    transition: all 0.2s;
  }

  .override-toggle.active {
    background: var(--warm-brown);
    color: var(--white);
    border-color: var(--warm-brown);
  }

  .main-score-input {
    width: 60px;
    text-align: center;
    font-family: var(--font-sans);
    font-size: 18px;
    font-weight: 700;
    color: var(--warm-brown);
    border: 1px solid var(--border-gray);
    padding: 6px;
    border-radius: 4px;
    outline: none;
  }

  .main-score-input:focus {
    border-color: var(--warm-brown);
  }

  .indicator {
    font-family: var(--font-sans);
    font-size: 11px;
    color: var(--light-gray);
    font-style: italic;
  }

  /* Range sliders */
  input[type="range"] {
    -webkit-appearance: none;
    width: 100%;
    max-width: 400px;
    height: 4px;
    background: var(--border-gray);
    border-radius: 2px;
    outline: none;
    cursor: pointer;
  }

  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 20px;
    height: 20px;
    background: var(--warm-brown);
    border-radius: 50%;
    cursor: pointer;
    transition: transform 0.15s;
  }

  input[type="range"]::-webkit-slider-thumb:hover {
    transform: scale(1.15);
  }

  input[type="range"]::-moz-range-thumb {
    width: 20px;
    height: 20px;
    background: var(--warm-brown);
    border-radius: 50%;
    cursor: pointer;
    border: none;
  }

  /* Sub-scores */
  .sub-scores {
    margin-top: 28px;
    padding-top: 28px;
    border-top: 1px solid var(--border-gray);
  }

  .sub-score-item {
    padding: 18px 0;
    border-bottom: 1px solid var(--border-gray);
  }

  .sub-score-item:last-child { border-bottom: none; }

  .sub-score-name {
    font-family: var(--font-sans);
    font-size: 14px;
    font-weight: 600;
    color: var(--deep-slate);
    margin-bottom: 4px;
  }

  .sub-score-desc {
    font-size: 13px;
    color: var(--light-gray);
    margin-bottom: 10px;
    line-height: 1.5;
  }

  .sub-score-row {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .sub-score-row input[type="range"] {
    max-width: 250px;
    flex: 1;
  }

  .sub-score-value {
    font-family: var(--font-sans);
    font-size: 16px;
    font-weight: 700;
    color: var(--warm-brown);
    min-width: 32px;
    text-align: center;
  }

  .sub-score-label {
    font-family: var(--font-sans);
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    margin-top: 4px;
    min-height: 16px;
  }

  /* Abilities Section */
  .abilities-intro {
    color: var(--medium-gray);
    font-size: 15px;
    line-height: 1.7;
    margin-bottom: 28px;
  }

  .ability-item {
    display: grid;
    grid-template-columns: 1.5fr 70px 120px auto;
    gap: 12px;
    align-items: center;
    padding: 14px 0;
    border-bottom: 1px solid var(--border-gray);
  }

  .ability-item:last-child { border-bottom: none; }

  .ability-item input[type="text"],
  .ability-item input[type="number"],
  .ability-item select {
    font-family: var(--font-serif);
    font-size: 14px;
    border: 1px solid var(--border-gray);
    padding: 8px 10px;
    border-radius: 4px;
    color: var(--charcoal);
    outline: none;
  }

  .ability-item input[type="text"]:focus,
  .ability-item input[type="number"]:focus,
  .ability-item select:focus {
    border-color: var(--warm-brown);
  }

  .ability-item input[type="text"] { font-style: italic; }
  .ability-item input[type="number"] { text-align: center; font-weight: 600; color: var(--warm-brown); }
  .ability-item select { font-size: 13px; color: var(--medium-gray); background: var(--white); }

  .ability-controls {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .status-toggle {
    font-family: var(--font-sans);
    font-size: 11px;
    padding: 4px 8px;
    border-radius: 3px;
    border: 1px solid transparent;
    cursor: pointer;
  }

  .status-toggle.active { background: #E6F4EA; color: #1B7A3D; }
  .status-toggle.dormant { background: #F0F0F0; color: var(--light-gray); }

  .ability-remove {
    font-size: 18px;
    color: var(--light-gray);
    cursor: pointer;
    border: none;
    background: none;
    padding: 4px 8px;
    border-radius: 3px;
  }

  .ability-remove:hover { color: #c53030; background: #FFF5F5; }

  .section-nav-buttons {
    display: flex;
    gap: 12px;
    justify-content: space-between;
    margin-top: 32px;
    padding-top: 28px;
    border-top: 1px solid var(--border-gray);
  }

  /* ==================== GUIDED SUB-STEP LAYOUT ==================== */

  .attribute-section-header {
    display: flex;
    align-items: baseline;
    gap: 12px;
    margin-bottom: 28px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border-gray);
  }

  .attribute-section-header h2 {
    font-size: 17px;
    font-weight: 700;
    color: var(--section-accent, var(--warm-brown));
    margin: 0;
    flex-shrink: 0;
  }

  .attribute-section-header .tagline {
    font-style: italic;
    color: var(--medium-gray);
    font-size: 13px;
    margin: 0;
    flex: 1;
  }

  .step-counter {
    font-family: var(--font-sans);
    font-size: 12px;
    color: var(--light-gray);
    margin-left: auto;
    flex-shrink: 0;
  }

  .attribute-step-content.stepping,
  .bfi-step-content.stepping {
    animation: stepFadeIn 0.25s ease-out;
  }

  @keyframes stepFadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .step-progress {
    font-family: var(--font-sans);
    font-size: 11px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--light-gray);
    margin-bottom: 20px;
  }

  .sub-step-question-name {
    font-family: var(--font-sans);
    font-size: 26px;
    font-weight: 700;
    color: var(--deep-slate);
    margin-bottom: 12px;
  }

  .sub-step-body .sub-score-desc {
    font-size: 15px;
    color: var(--medium-gray);
    line-height: 1.7;
    margin-bottom: 32px;
  }

  .sub-step-slider-area {
    margin-bottom: 36px;
  }

  .sub-step-slider-area input[type="range"] {
    width: 100%;
    max-width: 100%;
    height: 6px;
    margin-bottom: 16px;
  }

  .sub-step-value-row {
    display: flex;
    align-items: baseline;
    gap: 12px;
  }

  .sub-step-value-row .sub-score-value {
    font-size: 40px;
    font-weight: 700;
    font-family: var(--font-sans);
    min-width: 52px;
  }

  .sub-step-value-row .sub-score-label {
    font-size: 16px;
    font-weight: 600;
    letter-spacing: 0.03em;
    text-transform: uppercase;
  }

  .sub-step-nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
    padding-top: 28px;
    border-top: 1px solid var(--border-gray);
    margin-top: 8px;
  }

  /* BFI one-by-one buttons */
  .bfi-buttons {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin: 24px 0 32px;
  }

  .bfi-btn {
    font-family: var(--font-sans);
    font-size: 14px;
    padding: 14px 20px;
    border: 1.5px solid var(--border-gray);
    background: var(--white);
    color: var(--medium-gray);
    border-radius: 6px;
    cursor: pointer;
    text-align: left;
    transition: all 0.15s;
  }

  .bfi-btn:hover {
    border-color: var(--warm-brown);
    color: var(--warm-brown);
  }

  .bfi-btn.selected {
    background: var(--warm-brown);
    color: var(--white);
    border-color: var(--warm-brown);
  }

  .bfi-question {
    font-style: italic;
    font-weight: 600;
    color: var(--deep-slate);
  }

  /* Scale anchors for sub-scale descriptions */
  .scale-anchors {
    font-size: 12px;
    color: var(--light-gray);
    line-height: 1.7;
    display: block;
    margin-top: 12px;
    font-family: var(--font-sans);
  }

  .scale-anchors em {
    font-style: normal;
    font-weight: 600;
    color: var(--medium-gray);
  }

  /* ==================== SHEET VIEW ==================== */
  #sheet-view {
    padding: 60px 0;
    animation: fadeIn 0.6s ease-out;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .sheet-container {
    background: var(--white);
    border-radius: 8px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
    overflow: hidden;
  }

  .sheet-parchment {
    background: linear-gradient(to bottom, #FAFAF8, #F5F0EA);
    padding: 60px;
  }

  .sheet-header {
    text-align: center;
    margin-bottom: 40px;
    padding-bottom: 32px;
    border-bottom: 1px solid var(--border-gray);
  }

  .sheet-profile {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 24px;
  }

  .sheet-photo {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    background: var(--very-light-gray);
    border: 2px solid var(--border-gray);
    margin-bottom: 16px;
    overflow: hidden;
  }

  .sheet-photo img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .sheet-photo-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 40px;
    color: var(--light-gray);
  }

  .sheet-header h1 {
    font-size: 36px;
    color: var(--charcoal);
    margin-bottom: 4px;
  }

  .sheet-meta {
    font-family: var(--font-sans);
    font-size: 13px;
    color: var(--light-gray);
  }

  .sheet-meta span { margin: 0 8px; }

  /* Radar */
  .sheet-radar {
    text-align: center;
    margin-bottom: 48px;
  }

  .sheet-radar canvas {
    max-width: 100%;
    height: auto;
    aspect-ratio: 1;
  }

  /* ==================== SCORE ITEMS (Sheet) ==================== */
  .scores-grid {
    display: grid;
    gap: 8px;
    margin-bottom: 48px;
  }

  .score-item {
    background: var(--very-light-gray);
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
    overflow: hidden;
  }

  .score-item:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  }

  .score-item-summary {
    display: grid;
    grid-template-columns: 130px 50px 1fr;
    gap: 14px;
    align-items: center;
    padding: 14px 18px;
  }

  .score-item-name {
    font-family: var(--font-sans);
    font-size: 14px;
    font-weight: 600;
    color: var(--deep-slate);
  }

  .score-item-value {
    font-family: var(--font-sans);
    font-size: 18px;
    font-weight: 700;
    text-align: center;
  }

  /* Spectrum bar — shows colored zones with a marker */
  .spectrum-bar {
    position: relative;
    height: 8px;
    border-radius: 4px;
    overflow: visible;
    background: linear-gradient(to right,
      var(--color-critical) 0%, var(--color-critical) 20%,
      var(--color-struggling) 20%, var(--color-struggling) 35%,
      var(--color-below) 35%, var(--color-below) 45%,
      var(--color-average) 45%, var(--color-average) 65%,
      var(--color-above) 65%, var(--color-above) 75%,
      var(--color-strong) 75%, var(--color-strong) 85%,
      var(--color-excellent) 85%, var(--color-excellent) 95%,
      var(--color-exceptional) 95%, var(--color-exceptional) 100%
    );
    opacity: 0.25;
  }

  .spectrum-marker {
    position: absolute;
    top: 50%;
    transform: translate(-50%, -50%);
    width: 14px;
    height: 14px;
    border-radius: 50%;
    border: 2.5px solid var(--white);
    box-shadow: 0 1px 4px rgba(0,0,0,0.3);
    transition: left 0.6s ease-out;
  }

  /* Expanded detail */
  .score-item-detail {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s ease-out;
    background: var(--white);
    border-top: 1px solid transparent;
  }

  .score-item.expanded .score-item-detail {
    max-height: 1200px;
    border-top-color: var(--border-gray);
  }

  .score-item-detail-inner {
    padding: 24px;
  }

  .score-item-detail-desc {
    font-size: 14px;
    color: var(--medium-gray);
    line-height: 1.7;
    margin-bottom: 16px;
  }

  .score-item-detail-prompt {
    background: var(--warm-brown-pale);
    border-left: 3px solid var(--warm-brown);
    padding: 12px 16px;
    margin-bottom: 20px;
    border-radius: 0 4px 4px 0;
    font-style: italic;
    font-size: 14px;
    color: var(--medium-gray);
  }

  .sub-score-bar-item {
    display: grid;
    grid-template-columns: 110px 40px 1fr;
    gap: 10px;
    align-items: center;
    margin-bottom: 10px;
  }

  .sub-score-bar-name {
    font-family: var(--font-sans);
    font-size: 12px;
    color: var(--deep-slate);
    font-weight: 500;
    text-align: right;
  }

  .sub-score-bar-value {
    font-family: var(--font-sans);
    font-size: 13px;
    font-weight: 700;
    text-align: center;
  }

  .sub-bar-track {
    height: 6px;
    border-radius: 3px;
    background: var(--border-gray);
    overflow: hidden;
  }

  .sub-bar-fill {
    height: 100%;
    border-radius: 3px;
    transition: width 0.6s ease-out;
  }

  .score-item-expand-hint {
    font-family: var(--font-sans);
    font-size: 11px;
    color: var(--light-gray);
    text-align: right;
    padding: 0 18px 10px;
    transition: opacity 0.2s;
  }

  .score-item.expanded .score-item-expand-hint {
    opacity: 0;
  }

  /* ==================== BIG FIVE (Sheet) ==================== */
  .personality-section {
    margin-bottom: 48px;
  }

  .personality-section-title {
    font-family: var(--font-sans);
    font-size: 12px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--light-gray);
    margin-bottom: 8px;
    text-align: center;
  }

  .personality-section-subtitle {
    font-size: 14px;
    color: var(--medium-gray);
    text-align: center;
    margin-bottom: 24px;
    font-style: italic;
  }

  .big-five-item {
    background: var(--very-light-gray);
    border-radius: 6px;
    padding: 16px 20px;
    margin-bottom: 8px;
  }

  .big-five-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 4px;
  }

  .big-five-name {
    font-family: var(--font-sans);
    font-size: 14px;
    font-weight: 600;
    color: var(--deep-slate);
  }

  .big-five-level {
    font-family: var(--font-sans);
    font-size: 12px;
    font-weight: 600;
  }

  .big-five-desc {
    font-size: 13px;
    color: var(--light-gray);
    margin-bottom: 10px;
    line-height: 1.5;
  }

  .big-five-bar-track {
    height: 6px;
    border-radius: 3px;
    background: var(--border-gray);
    position: relative;
    overflow: visible;
  }

  .big-five-bar-fill {
    height: 100%;
    border-radius: 3px;
    transition: width 0.6s ease-out;
  }

  /* Abilities on Sheet */
  .sheet-abilities {
    margin-bottom: 48px;
  }

  .section-title {
    font-family: var(--font-sans);
    font-size: 12px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--light-gray);
    margin-bottom: 16px;
    text-align: center;
  }

  .abilities-list { display: grid; gap: 6px; }

  .ability-row {
    display: grid;
    grid-template-columns: 1fr 50px 100px 80px;
    gap: 12px;
    align-items: center;
    padding: 10px 16px;
    background: var(--very-light-gray);
    border-radius: 4px;
    font-family: var(--font-sans);
    font-size: 13px;
  }

  .ability-row-name { color: var(--charcoal); font-weight: 500; }
  .ability-row-score { font-weight: 700; text-align: center; }
  .ability-row-linked { color: var(--light-gray); font-size: 12px; }

  .ability-row-status {
    text-align: right;
    font-size: 11px;
    padding: 2px 6px;
    border-radius: 3px;
  }

  .ability-row-status.active { background: #E6F4EA; color: #1B7A3D; }
  .ability-row-status.dormant { background: #F0F0F0; color: var(--light-gray); }

  /* Sheet Footer */
  .sheet-footer {
    text-align: center;
    padding: 40px 0 0;
    border-top: 1px solid var(--border-gray);
    font-style: italic;
    color: var(--light-gray);
    font-size: 14px;
    line-height: 1.7;
  }

  .sheet-actions {
    background: var(--white);
    padding: 24px;
    border-top: 1px solid var(--border-gray);
    display: flex;
    gap: 12px;
    justify-content: center;
    flex-wrap: wrap;
  }

  /* ==================== RESPONSIVE ==================== */
  @media (max-width: 640px) {
    .container { padding: 0 16px; }
    .container-wide { padding: 0 16px; }
    .profile-section { grid-template-columns: 1fr; gap: 24px; }
    .profile-photo { width: 100px; height: 100px; }
    .section-nav { gap: 6px; }
    .section-nav button { font-size: 11px; padding: 6px 12px; }
    .attribute-section { padding: 24px; }
    .ability-item { grid-template-columns: 1fr; gap: 8px; }
    .score-item-summary { grid-template-columns: 100px 40px 1fr; gap: 10px; padding: 12px 14px; }
    .ability-row { grid-template-columns: 1fr 40px 60px; gap: 8px; }
    .sheet-parchment { padding: 32px 20px; }
    .sheet-header h1 { font-size: 28px; }
    .tutorial-page { padding: 40px 20px; }
    .tutorial-page h1 { font-size: 36px; }
    .tutorial-page h2 { font-size: 28px; }
    .attr-preview-grid { grid-template-columns: 1fr; }
    .sub-score-bar-item { grid-template-columns: 90px 30px 1fr; }
    .big-five-item { padding: 14px 16px; }
    .sub-step-value-row .sub-score-value { font-size: 32px; }
    .sub-step-question-name { font-size: 18px; }
  }

  /* ==================== PRINT ==================== */
  @media print {
    body { background: white; }
    #edit-view, #tutorial-view, #calculating-view, .edit-header, .sheet-actions, .btn, .tutorial-skip-link { display: none !important; }
    .sheet-container { box-shadow: none; }
    .sheet-parchment { padding: 40px; }
    .score-item-detail { max-height: none !important; }
  }
</style>
</head>
<body>

<!-- TUTORIAL VIEW -->
<div id="tutorial-view">
  <a class="tutorial-skip-link" onclick="app.skipTutorial()">Skip to my sheet</a>
  <div id="tutorial-pages-container"></div>
</div>

<!-- CALCULATING VIEW -->
<div id="calculating-view">
  <div class="calc-content">
    <div class="calc-spinner"></div>
    <div class="calc-step" id="calc-step-1">Compiling your responses...</div>
    <div class="calc-step" id="calc-step-2">Calculating attribute scores...</div>
    <div class="calc-step" id="calc-step-3">Analysing personality profile...</div>
    <div class="calc-step" id="calc-step-4">Generating your character sheet...</div>
  </div>
</div>

<!-- EDIT VIEW -->
<div id="edit-view">
  <div class="container-wide">
    <div class="edit-header">
      <h1>Character Sheet</h1>
      <div class="button-group">
        <button class="btn btn-primary btn-small" onclick="app.viewSheet()">View Sheet</button>
        <button class="btn btn-ghost btn-small" onclick="app.exportData()">Export</button>
        <button class="btn btn-ghost btn-small" onclick="app.importData()">Import</button>
        <button class="btn btn-ghost btn-small" onclick="app.showTutorial()">Guide</button>
      </div>
    </div>

    <!-- Profile -->
    <div class="profile-section">
      <div class="profile-photo" onclick="document.getElementById('photo-input').click()">
        <img id="profile-img" style="display: none;">
        <div class="profile-photo-placeholder" id="photo-placeholder">+</div>
      </div>
      <div class="profile-inputs">
        <div>
          <label>Name</label>
          <input type="text" id="input-name" placeholder="Your name" onchange="app.updateProfile()">
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
          <div>
            <label>Age</label>
            <input type="number" id="input-age" placeholder="Age" onchange="app.updateProfile()">
          </div>
          <div>
            <label>Gender</label>
            <select id="input-gender" onchange="app.updateProfile()">
              <option value="">Select...</option>
              <option value="male">Male</option>
              <option value="female">Female</option>
              <option value="non-binary">Non-binary</option>
              <option value="other">Other</option>
              <option value="prefer-not">Prefer not to say</option>
            </select>
          </div>
        </div>
      </div>
    </div>
    <input type="file" id="photo-input" accept="image/*" onchange="app.uploadPhoto(event)">
    <input type="file" id="import-input" accept=".json" style="display:none" onchange="app.handleImport(event)">

    <!-- Navigation -->
    <div class="section-nav" id="section-nav"></div>

    <!-- Sections Container -->
    <div id="sections-container"></div>
  </div>
</div>

<!-- SHEET VIEW -->
<div id="sheet-view">
  <div class="container">
    <div class="sheet-container">
      <div class="sheet-parchment">
        <div class="sheet-header">
          <div class="sheet-profile">
            <div class="sheet-photo">
              <img id="sheet-img" style="display: none;">
              <div class="sheet-photo-placeholder" id="sheet-photo-placeholder">+</div>
            </div>
            <h1 id="sheet-name">Character</h1>
            <div class="sheet-meta" id="sheet-meta"></div>
          </div>
        </div>

        <div class="sheet-radar">
          <canvas id="radarChart"></canvas>
        </div>

        <div class="scores-grid" id="scores-grid"></div>

        <div class="personality-section" id="personality-section-container"></div>

        <div class="sheet-abilities" id="sheet-abilities-container">
          <label class="section-title">Abilities</label>
          <div class="abilities-list" id="sheet-abilities"></div>
        </div>

        <div class="sheet-footer">
          The game continues. It always does.<br>
          But now, at least, you've seen your character sheet.
        </div>
      </div>
    </div>

    <div class="sheet-actions">
      <button class="btn btn-secondary btn-small" onclick="app.editSheet()">Edit</button>
      <button class="btn btn-ghost btn-small" onclick="app.exportData()">Export</button>
      <button class="btn btn-ghost btn-small" onclick="app.importData()">Import</button>
      <button class="btn btn-ghost btn-small" onclick="app.showTutorial()">Guide</button>
      <button class="btn btn-ghost btn-small" onclick="window.print()">Print</button>
    </div>
  </div>
</div>

<script>
// ==================== DATA ====================

const ATTRIBUTES = [
  {
    key: 'body', name: 'Body', tagline: 'Your physical self — health, capability, and energy.',
    description: 'Your Body score reflects the overall state of your physical existence. It\'s not about how you look. It\'s about how your body serves you: whether it\'s healthy, capable, energetic, and well-rested.',
    prompt: 'If a doctor who knew everything about my physical state gave me an honest rating, what would they say?',
    subScores: [
      { key: 'health', name: 'Health', desc: 'Considers chronic conditions, illness, injury history, and current health status. Not about perfection — about how your body is actually functioning day to day.<br><br><span class="scale-anchors"><em>1–4:</em> Managing serious illness, chronic pain, or frequent health crises &nbsp;·&nbsp; <em>9–12:</em> Generally healthy; minor issues managed, no major limitations &nbsp;·&nbsp; <em>18–20:</em> Excellent health across the board; rarely sick, conditions well-controlled or absent</span>' },
      { key: 'strength', name: 'Strength', desc: 'Physical capacity — lifting, carrying, pushing. Not about being an athlete; about whether your body can handle the physical demands of your actual life.<br><br><span class="scale-anchors"><em>1–4:</em> Significant physical weakness; struggle with ordinary tasks &nbsp;·&nbsp; <em>9–12:</em> Average capability; can handle everyday physical demands &nbsp;·&nbsp; <em>18–20:</em> Noticeably strong; physical capability is a genuine asset</span>' },
      { key: 'agility', name: 'Agility', desc: 'Flexibility, coordination, balance, and ease of movement. Declines quietly with age and inactivity — most people only notice when they lose it.<br><br><span class="scale-anchors"><em>1–4:</em> Stiff, uncoordinated, or at meaningful injury risk &nbsp;·&nbsp; <em>9–12:</em> Adequate mobility; can move through daily life without issue &nbsp;·&nbsp; <em>18–20:</em> Excellent flexibility and coordination; fluid, controlled movement</span>' },
      { key: 'stamina', name: 'Stamina', desc: 'Cardiovascular fitness. How long your body can sustain effort — walking, climbing stairs, running for a bus.<br><br><span class="scale-anchors"><em>1–4:</em> Breathless after light activity; cardiovascular fitness is poor &nbsp;·&nbsp; <em>9–12:</em> Reasonable fitness; can handle moderate sustained effort &nbsp;·&nbsp; <em>18–20:</em> Strong endurance; sustained physical effort feels comfortable</span>' },
      { key: 'vitality', name: 'Vitality', desc: 'Your energy across the day — not just morning freshness, but sustained capacity. A leading indicator of overall health and lifestyle.<br><br><span class="scale-anchors"><em>1–4:</em> Chronically exhausted; energy is a daily struggle &nbsp;·&nbsp; <em>9–12:</em> Adequate energy for normal demands; some afternoon tiredness &nbsp;·&nbsp; <em>18–20:</em> Consistently high energy throughout the day; feels alive and ready</span>' },
      { key: 'rest', name: 'Rest', desc: 'Quality and quantity of sleep, plus recovery from exertion. The foundation everything else rests on.<br><br><span class="scale-anchors"><em>1–4:</em> Chronically sleep-deprived or very poor sleep quality &nbsp;·&nbsp; <em>9–12:</em> Generally adequate sleep; occasional poor nights &nbsp;·&nbsp; <em>18–20:</em> Excellent sleep consistently; wake refreshed; recover well from effort</span>' },
    ]
  },
  {
    key: 'mind', name: 'Mind', tagline: 'Your mental life — clarity, emotional health, and intellectual engagement.',
    description: 'Your Mind score captures how well your inner world is functioning. A high Mind score doesn\'t mean you\'re a genius — it means your mental life is healthy, active, and well-managed.',
    prompt: 'How is my inner world? Is it a place of clarity and growth, or confusion and distress?',
    subScores: [
      { key: 'mental_health', name: 'Mental Health', desc: 'Freedom from significant depression, anxiety, or other psychological conditions — and if present, how well they are managed.<br><br><span class="scale-anchors"><em>1–4:</em> Significant symptoms affecting daily function &nbsp;·&nbsp; <em>9–12:</em> Mostly okay; manageable stress and occasional low periods &nbsp;·&nbsp; <em>18–20:</em> Genuinely good psychological health; stable, rarely overwhelmed</span>' },
      { key: 'clarity', name: 'Clarity', desc: 'The quality of your thinking — focused, decisive, unfogged. Affected by sleep, stress, diet, and exercise more than people realise.<br><br><span class="scale-anchors"><em>1–4:</em> Persistent mental fog; difficulty focusing or making decisions &nbsp;·&nbsp; <em>9–12:</em> Generally clear-headed; normal concentration with effort &nbsp;·&nbsp; <em>18–20:</em> Sharp, focused, decisive; thinking feels clean and efficient</span>' },
      { key: 'emotional_regulation', name: 'Emotional Regulation', desc: 'How well you manage your emotional responses — not suppression, but the ability to feel without being hijacked.<br><br><span class="scale-anchors"><em>1–4:</em> Frequently overwhelmed, reactive, or emotionally chaotic &nbsp;·&nbsp; <em>9–12:</em> Mostly regulated; can manage everyday emotional demands &nbsp;·&nbsp; <em>18–20:</em> Excellent emotional control; responds rather than reacts; calm under pressure</span>' },
      { key: 'learning', name: 'Learning', desc: 'Active intellectual growth. Are you currently expanding what you know and can do?<br><br><span class="scale-anchors"><em>1–4:</em> Little or no intellectual engagement; growth has stalled &nbsp;·&nbsp; <em>9–12:</em> Some learning happening; occasional reading or skill development &nbsp;·&nbsp; <em>18–20:</em> Consistently and actively learning; growth is a regular part of life</span>' },
      { key: 'creativity', name: 'Creativity', desc: 'The expression of ideas, making of things, or novel problem-solving. Not just art — any domain where you generate rather than consume.<br><br><span class="scale-anchors"><em>1–4:</em> Little to no creative activity or expression &nbsp;·&nbsp; <em>9–12:</em> Occasional creativity; some projects or ideas pursued &nbsp;·&nbsp; <em>18–20:</em> Highly creative output; making and generating is a significant part of life</span>' },
    ]
  },
  {
    key: 'spirit', name: 'Spirit', tagline: 'Your relationship with meaning, purpose, and your own character.',
    description: 'Spirit reflects whether you feel your life has direction and meaning, whether you live with integrity, and whether you\'ve made peace with being the person you are. This isn\'t necessarily about religion — it\'s about the foundational questions.',
    prompt: 'Do I feel like my life means something? Am I at peace with who I am?',
    subScores: [
      { key: 'purpose', name: 'Purpose', desc: 'A felt sense that your life has direction — that you\'re working toward something that matters. Not necessarily a grand mission; even a clear personal north star counts.<br><br><span class="scale-anchors"><em>1–4:</em> Drifting; no clear sense of direction or what matters &nbsp;·&nbsp; <em>9–12:</em> Some sense of purpose; direction exists but may be vague &nbsp;·&nbsp; <em>18–20:</em> Clear, felt purpose; daily life connects to something meaningful</span>' },
      { key: 'integrity', name: 'Integrity', desc: 'Living in alignment with your values. The gap between what you say you believe and how you actually behave.<br><br><span class="scale-anchors"><em>1–4:</em> Significant gap between stated values and actual behaviour &nbsp;·&nbsp; <em>9–12:</em> Mostly aligned; occasional compromises &nbsp;·&nbsp; <em>18–20:</em> High integrity; actions consistently reflect values; little internal conflict</span>' },
      { key: 'self_acceptance', name: 'Self-Acceptance', desc: 'How you relate to your own flaws, failures, and limitations — with harshness or with honest compassion.<br><br><span class="scale-anchors"><em>1–4:</em> Harsh self-critic; significant shame or self-rejection &nbsp;·&nbsp; <em>9–12:</em> Generally okay with yourself; some areas of self-criticism &nbsp;·&nbsp; <em>18–20:</em> Genuine self-acceptance; owns flaws without being defined by them</span>' },
      { key: 'gratitude', name: 'Gratitude', desc: 'The ability to notice and appreciate what\'s good, without pretending the bad doesn\'t exist.<br><br><span class="scale-anchors"><em>1–4:</em> Predominantly focused on lack, complaint, or what\'s missing &nbsp;·&nbsp; <em>9–12:</em> Moderate appreciation; gratitude present but inconsistent &nbsp;·&nbsp; <em>18–20:</em> Regularly notices and savours what\'s good; genuine thankfulness</span>' },
      { key: 'practice', name: 'Practice', desc: 'A regular discipline that nourishes the spirit — meditation, prayer, journalling, time in nature, whatever grounds you.<br><br><span class="scale-anchors"><em>1–4:</em> No regular practice; inner life left to chance &nbsp;·&nbsp; <em>9–12:</em> Some practice; irregular or just beginning &nbsp;·&nbsp; <em>18–20:</em> Consistent and meaningful practice; a genuine anchor in daily life</span>' },
    ]
  },
  {
    key: 'heart', name: 'Heart', tagline: 'Your connections — love, belonging, and generosity.',
    description: 'Heart captures the relational dimension of your life. The quality of our relationships is one of the strongest predictors of both happiness and longevity. Are you loved? Do you love? Are you connected?',
    prompt: 'If I needed help at 3am, who would I call? How long is that list? And would I answer their call?',
    subScores: [
      { key: 'partner', name: 'Partner', desc: 'Quality and satisfaction in your romantic relationship — or, if single, your peace and acceptance of that. Rate this in terms of love, trust, and connection, not just whether a relationship exists.<br><br><span class="scale-anchors"><em>1–4:</em> In a deeply unhappy relationship, or painfully struggling with being single &nbsp;·&nbsp; <em>9–12:</em> Relationship is okay or singleness is manageable &nbsp;·&nbsp; <em>18–20:</em> Deeply loving, trusting relationship — or fully at peace and content as single</span>' },
      { key: 'family', name: 'Family', desc: 'The quality of your family relationships — parents, siblings, children. Warmth, closeness, and support — not obligation or surface contact.<br><br><span class="scale-anchors"><em>1–4:</em> Family relationships are painful, estranged, or a significant source of distress &nbsp;·&nbsp; <em>9–12:</em> Adequate family connection; some warmth with some distance or tension &nbsp;·&nbsp; <em>18–20:</em> Close, warm, and genuinely supportive family relationships</span>' },
      { key: 'friendships', name: 'Friendships', desc: 'Real friendships — people who know you, who you\'d call in a crisis, who are genuinely in your life. Not followers or acquaintances.<br><br><span class="scale-anchors"><em>1–4:</em> Few or no close friends; significant loneliness &nbsp;·&nbsp; <em>9–12:</em> A small circle; some real connection &nbsp;·&nbsp; <em>18–20:</em> Rich friendships; genuinely known and loved by people you care about</span>' },
      { key: 'community', name: 'Community', desc: 'Belonging to something beyond your immediate circle — a neighbourhood, a group, a cause, a shared identity.<br><br><span class="scale-anchors"><em>1–4:</em> No real sense of belonging beyond immediate family &nbsp;·&nbsp; <em>9–12:</em> Some community connection; occasional participation &nbsp;·&nbsp; <em>18–20:</em> Strong sense of belonging; active, valued member of a community</span>' },
      { key: 'giving', name: 'Giving', desc: 'The role generosity, charity, and service to others play in your life.<br><br><span class="scale-anchors"><em>1–4:</em> Little or no giving; self-focused by default &nbsp;·&nbsp; <em>9–12:</em> Some giving; charitable when prompted &nbsp;·&nbsp; <em>18–20:</em> Generosity is a core part of your life; giving of time, money, or effort is regular and meaningful</span>' },
    ]
  },
  {
    key: 'standing', name: 'Standing', tagline: 'Your place in the world — career, wealth, reputation, and home.',
    description: 'Standing reflects how the external world sees you and what you\'ve built in material terms. It\'s not about vanity — it\'s about recognising that these things affect your quality of life.',
    prompt: 'Would I be comfortable if a journalist profiled my life? Not because it\'s impressive — but because it\'s solid?',
    subScores: [
      { key: 'career', name: 'Career', desc: 'Satisfaction, engagement, and progression in your professional life. Not just income — fulfilment, direction, and whether your work feels worthwhile.<br><br><span class="scale-anchors"><em>1–4:</em> Deeply dissatisfied, stalled, or in the wrong role &nbsp;·&nbsp; <em>9–12:</em> Job is okay; adequate but not inspiring &nbsp;·&nbsp; <em>18–20:</em> Genuinely engaged and progressing; work feels meaningful and directional</span>' },
      { key: 'wealth', name: 'Wealth', desc: 'Your net financial position, financial security, and trajectory — not just income. Are you building or eroding?<br><br><span class="scale-anchors"><em>1–4:</em> In financial distress; debt, insecurity, or significant instability &nbsp;·&nbsp; <em>9–12:</em> Financially stable; covering needs with some margin &nbsp;·&nbsp; <em>18–20:</em> Genuinely financially secure; building wealth; money is not a source of anxiety</span>' },
      { key: 'reputation', name: 'Reputation', desc: 'How others — professionally and personally — perceive and talk about you. Are you trusted and respected?<br><br><span class="scale-anchors"><em>1–4:</em> Reputation is damaged, unclear, or a source of concern &nbsp;·&nbsp; <em>9–12:</em> Reasonably regarded; not notable in either direction &nbsp;·&nbsp; <em>18–20:</em> Genuinely respected; trusted, well-regarded in your field or community</span>' },
      { key: 'home', name: 'Home', desc: 'The quality, comfort, and security of your living situation. Does where you live support or undermine your life?<br><br><span class="scale-anchors"><em>1–4:</em> Home situation is poor, precarious, or a source of significant stress &nbsp;·&nbsp; <em>9–12:</em> Adequate home; comfortable enough &nbsp;·&nbsp; <em>18–20:</em> Home feels like a genuine haven; safe, comfortable, and yours</span>' },
    ]
  },
  {
    key: 'resilience', name: 'Resilience', tagline: 'Your capacity to withstand adversity and recover from setbacks.',
    description: 'Resilience only reveals itself under pressure. You might think yours is high when life is calm — but you don\'t really know until something goes wrong. Look at the evidence.',
    prompt: 'Think about the last truly difficult thing that happened. How did you handle it? What does that tell you?',
    subScores: [
      { key: 'adversity_tolerance', name: 'Adversity Tolerance', desc: 'How well you hold up when things go wrong — your capacity to function under difficulty without collapsing.<br><br><span class="scale-anchors"><em>1–4:</em> Falls apart under moderate pressure; adversity is destabilising &nbsp;·&nbsp; <em>9–12:</em> Manages most difficulties adequately; struggles with major ones &nbsp;·&nbsp; <em>18–20:</em> Remains functional and even-keeled under significant adversity</span>' },
      { key: 'recovery', name: 'Recovery', desc: 'How quickly and fully you bounce back after setbacks, disappointments, or failures.<br><br><span class="scale-anchors"><em>1–4:</em> Takes a very long time to recover; setbacks leave lasting marks &nbsp;·&nbsp; <em>9–12:</em> Recovers at a normal rate; some things linger longer than they should &nbsp;·&nbsp; <em>18–20:</em> Bounces back quickly and fully; rarely carries forward the weight of past setbacks</span>' },
      { key: 'adaptability', name: 'Adaptability', desc: 'Your ability to change course when circumstances change — to pivot, adjust, and thrive in new conditions.<br><br><span class="scale-anchors"><em>1–4:</em> Struggles significantly with change; rigidity under uncertainty &nbsp;·&nbsp; <em>9–12:</em> Adapts adequately to most changes with some effort &nbsp;·&nbsp; <em>18–20:</em> Highly adaptable; change is handled with flexibility and composure</span>' },
      { key: 'grit', name: 'Grit', desc: 'Sustained effort toward long-term goals despite obstacles, boredom, and setbacks. Not intensity — consistency over time.<br><br><span class="scale-anchors"><em>1–4:</em> Gives up easily when things get hard or boring &nbsp;·&nbsp; <em>9–12:</em> Persists through most challenges but wavers under sustained difficulty &nbsp;·&nbsp; <em>18–20:</em> Remarkable persistence; continues working toward goals even through extended hardship</span>' },
    ]
  },
  {
    key: 'discipline', name: 'Discipline', tagline: 'Your ability to do what you intend to do.',
    description: 'Discipline is the engine that turns intention into action. It\'s about the gap between what you plan to do and what you actually do. The most honest stat on the sheet.',
    prompt: 'If I made a list of everything I said I\'d do this month, what percentage did I actually do?',
    subScores: [
      { key: 'habits', name: 'Habits', desc: 'The quality and consistency of your daily routines — the things you do automatically that shape your life.<br><br><span class="scale-anchors"><em>1–4:</em> Few or no consistent habits; daily structure is largely absent &nbsp;·&nbsp; <em>9–12:</em> Some habits; inconsistent maintenance &nbsp;·&nbsp; <em>18–20:</em> Strong, consistent habits; daily routines are a genuine asset</span>' },
      { key: 'follow_through', name: 'Follow-Through', desc: 'Whether you actually finish what you start and keep the commitments you make — to yourself and others.<br><br><span class="scale-anchors"><em>1–4:</em> Regularly fails to follow through; commitments are unreliable &nbsp;·&nbsp; <em>9–12:</em> Generally follows through on commitments; some things slip &nbsp;·&nbsp; <em>18–20:</em> Highly reliable; finishes what is started; word is trusted</span>' },
      { key: 'impulse_control', name: 'Impulse Control', desc: 'Your capacity to resist short-term temptation in service of long-term goals.<br><br><span class="scale-anchors"><em>1–4:</em> Frequently acts on impulse; short-term wins over long-term routinely &nbsp;·&nbsp; <em>9–12:</em> Reasonable self-control in most situations; some weaknesses &nbsp;·&nbsp; <em>18–20:</em> Strong impulse control; consistently chooses long-term over short-term</span>' },
      { key: 'time_management', name: 'Time Management', desc: 'How well you use your hours — planning, prioritising, and following through on how you intended to spend your time.<br><br><span class="scale-anchors"><em>1–4:</em> Time feels chaotic and uncontrolled; days slip by without intention &nbsp;·&nbsp; <em>9–12:</em> Adequate time management; broadly purposeful but some waste &nbsp;·&nbsp; <em>18–20:</em> Excellent use of time; hours are used deliberately and productively</span>' },
    ]
  },
  {
    key: 'joy', name: 'Joy', tagline: 'Whether you\'re actually enjoying your life.',
    description: 'Joy is the attribute most people forget to check. You can be healthy, successful, disciplined, and loved — and still not be having a good time. Are you enjoying this?',
    prompt: 'When did I last feel genuinely delighted? How long ago was that? And what does that tell me?',
    subScores: [
      { key: 'pleasure', name: 'Pleasure', desc: 'Enjoyment of simple sensory pleasures — food, music, beauty, comfort. Are your senses alive to the world?<br><br><span class="scale-anchors"><em>1–4:</em> Little pleasure in daily experience; senses feel dull or muted &nbsp;·&nbsp; <em>9–12:</em> Enjoys some pleasures regularly; nothing remarkable &nbsp;·&nbsp; <em>18–20:</em> Richly alive to simple pleasures; everyday experience is a source of genuine enjoyment</span>' },
      { key: 'play', name: 'Play', desc: 'Whether fun and play have a genuine place in your life — things done purely for enjoyment, with no goal but the thing itself.<br><br><span class="scale-anchors"><em>1–4:</em> Little to no play; life is all responsibility and no fun &nbsp;·&nbsp; <em>9–12:</em> Some fun; occasional play, though often edged out by obligations &nbsp;·&nbsp; <em>18–20:</em> Play is a genuine and regular part of life; you have real fun, regularly</span>' },
      { key: 'humour', name: 'Humour', desc: 'Whether laughter, lightness, and absurdity have a place in your daily life.<br><br><span class="scale-anchors"><em>1–4:</em> Life feels heavy; little laughter or levity &nbsp;·&nbsp; <em>9–12:</em> Reasonably good humour; laughs regularly &nbsp;·&nbsp; <em>18–20:</em> Genuine wit and lightness; laughter is frequent and real</span>' },
      { key: 'flow', name: 'Flow', desc: 'Whether you regularly experience deep absorption in activities — losing track of time, fully present in what you\'re doing.<br><br><span class="scale-anchors"><em>1–4:</em> Rarely or never experiences flow; most activities feel effortful or hollow &nbsp;·&nbsp; <em>9–12:</em> Occasional flow states; some activities that fully absorb &nbsp;·&nbsp; <em>18–20:</em> Regular flow experiences; deep engagement is a common feature of life</span>' },
      { key: 'savouring', name: 'Savouring', desc: 'The practice of slowing down to notice and appreciate good moments while they\'re happening — rather than rushing past them.<br><br><span class="scale-anchors"><em>1–4:</em> Rarely stops to appreciate; always looking ahead or elsewhere &nbsp;·&nbsp; <em>9–12:</em> Sometimes savours; notices good moments but often lets them pass &nbsp;·&nbsp; <em>18–20:</em> Consistently and deliberately savours; present, appreciative, unhurried with what\'s good</span>' },
    ]
  }
];

const BFI_ITEMS = [
  { trait: 'extraversion', reverse: true, text: 'I see myself as someone who is reserved' },
  { trait: 'agreeableness', reverse: false, text: 'I see myself as someone who is generally trusting' },
  { trait: 'conscientiousness', reverse: true, text: 'I see myself as someone who tends to be lazy' },
  { trait: 'neuroticism', reverse: true, text: 'I see myself as someone who is relaxed, handles stress well' },
  { trait: 'openness', reverse: true, text: 'I see myself as someone who has few artistic interests' },
  { trait: 'extraversion', reverse: false, text: 'I see myself as someone who is outgoing, sociable' },
  { trait: 'agreeableness', reverse: true, text: 'I see myself as someone who tends to find fault with others' },
  { trait: 'conscientiousness', reverse: false, text: 'I see myself as someone who does a thorough job' },
  { trait: 'neuroticism', reverse: false, text: 'I see myself as someone who gets nervous easily' },
  { trait: 'openness', reverse: false, text: 'I see myself as someone who has an active imagination' },
];

const TRAIT_INFO = {
  openness: {
    name: 'Openness',
    desc: 'Your appetite for novelty, ideas, art, and new experiences.',
    low: 'You prefer the familiar and practical',
    high: 'You\'re drawn to novelty and ideas'
  },
  conscientiousness: {
    name: 'Conscientiousness',
    desc: 'Your tendency toward organisation, discipline, and thoroughness.',
    low: 'You\'re spontaneous and flexible',
    high: 'You\'re systematic and goal-directed'
  },
  extraversion: {
    name: 'Extraversion',
    desc: 'Your orientation toward the outer world of people and activity.',
    low: 'You prefer quieter, calmer settings',
    high: 'You\'re energised by people and activity'
  },
  agreeableness: {
    name: 'Agreeableness',
    desc: 'Your orientation toward cooperation and trust with others.',
    low: 'You\'re direct and skeptical',
    high: 'You\'re trusting and cooperative'
  },
  neuroticism: {
    name: 'Neuroticism',
    desc: 'Your tendency to experience negative emotions and stress.',
    low: 'You\'re emotionally steady and even-keeled',
    high: 'You feel things intensely and deeply'
  }
};

const SCORE_LABELS = [
  { min: 1, max: 4, label: 'Critical', color: 'var(--color-critical)' },
  { min: 5, max: 7, label: 'Struggling', color: 'var(--color-struggling)' },
  { min: 8, max: 9, label: 'Below Average', color: 'var(--color-below)' },
  { min: 10, max: 11, label: 'Average', color: 'var(--color-average)' },
  { min: 12, max: 13, label: 'Above Average', color: 'var(--color-above)' },
  { min: 14, max: 15, label: 'Strong', color: 'var(--color-strong)' },
  { min: 16, max: 17, label: 'Excellent', color: 'var(--color-excellent)' },
  { min: 18, max: 20, label: 'Exceptional', color: 'var(--color-exceptional)' },
];

function getScoreInfo(score) {
  const s = Math.max(1, Math.min(20, Math.round(score)));
  for (const sl of SCORE_LABELS) {
    if (s >= sl.min && s <= sl.max) return { label: sl.label, color: sl.color };
  }
  return { label: 'Average', color: 'var(--color-average)' };
}

function escapeHtml(str) {
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

// State
const state = {
  profile: { name: 'Character', age: '', gender: '', photo: null },
  scores: {},
  subScores: {},
  overrides: {},
  bfiResponses: {},
  abilities: []
};

let currentSection = 0;
let currentSubStep = 0;  // 0 = intro, 1..N = sub-scale index within current attribute
let currentBFIStep = -1; // -1 = BFI intro, 0–9 = individual BFI items
let saveTimeout = null;

// Global step map — built once, used by stepForward/stepBack
function buildGlobalStepMap() {
  const map = [];
  ATTRIBUTES.forEach((attr, i) => {
    map.push({ section: i + 1, subStep: 0 });
    attr.subScores.forEach((_, j) => map.push({ section: i + 1, subStep: j + 1 }));
  });
  return map; // 46 entries total across 8 attributes
}
let GLOBAL_STEP_MAP = null;

// ==================== APP ====================

const app = {
  init() {
    const saved = localStorage.getItem('charactersheet-data');

    if (saved) {
      this.loadFromStorage();
      this.showSheet();
    } else {
      this.showTutorial();
    }
  },

  initializeNewSheet() {
    ATTRIBUTES.forEach(attr => {
      state.scores[attr.key] = 10;
      state.overrides[attr.key] = false;
      attr.subScores.forEach(sub => {
        state.subScores[sub.key] = 10;
      });
    });

    BFI_ITEMS.forEach((item, i) => {
      state.bfiResponses[i] = 3;
    });

    state.abilities = [];
  },

  // ==================== TUTORIAL ====================

  showTutorial() {
    document.getElementById('tutorial-view').classList.add('active');
    document.getElementById('edit-view').classList.remove('active');
    document.getElementById('sheet-view').classList.remove('active');
    document.getElementById('calculating-view').classList.remove('active');
    this.renderTutorial();
    window.scrollTo(0, 0);
  },

  renderTutorial() {
    const container = document.getElementById('tutorial-pages-container');

    const attrCards = ATTRIBUTES.map(a => `
      <div class="attr-preview-card">
        <div class="attr-preview-name">${a.name}</div>
        <div class="attr-preview-tagline">${a.tagline}</div>
      </div>
    `).join('');

    const pages = [
      // PAGE 1 — Welcome
      `<div class="tutorial-page">
        <div class="tutorial-page-content">
          <h1>THE CHARACTER SHEET</h1>
          <p class="tutorial-subtitle">A Guide to Knowing Yourself</p>
          <p class="lead" style="margin-top: 32px;">You've been playing the most complex game ever designed for your entire life. It has no tutorial, no pause button, and the rules keep changing.</p>
          <p>This is your invitation to stop and look at your character sheet.</p>
          <p>It's a structured self-reflection tool — a way to take an honest, clear-eyed look at who you are right now across the dimensions that matter most. Not where you think you stand. Not where you wish you stood. Where you actually are, today.</p>
          <p>Some of what you see will make you proud. Some of it might be uncomfortable. All of it is useful.</p>
          <div class="tutorial-actions">
            <button class="btn btn-primary" onclick="app.scrollToPage(1)">Begin</button>
          </div>
        </div>
      </div>`,

      // PAGE 2 — How It Works
      `<div class="tutorial-page">
        <div class="tutorial-page-content">
          <h2>How It Works</h2>
          <p style="margin-top: 24px;">Your character is defined by <strong>eight core attributes</strong>. Each one represents a fundamental dimension of a human life. Together, they form a complete portrait — not of who you want to be, but of who you are.</p>
          <p>You'll rate each attribute on a <strong>1–20 scale</strong>, where 10 is average. Each attribute has sub-scores that help you think carefully about what's really going on beneath the surface.</p>
          <p>There is no total score. Your attributes are never summed into a single number. Life is not an optimisation problem, and the person with the highest total is not winning — they might simply be the least honest.</p>
          <p>You'll also capture your <strong>abilities</strong> — the specific skills and pursuits that make you you — and take a brief <strong>personality snapshot</strong> based on the Big Five model from psychology.</p>
          <div class="tutorial-actions">
            <button class="btn btn-secondary" onclick="app.scrollToPage(0)">Back</button>
            <button class="btn btn-primary" onclick="app.scrollToPage(2)">Continue</button>
          </div>
        </div>
      </div>`,

      // PAGE 3 — The Eight Attributes
      `<div class="tutorial-page">
        <div class="tutorial-page-content">
          <h2>The Eight Attributes</h2>
          <p style="margin-top: 16px;">Each represents a different dimension of your life. Some are things within your control — your effort, your character, your choices. Others are influenced by your actions but subject to forces beyond you. The measure of a life well-lived is not your scores, but how you relate to them.</p>
          <div class="attr-preview-grid">${attrCards}</div>
          <p style="font-size: 14px; color: var(--light-gray);">You'll rate each one with sub-scores that automatically combine into your main attribute score. You can override the auto-calculation if you feel the whole is different from the sum of its parts.</p>
          <div class="tutorial-actions">
            <button class="btn btn-secondary" onclick="app.scrollToPage(1)">Back</button>
            <button class="btn btn-primary" onclick="app.scrollToPage(3)">Continue</button>
          </div>
        </div>
      </div>`,

      // PAGE 4 — The Scale
      `<div class="tutorial-page">
        <div class="tutorial-page-content">
          <h2>The 1–20 Scale</h2>
          <p style="margin-top: 16px;">Every score uses the same scale, giving you a common language across very different areas of your life.</p>
          <table class="score-table">
            <tr><th>Score</th><th>Meaning</th></tr>
            <tr><td><span class="score-color" style="background:var(--color-critical)"></span><strong>1–4</strong></td><td>Critical — in serious difficulty</td></tr>
            <tr><td><span class="score-color" style="background:var(--color-struggling)"></span><strong>5–7</strong></td><td>Struggling — noticeably below where you'd want to be</td></tr>
            <tr><td><span class="score-color" style="background:var(--color-below)"></span><strong>8–9</strong></td><td>Below Average — room for improvement</td></tr>
            <tr><td><span class="score-color" style="background:var(--color-average)"></span><strong>10–11</strong></td><td>Average — where most people land</td></tr>
            <tr><td><span class="score-color" style="background:var(--color-above)"></span><strong>12–13</strong></td><td>Above Average — a genuine strength</td></tr>
            <tr><td><span class="score-color" style="background:var(--color-strong)"></span><strong>14–15</strong></td><td>Strong — going well, and you know it</td></tr>
            <tr><td><span class="score-color" style="background:var(--color-excellent)"></span><strong>16–17</strong></td><td>Excellent — people probably notice</td></tr>
            <tr><td><span class="score-color" style="background:var(--color-exceptional)"></span><strong>18–20</strong></td><td>Exceptional — a defining feature of your life</td></tr>
          </table>
          <p style="text-align: left; font-size: 14px; color: var(--medium-gray);">10 is not a failing grade — it's where most people are. Nobody has 20s across the board. And these scores move: they change with your circumstances, your effort, and plain luck. The sheet is designed to be revisited.</p>
          <div class="tutorial-actions">
            <button class="btn btn-secondary" onclick="app.scrollToPage(2)">Back</button>
            <button class="btn btn-primary" onclick="app.scrollToPage(4)">Continue</button>
          </div>
        </div>
      </div>`,

      // PAGE 5 — Let's Begin
      `<div class="tutorial-page">
        <div class="tutorial-page-content">
          <h2>Let's Begin</h2>
          <p style="margin-top: 32px; font-size: 18px;">Take your time. Be honest. There are no right answers and no one is grading you.</p>
          <p style="font-size: 17px;">This sheet is for you alone — unless you choose to share it.</p>
          <div class="tutorial-form">
            <label>Your Name</label>
            <input type="text" id="tutorial-name" placeholder="Enter your name">
            <label>Age (optional)</label>
            <input type="number" id="tutorial-age" placeholder="Age">
            <label>Gender (optional)</label>
            <select id="tutorial-gender">
              <option value="">Select...</option>
              <option value="male">Male</option>
              <option value="female">Female</option>
              <option value="non-binary">Non-binary</option>
              <option value="other">Other</option>
              <option value="prefer-not">Prefer not to say</option>
            </select>
          </div>
          <div class="tutorial-actions">
            <button class="btn btn-secondary" onclick="app.scrollToPage(3)">Back</button>
            <button class="btn btn-primary" onclick="app.completeTutorial()">Create My Sheet</button>
          </div>
        </div>
      </div>`
    ];

    container.innerHTML = pages.join('');
  },

  scrollToPage(index) {
    const pages = document.querySelectorAll('.tutorial-page');
    if (pages[index]) {
      pages[index].scrollIntoView({ behavior: 'smooth' });
    }
  },

  skipTutorial() {
    this.completeTutorial();
  },

  completeTutorial() {
    const name = document.getElementById('tutorial-name')?.value || 'Character';
    const age = document.getElementById('tutorial-age')?.value || '';
    const gender = document.getElementById('tutorial-gender')?.value || '';

    state.profile.name = name;
    state.profile.age = age;
    state.profile.gender = gender;

    document.getElementById('tutorial-view').classList.remove('active');
    this.showEdit();

    // Only initialize if this is truly a new sheet
    if (!localStorage.getItem('charactersheet-data')) {
      this.initializeNewSheet();
    }
    this.buildEditView();
    this.save();
  },

  // ==================== VIEW MANAGEMENT ====================

  showEdit() {
    document.getElementById('edit-view').classList.add('active');
    document.getElementById('sheet-view').classList.remove('active');
    document.getElementById('tutorial-view').classList.remove('active');
    document.getElementById('calculating-view').classList.remove('active');
  },

  showSheet() {
    document.getElementById('edit-view').classList.remove('active');
    document.getElementById('tutorial-view').classList.remove('active');
    document.getElementById('calculating-view').classList.remove('active');
    document.getElementById('sheet-view').classList.add('active');
    this.renderSheet();
    window.scrollTo(0, 0);
  },

  editSheet() {
    this.showEdit();
    this.buildEditView();
  },

  viewSheet() {
    // Show calculating animation
    this.save();
    document.getElementById('edit-view').classList.remove('active');
    document.getElementById('calculating-view').classList.add('active');

    const steps = ['calc-step-1', 'calc-step-2', 'calc-step-3', 'calc-step-4'];
    let i = 0;

    const showNext = () => {
      if (i < steps.length) {
        const el = document.getElementById(steps[i]);
        el.classList.add('visible');
        if (i > 0) {
          document.getElementById(steps[i-1]).classList.add('done');
        }
        i++;
        setTimeout(showNext, 700);
      } else {
        // All done — show sheet
        setTimeout(() => {
          // Reset animation states
          steps.forEach(id => {
            const el = document.getElementById(id);
            el.classList.remove('visible', 'done');
          });
          document.getElementById('calculating-view').classList.remove('active');
          this.showSheet();
        }, 600);
      }
    };

    setTimeout(showNext, 300);
  },

  buildEditView() {
    if (!GLOBAL_STEP_MAP) GLOBAL_STEP_MAP = buildGlobalStepMap();
    this.renderProfile();
    this.renderNav();
    this.renderSections();
  },

  // ==================== PROFILE ====================

  renderProfile() {
    document.getElementById('input-name').value = state.profile.name || '';
    document.getElementById('input-age').value = state.profile.age || '';
    document.getElementById('input-gender').value = state.profile.gender || '';

    const imgEl = document.getElementById('profile-img');
    const placeholderEl = document.getElementById('photo-placeholder');

    if (state.profile.photo) {
      imgEl.src = state.profile.photo;
      imgEl.style.display = 'block';
      placeholderEl.style.display = 'none';
    } else {
      imgEl.style.display = 'none';
      placeholderEl.style.display = 'block';
    }
  },

  updateProfile() {
    state.profile.name = document.getElementById('input-name').value || 'Character';
    state.profile.age = document.getElementById('input-age').value;
    state.profile.gender = document.getElementById('input-gender').value;
    this.autoSave();
  },

  uploadPhoto(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        const MAX = 800;
        let w = img.width, h = img.height;
        if (w > MAX || h > MAX) {
          if (w > h) { h = Math.round(h * MAX / w); w = MAX; }
          else { w = Math.round(w * MAX / h); h = MAX; }
        }
        const canvas = document.createElement('canvas');
        canvas.width = w;
        canvas.height = h;
        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
        state.profile.photo = canvas.toDataURL('image/jpeg', 0.8);
        this.renderProfile();
        this.autoSave();
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  },

  // ==================== EDIT NAV & SECTIONS ====================

  renderNav() {
    const nav = document.getElementById('section-nav');
    nav.innerHTML = `<button onclick="app.showSection(0)">Personality</button>` +
      ATTRIBUTES.map((attr, i) =>
        `<button onclick="app.showSection(${i + 1})" style="--btn-accent: var(--attr-${attr.key})">${attr.name}</button>`
      ).join('') +
      `<button onclick="app.showSection(${ATTRIBUTES.length + 1})">Abilities</button>`;
  },

  renderSections() {
    const container = document.getElementById('sections-container');
    container.innerHTML = this.renderPersonalitySection() +
      ATTRIBUTES.map((attr, i) =>
        this.renderAttributeSection(attr, i + 1)
      ).join('') +
      this.renderAbilitiesSection();

    this.showSection(currentSection);
    // Restore non-zero sub-step if returning mid-section (e.g. from sheet view)
    if (currentSection === 0 && currentBFIStep >= 0) {
      this.showBFIStep(currentBFIStep);
    } else if (currentSection >= 1 && currentSection <= ATTRIBUTES.length && currentSubStep > 0) {
      this.showSubStep(currentSubStep);
    }
  },

  renderAttributeSection(attr, index) {
    // Renders the section shell only. The .attribute-step-content slot is
    // populated by showSubStep() at navigation time. No sub-scores, no
    // main-score-area — scores are revealed only on the character sheet.
    return `
      <div class="attribute-section" id="section-${index}" style="--section-accent: var(--attr-${attr.key})">
        <div class="attribute-section-header">
          <h2>${attr.name}</h2>
          <span class="tagline" id="attr-tagline-${attr.key}">${attr.tagline}</span>
          <span class="step-counter" id="step-counter-${attr.key}"></span>
        </div>
        <div class="attribute-step-content">
          ${this.renderIntroStep(attr, index)}
        </div>
      </div>
    `;
  },

  renderAbilitiesSection() {
    const attrOptions = ATTRIBUTES.map(a => `<option value="${a.key}">${a.name}</option>`).join('');

    const abilities = state.abilities.map((ab, i) => `
      <div class="ability-item">
        <input type="text" placeholder="Ability name" value="${escapeHtml(ab.name)}"
          onchange="app.updateAbility(${i}, 'name', this.value)">
        <input type="number" min="1" max="20" value="${ab.score}"
          onchange="app.updateAbility(${i}, 'score', parseInt(this.value))">
        <select onchange="app.updateAbility(${i}, 'linked', this.value)">
          <option value="">Link to...</option>
          ${attrOptions.replace(`value="${ab.linked}"`, `value="${ab.linked}" selected`)}
        </select>
        <div class="ability-controls">
          <button class="status-toggle ${ab.status === 'active' ? 'active' : 'dormant'}"
            onclick="app.toggleAbilityStatus(${i})">
            ${ab.status === 'active' ? 'Active' : 'Dormant'}
          </button>
          <button class="ability-remove" onclick="app.removeAbility(${i})">&times;</button>
        </div>
      </div>
    `).join('');

    return `
      <div class="attribute-section" id="section-${ATTRIBUTES.length + 1}">
        <div class="section-label">Skills & Pursuits</div>
        <h2>Abilities</h2>
        <div class="tagline">The specific things you can do that make you you.</div>
        <div class="abilities-intro">
          Add your abilities below — skills, competencies, hobbies, anything you can do.
          Rate each on the 1–20 scale, link it to a core attribute, and mark whether it's
          something you're actively practising or something that's gone dormant.
        </div>
        <div class="abilities-list">${abilities}</div>
        <button class="btn btn-secondary btn-small" style="margin-top:20px" onclick="app.addAbility()">+ Add Ability</button>

        <div class="section-nav-buttons">
          <button class="btn btn-secondary" onclick="app.stepBack()">Previous</button>
          <button class="btn btn-primary" onclick="app.viewSheet()">View My Sheet</button>
        </div>
      </div>
    `;
  },

  renderPersonalitySection() {
    return `
      <div class="attribute-section" id="section-0">
        <div class="attribute-section-header">
          <h2>Personality</h2>
          <span class="tagline" id="attr-tagline-personality">How you tend to move through the world.</span>
          <span class="step-counter" id="step-counter-personality"></span>
        </div>
        <div class="bfi-step-content">
          ${this.renderBFIIntro()}
        </div>
      </div>
    `;
  },

  renderBFIIntro() {
    return `
      <div class="sub-step-intro">
        <div class="attribute-description">
          Your personality captures your tendencies — not your achievements or values.
          There are no good or bad profiles here. Answer based on how you genuinely see
          yourself, not how you'd like to be. Ten short statements, rated 1–5.
        </div>
        <div class="sub-step-nav">
          <div></div>
          <button class="btn btn-primary" onclick="app.stepForward()">Begin &mdash; 10 questions</button>
        </div>
      </div>
    `;
  },

  renderBFIItem(index) {
    const item = BFI_ITEMS[index];
    const current = state.bfiResponses[index] !== undefined ? state.bfiResponses[index] : 0;
    const labels = ['Strongly Disagree', 'Disagree', 'Neutral', 'Agree', 'Strongly Agree'];
    const buttons = [1, 2, 3, 4, 5].map(val => `
      <button class="bfi-btn${current === val ? ' selected' : ''}"
        onclick="app.updateBFI(${index}, ${val})">
        ${labels[val - 1]}
      </button>
    `).join('');
    return `
      <div class="sub-step-body">
        <div class="sub-step-question-name bfi-question">${item.text}</div>
        <div class="bfi-buttons">${buttons}</div>
        <div class="sub-step-nav">
          <button class="btn btn-secondary" onclick="app.stepBack()">Previous</button>
          <button class="btn btn-primary" onclick="app.stepForward()">Next</button>
        </div>
      </div>
    `;
  },

  showBFIStep(stepIndex) {
    currentBFIStep = stepIndex;
    const content = document.querySelector('#section-0 .bfi-step-content');
    if (!content) return;
    content.classList.remove('stepping');
    void content.offsetWidth;
    content.classList.add('stepping');
    const taglineEl = document.getElementById('attr-tagline-personality');
    const counterEl = document.getElementById('step-counter-personality');
    if (stepIndex === -1) {
      content.innerHTML = this.renderBFIIntro();
      if (taglineEl) taglineEl.style.display = '';
      if (counterEl) counterEl.textContent = '';
    } else {
      content.innerHTML = this.renderBFIItem(stepIndex);
      if (taglineEl) taglineEl.style.display = 'none';
      if (counterEl) counterEl.textContent = `${stepIndex + 1} of ${BFI_ITEMS.length}`;
    }
    this._scrollToSection();
  },

  _scrollToSection() {
    const section = document.querySelector('.attribute-section.active');
    if (!section) return;
    const navEl = document.getElementById('section-nav');
    const navH = navEl ? navEl.offsetHeight + 12 : 60;
    const top = section.getBoundingClientRect().top + window.scrollY - navH;
    window.scrollTo({ top: Math.max(0, top), behavior: 'smooth' });
  },

  _activateSection(index) {
    document.querySelectorAll('.attribute-section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.section-nav button').forEach(b => b.classList.remove('active'));
    const section = document.getElementById(`section-${index}`);
    if (section) section.classList.add('active');
    const buttons = document.querySelectorAll('.section-nav button');
    if (buttons[index]) buttons[index].classList.add('active');
    currentSection = index;
  },

  showSection(index) {
    this._activateSection(index);
    currentSubStep = 0;
    if (index === 0) {
      // Personality section: reset to BFI intro
      currentBFIStep = -1;
      this.showBFIStep(-1);
    } else if (index >= 1 && index <= ATTRIBUTES.length) {
      // Attribute section: render the intro step into the content slot
      this.showSubStep(0);
    } else {
      this._scrollToSection();
    }
  },

  showSubStep(subStepIndex) {
    currentSubStep = subStepIndex;
    const attr = ATTRIBUTES[currentSection - 1];
    if (!attr) return;
    const section = document.getElementById(`section-${currentSection}`);
    if (!section) return;
    const content = section.querySelector('.attribute-step-content');
    if (!content) return;
    // Trigger CSS fade animation
    content.classList.remove('stepping');
    void content.offsetWidth; // force reflow to restart animation
    content.classList.add('stepping');
    const totalSubs = attr.subScores.length;
    if (subStepIndex === 0) {
      content.innerHTML = this.renderIntroStep(attr, currentSection);
      // Show tagline on intro, hide step counter
      const taglineEl = document.getElementById(`attr-tagline-${attr.key}`);
      const counterEl = document.getElementById(`step-counter-${attr.key}`);
      if (taglineEl) taglineEl.style.display = '';
      if (counterEl) counterEl.textContent = '';
    } else {
      const sub = attr.subScores[subStepIndex - 1];
      content.innerHTML = this.renderSubScoreStep(attr, sub, subStepIndex, totalSubs);
      // Hide tagline on sub-scale steps, show step counter
      const taglineEl = document.getElementById(`attr-tagline-${attr.key}`);
      const counterEl = document.getElementById(`step-counter-${attr.key}`);
      if (taglineEl) taglineEl.style.display = 'none';
      if (counterEl) counterEl.textContent = `${subStepIndex} of ${totalSubs}`;
    }
    this._scrollToSection();
  },

  renderIntroStep(attr, sectionIndex) {
    const totalSubs = attr.subScores.length;
    return `
      <div class="sub-step-intro">
        <div class="attribute-description">${attr.description}</div>
        <div class="reflection-prompt">
          <div class="prompt-label">Reflect</div>
          <p>${attr.prompt}</p>
        </div>
        <div class="sub-step-nav">
          <button class="btn btn-secondary" onclick="app.stepBack()">Previous</button>
          <button class="btn btn-primary" onclick="app.stepForward()">Begin &mdash; ${totalSubs} questions</button>
        </div>
      </div>
    `;
  },

  renderSubScoreStep(attr, sub, stepNumber, totalSubs) {
    const currentVal = state.subScores[sub.key] || 10;
    const info = getScoreInfo(currentVal);
    return `
      <div class="sub-step-body">
        <div class="sub-step-question-name">${sub.name}</div>
        <div class="sub-score-desc">${sub.desc}</div>
        <div class="sub-step-slider-area">
          <input type="range" min="1" max="20" value="${currentVal}"
            data-subkey="${sub.key}"
            oninput="app.updateSubScore('${sub.key}', this.value)">
          <div class="sub-step-value-row">
            <span class="sub-score-value" data-subkey-value="${sub.key}"
              style="color: ${info.color}">${currentVal}</span>
            <span class="sub-score-label" data-subkey-label="${sub.key}"
              style="color: ${info.color}">${info.label}</span>
          </div>
        </div>
        <div class="sub-step-nav">
          <button class="btn btn-secondary" onclick="app.stepBack()">Previous</button>
          <button class="btn btn-primary" onclick="app.stepForward()">Next</button>
        </div>
      </div>
    `;
  },

  stepForward() {
    if (currentSection === 0) {
      // BFI navigation
      if (currentBFIStep === -1) { this.showBFIStep(0); return; }
      if (currentBFIStep < BFI_ITEMS.length - 1) { this.showBFIStep(currentBFIStep + 1); return; }
      this.showSection(1); return; // Last BFI item -> Body intro
    }
    if (currentSection === ATTRIBUTES.length + 1) { this.viewSheet(); return; }
    const attr = ATTRIBUTES[currentSection - 1];
    if (currentSubStep < attr.subScores.length) {
      this.showSubStep(currentSubStep + 1);
    } else {
      this.showSection(currentSection < ATTRIBUTES.length ? currentSection + 1 : ATTRIBUTES.length + 1);
    }
  },

  stepBack() {
    if (currentSection === 0) {
      // BFI navigation
      if (currentBFIStep > 0) { this.showBFIStep(currentBFIStep - 1); return; }
      if (currentBFIStep === 0) { this.showBFIStep(-1); return; } // back to BFI intro
      return; // on intro, no previous
    }

    if (currentSection === ATTRIBUTES.length + 1) {
      // Abilities -> last attribute's last sub-score
      const lastAttr = ATTRIBUTES[ATTRIBUTES.length - 1];
      this._activateSection(ATTRIBUTES.length);
      this.showSubStep(lastAttr.subScores.length);
      return;
    }

    if (currentSubStep > 0) {
      this.showSubStep(currentSubStep - 1);
    } else {
      if (currentSection === 1) {
        // Body intro -> Personality, land on last BFI item
        this._activateSection(0);
        this.showBFIStep(BFI_ITEMS.length - 1);
      } else {
        // Go to previous attribute's last sub-scale (not its intro)
        const prevAttr = ATTRIBUTES[currentSection - 2];
        this._activateSection(currentSection - 1);
        this.showSubStep(prevAttr.subScores.length);
      }
    }
  },

  // ==================== SCORE LOGIC ====================

  getMainScore(attrKey) {
    if (state.overrides[attrKey]) {
      return state.scores[attrKey] || 10;
    }

    const attr = ATTRIBUTES.find(a => a.key === attrKey);
    if (!attr) return 10;

    const values = attr.subScores.map(sub => state.subScores[sub.key] || 10);
    const avg = values.reduce((a, b) => a + b, 0) / values.length;
    return Math.round(avg);
  },

  toggleOverride(attrKey) {
    state.overrides[attrKey] = !state.overrides[attrKey];
    if (!state.overrides[attrKey]) {
      state.scores[attrKey] = this.getMainScore(attrKey);
    }
    this.refreshAttributeMainScore(attrKey);
    this.autoSave();
  },

  refreshAttributeMainScore(attrKey) {
    const attr = ATTRIBUTES.find(a => a.key === attrKey);
    if (!attr) return;
    const mainScore = this.getMainScore(attrKey);
    const info = getScoreInfo(mainScore);
    const scoreArea = document.getElementById(`main-score-${attrKey}`);
    if (scoreArea) {
      scoreArea.innerHTML = `
        <div class="score-label">Your ${attr.name} Score</div>
        <div class="score-display" id="score-display-${attrKey}" style="color: ${info.color}">${mainScore}</div>
        <div class="score-meaning" style="color: ${info.color}">${info.label}</div>
        <div class="override-area">
          <button class="override-toggle ${state.overrides[attrKey] ? 'active' : ''}"
            onclick="app.toggleOverride('${attrKey}')">
            ${state.overrides[attrKey] ? 'Override: On' : 'Override: Off'}
          </button>
          ${state.overrides[attrKey] ? `
            <input type="number" min="1" max="20" value="${state.scores[attrKey] || 10}"
              class="main-score-input"
              onchange="app.updateScore('${attrKey}', this.value)">
          ` : ''}
          <span class="indicator">${state.overrides[attrKey] ? 'manual' : 'auto-calculated from sub-scores'}</span>
        </div>
      `;
    }
  },

  updateScore(attrKey, value) {
    const n = parseInt(value);
    if (isNaN(n)) return;
    state.scores[attrKey] = Math.max(1, Math.min(20, n));
    this.refreshAttributeMainScore(attrKey);
    this.autoSave();
  },

  updateSubScore(subKey, value) {
    state.subScores[subKey] = parseInt(value);
    const info = getScoreInfo(parseInt(value));

    const valueSpan = document.querySelector(`[data-subkey-value="${subKey}"]`);
    if (valueSpan) {
      valueSpan.textContent = value;
      valueSpan.style.color = info.color;
    }

    const labelEl = document.querySelector(`[data-subkey-label="${subKey}"]`);
    if (labelEl) {
      labelEl.textContent = info.label;
      labelEl.style.color = info.color;
    }

    const attr = ATTRIBUTES.find(a => a.subScores.some(s => s.key === subKey));
    if (attr && !state.overrides[attr.key]) {
      state.scores[attr.key] = this.getMainScore(attr.key);
      this.refreshAttributeMainScore(attr.key);
    }

    this.autoSave();
  },

  addAbility() {
    state.abilities.push({ name: '', score: 10, linked: '', status: 'active' });
    this.refreshAbilitiesSection();
    this.autoSave();
  },

  removeAbility(index) {
    state.abilities.splice(index, 1);
    this.refreshAbilitiesSection();
    this.autoSave();
  },

  updateAbility(index, field, value) {
    state.abilities[index][field] = value;
    this.autoSave();
  },

  toggleAbilityStatus(index) {
    state.abilities[index].status = state.abilities[index].status === 'active' ? 'dormant' : 'active';
    this.refreshAbilitiesSection();
    this.autoSave();
  },

  refreshAbilitiesSection() {
    const section = document.getElementById(`section-${ATTRIBUTES.length + 1}`);
    if (!section) return;
    const attrOptions = ATTRIBUTES.map(a => `<option value="${a.key}">${a.name}</option>`).join('');
    const abilities = state.abilities.map((ab, i) => `
      <div class="ability-item">
        <input type="text" placeholder="Ability name" value="${escapeHtml(ab.name)}"
          onchange="app.updateAbility(${i}, 'name', this.value)">
        <input type="number" min="1" max="20" value="${ab.score}"
          onchange="app.updateAbility(${i}, 'score', parseInt(this.value))">
        <select onchange="app.updateAbility(${i}, 'linked', this.value)">
          <option value="">Link to...</option>
          ${attrOptions.replace(new RegExp(`value="${ab.linked}"`), `value="${ab.linked}" selected`)}
        </select>
        <div class="ability-controls">
          <button class="status-toggle ${ab.status === 'active' ? 'active' : 'dormant'}"
            onclick="app.toggleAbilityStatus(${i})">
            ${ab.status === 'active' ? 'Active' : 'Dormant'}
          </button>
          <button class="ability-remove" onclick="app.removeAbility(${i})">&times;</button>
        </div>
      </div>
    `).join('');
    const abilitiesList = section.querySelector('.abilities-list');
    if (abilitiesList) abilitiesList.innerHTML = abilities;
  },

  updateBFI(index, value) {
    state.bfiResponses[index] = value;
    // Targeted update: just toggle the .selected class on the visible buttons
    const content = document.querySelector('#section-0 .bfi-step-content');
    if (content) {
      const buttons = content.querySelectorAll('.bfi-btn');
      buttons.forEach((btn, i) => {
        btn.classList.toggle('selected', i + 1 === value);
      });
    }
    this.autoSave();
  },

  calculateBFIScores() {
    const traits = {};
    Object.keys(TRAIT_INFO).forEach(trait => { traits[trait] = []; });

    BFI_ITEMS.forEach((item, i) => {
      let response = state.bfiResponses[i] || 3;
      if (item.reverse) response = 6 - response;
      traits[item.trait].push(response);
    });

    const scores = {};
    Object.keys(traits).forEach(trait => {
      const mean = traits[trait].reduce((a, b) => a + b, 0) / traits[trait].length;
      scores[trait] = Math.round(mean * 2) / 2;
    });

    return scores;
  },

  // ==================== SHEET RENDERING ====================

  renderSheet() {
    this.renderSheetHeader();
    this.renderSheetRadar();
    this.renderSheetScores();
    this.renderSheetPersonality();
    this.renderSheetAbilities();
  },

  renderSheetHeader() {
    document.getElementById('sheet-name').textContent = state.profile.name || 'Character';

    const age = state.profile.age ? `Age ${state.profile.age}` : '';
    const gender = state.profile.gender ? (state.profile.gender.charAt(0).toUpperCase() + state.profile.gender.slice(1)) : '';
    const date = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

    const parts = [age, gender, date].filter(Boolean);
    document.getElementById('sheet-meta').innerHTML = parts.map(m => `<span>${m}</span>`).join('');

    const imgEl = document.getElementById('sheet-img');
    const placeholderEl = document.getElementById('sheet-photo-placeholder');

    if (state.profile.photo) {
      imgEl.src = state.profile.photo;
      imgEl.style.display = 'block';
      placeholderEl.style.display = 'none';
    } else {
      imgEl.style.display = 'none';
      placeholderEl.style.display = 'block';
    }
  },

  renderSheetRadar() {
    const canvas = document.getElementById('radarChart');
    const ctx = canvas.getContext('2d');
    const dpr = window.devicePixelRatio || 1;

    const size = 660;
    canvas.width = size * dpr;
    canvas.height = size * dpr;
    canvas.style.width = size + 'px';
    canvas.style.height = '';
    ctx.scale(dpr, dpr);

    const cx = size / 2, cy = size / 2, maxR = 190;
    const n = ATTRIBUTES.length;
    const angleStep = (2 * Math.PI) / n;
    const startAngle = -Math.PI / 2;

    ctx.clearRect(0, 0, size, size);

    // Grid rings
    for (let ring = 1; ring <= 4; ring++) {
      const r = (ring / 4) * maxR;
      ctx.beginPath();
      for (let i = 0; i <= n; i++) {
        const angle = startAngle + i * angleStep;
        const x = cx + r * Math.cos(angle);
        const y = cy + r * Math.sin(angle);
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      }
      ctx.strokeStyle = '#E2E0DC';
      ctx.lineWidth = 1;
      ctx.stroke();
    }

    // Axis lines
    for (let i = 0; i < n; i++) {
      const angle = startAngle + i * angleStep;
      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.lineTo(cx + maxR * Math.cos(angle), cy + maxR * Math.sin(angle));
      ctx.strokeStyle = '#E2E0DC';
      ctx.lineWidth = 1;
      ctx.stroke();
    }

    // Data polygon
    const values = ATTRIBUTES.map(a => this.getMainScore(a.key));

    ctx.beginPath();
    values.forEach((val, i) => {
      const r = (val / 20) * maxR;
      const angle = startAngle + i * angleStep;
      const x = cx + r * Math.cos(angle);
      const y = cy + r * Math.sin(angle);
      if (i === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    });
    ctx.closePath();
    ctx.fillStyle = 'rgba(139, 111, 71, 0.15)';
    ctx.fill();

    ctx.beginPath();
    values.forEach((val, i) => {
      const r = (val / 20) * maxR;
      const angle = startAngle + i * angleStep;
      const x = cx + r * Math.cos(angle);
      const y = cy + r * Math.sin(angle);
      if (i === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    });
    ctx.closePath();
    ctx.strokeStyle = '#8B6F47';
    ctx.lineWidth = 2;
    ctx.stroke();

    // Data points
    values.forEach((val, i) => {
      const r = (val / 20) * maxR;
      const angle = startAngle + i * angleStep;
      const x = cx + r * Math.cos(angle);
      const y = cy + r * Math.sin(angle);
      const info = getScoreInfo(val);
      ctx.beginPath();
      ctx.arc(x, y, 5, 0, 2 * Math.PI);
      ctx.fillStyle = info.color;
      ctx.fill();
    });

    // Labels
    ATTRIBUTES.forEach((attr, i) => {
      const angle = startAngle + i * angleStep;
      const labelR = maxR + 60;
      const x = cx + labelR * Math.cos(angle);
      const y = cy + labelR * Math.sin(angle);

      ctx.font = '13px -apple-system, Arial, sans-serif';
      ctx.fillStyle = '#4A5568';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';

      if (Math.cos(angle) < -0.3) ctx.textAlign = 'right';
      else if (Math.cos(angle) > 0.3) ctx.textAlign = 'left';

      ctx.fillText(attr.name, x, y);

      const score = this.getMainScore(attr.key);
      const scoreInfo = getScoreInfo(score);
      ctx.font = 'bold 13px -apple-system, Arial, sans-serif';
      ctx.fillStyle = scoreInfo.color;
      ctx.fillText(score, x, y + 18);
    });
  },

  renderSheetScores() {
    const html = ATTRIBUTES.map(attr => {
      const score = this.getMainScore(attr.key);
      const info = getScoreInfo(score);
      const pct = ((score - 1) / 19) * 100;

      const subBars = attr.subScores.map(sub => {
        const subVal = state.subScores[sub.key] || 10;
        const subInfo = getScoreInfo(subVal);
        const subPct = ((subVal - 1) / 19) * 100;
        return `
          <div class="sub-score-bar-item">
            <div class="sub-score-bar-name">${sub.name}</div>
            <div class="sub-score-bar-value" style="color: ${subInfo.color}">${subVal}</div>
            <div class="sub-bar-track">
              <div class="sub-bar-fill" style="width: ${subPct}%; background: ${subInfo.color}"></div>
            </div>
          </div>
        `;
      }).join('');

      return `
        <div class="score-item" onclick="this.classList.toggle('expanded')">
          <div class="score-item-summary">
            <div class="score-item-name">${attr.name}</div>
            <div class="score-item-value" style="color: ${info.color}">${score}</div>
            <div class="spectrum-bar">
              <div class="spectrum-marker" style="left: ${pct}%; background: ${info.color}"></div>
            </div>
          </div>
          <div class="score-item-expand-hint">tap to expand</div>
          <div class="score-item-detail">
            <div class="score-item-detail-inner">
              <div class="score-item-detail-desc">${attr.description}</div>
              <div class="score-item-detail-prompt">${attr.prompt}</div>
              ${subBars}
            </div>
          </div>
        </div>
      `;
    }).join('');

    document.getElementById('scores-grid').innerHTML = html;
  },

  renderSheetPersonality() {
    const scores = this.calculateBFIScores();
    const traits = ['openness', 'conscientiousness', 'extraversion', 'agreeableness', 'neuroticism'];

    let html = `
      <div class="personality-section-title">Personality</div>
      <div class="personality-section-subtitle">How you tend to move through the world — tendencies, not achievements</div>
    `;

    html += traits.map(trait => {
      const score = scores[trait]; // 1-5 scale
      const pct = ((score - 1) / 4) * 100;
      const info = TRAIT_INFO[trait];

      let level, levelColor;
      if (score <= 2) { level = 'Low'; levelColor = 'var(--color-struggling)'; }
      else if (score <= 3.5) { level = 'Moderate'; levelColor = 'var(--color-average)'; }
      else { level = 'High'; levelColor = 'var(--color-strong)'; }

      const interpretation = score <= 2.5 ? info.low : score >= 3.5 ? info.high : `Between: ${info.low.toLowerCase()} and ${info.high.toLowerCase()}`;

      return `
        <div class="big-five-item">
          <div class="big-five-header">
            <div class="big-five-name">${info.name}</div>
            <div class="big-five-level" style="color: ${levelColor}">${level} (${score.toFixed(1)})</div>
          </div>
          <div class="big-five-desc">${info.desc}</div>
          <div class="big-five-bar-track">
            <div class="big-five-bar-fill" style="width: ${pct}%; background: ${levelColor}"></div>
          </div>
          <div style="font-family: var(--font-sans); font-size: 11px; color: var(--light-gray); margin-top: 6px; font-style: italic;">${interpretation}</div>
        </div>
      `;
    }).join('');

    document.getElementById('personality-section-container').innerHTML = html;
  },

  renderSheetAbilities() {
    const valid = state.abilities.filter(a => a.name.trim());
    const container = document.getElementById('sheet-abilities-container');

    if (valid.length === 0) {
      container.style.display = 'none';
      return;
    }

    container.style.display = 'block';
    const html = valid.map(ab => {
      const linked = ATTRIBUTES.find(a => a.key === ab.linked)?.name || '—';
      const info = getScoreInfo(ab.score);
      return `
        <div class="ability-row">
          <div class="ability-row-name">${escapeHtml(ab.name)}</div>
          <div class="ability-row-score" style="color: ${info.color}">${ab.score}</div>
          <div class="ability-row-linked">${linked}</div>
          <div class="ability-row-status ${ab.status}">${ab.status === 'active' ? 'Active' : 'Dormant'}</div>
        </div>
      `;
    }).join('');

    document.getElementById('sheet-abilities').innerHTML = html;
  },

  // ==================== STORAGE ====================

  autoSave() {
    clearTimeout(saveTimeout);
    saveTimeout = setTimeout(() => this.save(), 500);
  },

  save() {
    const data = {
      version: 1,
      profile: state.profile,
      scores: state.scores,
      subScores: state.subScores,
      overrides: state.overrides,
      bfiResponses: state.bfiResponses,
      abilities: state.abilities
    };
    try {
      localStorage.setItem('charactersheet-data', JSON.stringify(data));
    } catch (e) {
      if (e.name === 'QuotaExceededError' || e.name === 'NS_ERROR_DOM_QUOTA_REACHED') {
        alert('Storage is full. Your changes could not be saved. Try exporting your data and clearing some browser storage.');
      }
    }
  },

  loadFromStorage() {
    const saved = localStorage.getItem('charactersheet-data');
    if (!saved) return;

    let data;
    try {
      data = JSON.parse(saved);
    } catch (e) {
      localStorage.removeItem('charactersheet-data');
      this.initializeNewSheet();
      return;
    }

    state.profile = data.profile || { name: 'Character', age: '', gender: '', photo: null };
    state.scores = data.scores || {};
    state.subScores = data.subScores || {};
    state.overrides = data.overrides || {};
    state.bfiResponses = data.bfiResponses || {};
    state.abilities = data.abilities || [];

    ATTRIBUTES.forEach(attr => {
      if (!state.scores[attr.key]) state.scores[attr.key] = 10;
      if (!state.overrides[attr.key]) state.overrides[attr.key] = false;
      attr.subScores.forEach(sub => {
        if (!state.subScores[sub.key]) state.subScores[sub.key] = 10;
      });
    });

    BFI_ITEMS.forEach((item, i) => {
      if (!state.bfiResponses[i]) state.bfiResponses[i] = 3;
    });
  },

  exportData() {
    const data = {
      version: 1,
      profile: state.profile,
      scores: state.scores,
      subScores: state.subScores,
      overrides: state.overrides,
      bfiResponses: state.bfiResponses,
      abilities: state.abilities.filter(a => a.name.trim())
    };

    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    const safeName = state.profile.name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '') || 'character';
    a.download = `character-sheet-${safeName}-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
  },

  importData() {
    document.getElementById('import-input').click();
  },

  handleImport(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = JSON.parse(e.target.result);
        state.profile = data.profile || { name: 'Character', age: '', gender: '', photo: null };
        state.scores = data.scores || {};
        state.subScores = data.subScores || {};
        state.overrides = data.overrides || {};
        state.bfiResponses = data.bfiResponses || {};
        state.abilities = data.abilities || [];

        ATTRIBUTES.forEach(attr => {
          if (!state.scores[attr.key]) state.scores[attr.key] = 10;
          if (!state.overrides[attr.key]) state.overrides[attr.key] = false;
          attr.subScores.forEach(sub => {
            if (!state.subScores[sub.key]) state.subScores[sub.key] = 10;
          });
        });

        BFI_ITEMS.forEach((item, i) => {
          if (!state.bfiResponses[i]) state.bfiResponses[i] = 3;
        });

        this.save();
        this.showSheet();
      } catch (err) {
        alert('Could not read file. Please select a valid Character Sheet JSON file.');
      }
    };
    reader.readAsText(file);
    event.target.value = '';
  },

  resetSheet() {
    if (confirm('Reset all data? This cannot be undone.')) {
      localStorage.removeItem('charactersheet-data');
      location.reload();
    }
  }
};

// Initialize
window.addEventListener('load', () => app.init());
</script>

</body>
</html>
